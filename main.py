import telebot
from telebot import types
import sqlite3
import random
import string
import threading
import time
import re
from collections import defaultdict
from datetime import datetime, timedelta
import uuid
import math
import requests
import os

# ØªÙˆÚ©Ù† Ø±Ø¨Ø§Øª
TOKEN = '7255407869:AAFPh33cnOEaCLPuoAqPk-5rwZ5ROhpinuM'
bot = telebot.TeleBot(TOKEN)

# Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³
conn = sqlite3.connect('chatbot.db', check_same_thread=False)
cursor = conn.cursor()

# Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
DEFAULT_PROFILE_PHOTO = 'AgACAgQAAxkBAAIB-miNPoj2J9fsD0j1BYPKCXK7RLopAAJwyDEbghBpUHUt7K43mxe5AQADAgADeAADNgQ'

# Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯ÙˆÙ„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† (Ø¨Ø¯ÙˆÙ† Ù…Ù‚Ø¯Ø§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¨Ø±Ø§ÛŒ profile_photo)
# Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø³ØªÙˆÙ† last_online Ø¨Ù‡ Ø¬Ø¯ÙˆÙ„ users
# Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯ÙˆÙ„ users
cursor.execute('''
        CREATE TABLE IF NOT EXISTS users (
            user_id INTEGER PRIMARY KEY,
            name TEXT,
            gender TEXT,
            followers_count INTEGER DEFAULT 0,
            following_count INTEGER DEFAULT 0,
            province TEXT,
            city TEXT,
            age INTEGER,
            likes_count INTEGER DEFAULT 0,
            chat_id INTEGER,
            unique_id TEXT,
            status TEXT DEFAULT 'idle',
            partner_id INTEGER,
            profile_photo TEXT,
            coins INTEGER DEFAULT 10,
            private_chat_enabled INTEGER DEFAULT 0,
            latitude REAL,
            longitude REAL,
            last_online DATETIME
        )
    ''')

# Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯ÙˆÙ„ block
cursor.execute('''
        CREATE TABLE IF NOT EXISTS block (
            blocker_id INTEGER,
            blocked_id INTEGER,
            PRIMARY KEY (blocker_id, blocked_id)
        )
    ''')
conn.commit()
cursor.close()

cursor = conn.cursor()
# Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯ÙˆÙ„ referrals Ø§Ú¯Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù‡
cursor.execute('''
    CREATE TABLE IF NOT EXISTS referrals (
        user_id INTEGER PRIMARY KEY,
        referral_code TEXT UNIQUE,
        referral_count INTEGER DEFAULT 0,
        FOREIGN KEY (user_id) REFERENCES users(user_id)
    )
''')
conn.commit()

cursor.execute('''
    CREATE TABLE IF NOT EXISTS payments (
        payment_id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER,
        amount INTEGER,
        coins INTEGER,
        authority TEXT,
        status TEXT DEFAULT 'pending',
        created_at DATETIME,
        FOREIGN KEY (user_id) REFERENCES users(user_id)
    )
''')
conn.commit()


# ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ø¯ÛŒØª Ø²Ù…Ø§Ù† Ø¢Ø®Ø±ÛŒÙ† ÙØ¹Ø§Ù„ÛŒØª
def update_last_online(user_id):
    cursor = conn.cursor()
    cursor.execute("UPDATE users SET last_online = ? WHERE user_id = ?",
                   (datetime.now().strftime('%Y-%m-%d %H:%M:%S'), user_id))
    conn.commit()
    cursor.close()


# ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ ÙØ±Ù…Øª Ú©Ø±Ø¯Ù† Ø²Ù…Ø§Ù† Ø¢Ø®Ø±ÛŒÙ† ÙØ¹Ø§Ù„ÛŒØª
def format_last_online(last_online):
    if not last_online:
        return "Ù‡Ø±Ú¯Ø² Ø¢Ù†Ù„Ø§ÛŒÙ† Ù†Ø¨ÙˆØ¯Ù‡"
    last_online_time = datetime.strptime(last_online, '%Y-%m-%d %H:%M:%S')
    now = datetime.now()
    diff = now - last_online_time
    minutes = diff.total_seconds() / 60
    if minutes < 5:
        return "Ù‡Ù… Ø§Ú©Ù†ÙˆÙ† Ø¢Ù†Ù„Ø§ÛŒÙ†"
    elif minutes < 60:
        return f"{int(minutes)} Ø¯Ù‚ÛŒÙ‚Ù‡ Ù¾ÛŒØ´"
    hours = minutes / 60
    if hours < 24:
        return f"{int(hours)} Ø³Ø§Ø¹Øª Ù¾ÛŒØ´"
    days = hours / 24
    return f"{int(days)} Ø±ÙˆØ² Ù¾ÛŒØ´"


# Ø¢Ù¾Ø¯ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù…ÙˆØ¬ÙˆØ¯ Ú©Ù‡ profile_photo Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø¯Ø§Ø±Ù†
cursor.execute("UPDATE users SET profile_photo = ? WHERE profile_photo IS NULL OR profile_photo = ''",
               (DEFAULT_PROFILE_PHOTO,))
conn.commit()

# Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯ÙˆÙ„ Ù„Ø§ÛŒÚ©â€ŒÙ‡Ø§
cursor.execute('''
CREATE TABLE IF NOT EXISTS likes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    target_id INTEGER,
    UNIQUE(user_id, target_id),
    FOREIGN KEY(user_id) REFERENCES users(user_id),
    FOREIGN KEY(target_id) REFERENCES users(user_id)
)
''')
conn.commit()
# Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯ÙˆÙ„ ØªØ§Ø±ÛŒØ®Ú†Ù‡â€ŒÛŒ Ú†Øªâ€ŒÙ‡Ø§
cursor.execute('''
CREATE TABLE IF NOT EXISTS chat_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    partner_id INTEGER,
    chat_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY(user_id) REFERENCES users(user_id),
    FOREIGN KEY(partner_id) REFERENCES users(user_id)
)
''')
conn.commit()

# Ù„ÛŒØ³Øª Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§ Ùˆ Ø´Ù‡Ø±Ù‡Ø§
provinces = [
    "Ø¢Ø°Ø±Ø¨Ø§ÛŒØ¬Ø§ Ø´Ø±Ù‚ÛŒ", "Ø¢Ø°Ø±Ø¨Ø§ÛŒØ¬Ø§ ØºØ±Ø¨ÛŒ", "Ø§Ø±Ø¯Ø¨ÛŒÙ„", "Ø§ØµÙÙ‡Ø§Ù†", "Ø§Ù„Ø¨Ø±Ø²", "Ø§ÛŒÙ„Ø§Ù…", "Ø¨ÙˆØ´Ù‡Ø±", "ØªÙ‡Ø±Ø§Ù†",
    "Ú†Ù‡Ø§Ø±Ù…Ø­Ø§Ù„ Ùˆ Ø¨Ø®ØªÛŒØ§Ø±ÛŒ", "Ø®Ø±Ø§Ø³Ø§Ù† Ø¬Ù†ÙˆØ¨ÛŒ", "Ø®Ø±Ø§Ø³Ø§Ù† Ø±Ø¶ÙˆÛŒ", "Ø®Ø±Ø§Ø³Ø§Ù† Ø´Ù…Ø§Ù„ÛŒ", "Ø®ÙˆØ²Ø³ØªØ§Ù†", "Ø²Ù†Ø¬Ø§Ù†",
    "Ø³Ù…Ù†Ø§Ù†", "Ø³ÛŒØ³ØªØ§Ù† Ùˆ Ø¨Ù„ÙˆÚ†Ø³ØªØ§Ù†", "ÙØ§Ø±Ø³", "Ù‚Ø²ÙˆÛŒÙ†", "Ù‚Ù…", "Ú©Ø±Ø¯Ø³ØªØ§Ù†", "Ú©Ø±Ù…Ø§Ù†", "Ú©Ø±Ù…Ø§Ù†Ø´Ø§Ù‡",
    "Ú©Ù‡Ú¯ÛŒÙ„ÙˆÛŒÙ‡ Ùˆ Ø¨ÙˆÛŒØ±Ø§Ø­Ù…Ø¯", "Ú¯Ù„Ø³ØªØ§Ù†", "Ú¯ÛŒÙ„Ø§Ù†", "Ù„Ø±Ø³ØªØ§Ù†", "Ù…Ø§Ø²Ù†Ø¯Ø±Ø§Ù†", "Ù…Ø±Ú©Ø²ÛŒ", "Ù‡Ø±Ù…Ø²Ú¯Ø§Ù†", "Ù‡Ù…Ø¯Ø§Ù†", "ÛŒØ²Ø¯"
]

cities_by_province = {
    "Ø¢Ø°Ø±Ø¨Ø§ÛŒØ¬Ø§ Ø´Ø±Ù‚ÛŒ": ["ØªØ¨Ø±ÛŒØ²", "Ù…Ø±Ø§ØºÙ‡", "Ù…Ø±Ù†Ø¯", "Ø§Ù‡Ø±", "Ù…ÛŒØ§Ù†Ù‡", "Ø¨Ù†Ø§Ø¨", "Ø³Ø±Ø§Ø¨", "Ù‡Ø§Ø¯ÛŒØ´Ù‡Ø±", "Ø¬Ù„ÙØ§", "Ú©Ù„ÛŒØ¨Ø±"],
    "Ø¢Ø°Ø±Ø¨Ø§ÛŒØ¬Ø§ ØºØ±Ø¨ÛŒ": ["Ø§Ø±ÙˆÙ…ÛŒÙ‡", "Ø®ÙˆÛŒ", "Ù…Ù‡Ø§Ø¨Ø§Ø¯", "Ù…ÛŒØ§Ù†Ø¯ÙˆØ¢Ø¨", "Ø³Ù„Ù…Ø§Ø³", "Ù†Ù‚Ø¯Ù‡", "Ù¾ÛŒØ±Ø§Ù†Ø´Ù‡Ø±", "Ø´Ø§Ù‡ÛŒÙ† Ø¯Ú˜", "ØªÚ©Ø§Ø¨", "Ù…Ø§Ú©Ùˆ"],
    "Ø§Ø±Ø¯Ø¨ÛŒÙ„": ["Ø§Ø±Ø¯Ø¨ÛŒÙ„", "Ù¾Ø§Ø±Ø³ Ø¢Ø¨Ø§Ø¯", "Ù…Ø´Ú¯ÛŒÙ† Ø´Ù‡Ø±", "Ø®Ù„Ø®Ø§Ù„", "Ú¯Ø±Ù…ÛŒ", "Ø¨ÛŒÙ„Ù‡ Ø³ÙˆØ§Ø±", "Ù†Ù…ÛŒÙ†", "Ù†ÛŒØ±", "Ú©ÙˆØ«Ø±", "Ø³Ø±Ø¹ÛŒÙ†"],
    "Ø§ØµÙÙ‡Ø§Ù†": ["Ø§ØµÙÙ‡Ø§Ù†", "Ú©Ø§Ø´Ø§Ù†", "Ø®Ù…ÛŒÙ†ÛŒ Ø´Ù‡Ø±", "Ù†Ø¬Ù Ø¢Ø¨Ø§Ø¯", "Ø´Ø§Ù‡ÛŒÙ† Ø´Ù‡Ø±", "Ø´Ù‡Ø±Ø¶Ø§", "ÙÙˆÙ„Ø§Ø¯Ø´Ù‡Ø±", "Ø¨Ù‡Ø§Ø±Ø³ØªØ§Ù†", "Ù…Ø¨Ø§Ø±Ú©Ù‡",
               "Ø¢Ø±Ø§Ù† Ùˆ Ø¨ÛŒØ¯Ú¯Ù„"],
    "Ø§Ù„Ø¨Ø±Ø²": ["Ú©Ø±Ø¬", "ÙØ±Ø¯ÛŒØ³", "Ú©Ù…Ø§Ù„ Ø´Ù‡Ø±", "Ù†Ø¸Ø±Ø¢Ø¨Ø§Ø¯", "Ù…Ø­Ù…Ø¯Ø´Ù‡Ø±", "Ù…Ø§Ù‡Ø¯Ø´Øª", "Ù…Ø´Ú©ÛŒÙ† Ø¯Ø´Øª", "Ù‡Ø´ØªÚ¯Ø±Ø¯", "Ú†Ù‡Ø§Ø±Ø¨Ø§Øº",
              "Ø´Ù‡Ø± Ø¬Ø¯ÛŒØ¯ Ù‡Ø´ØªÚ¯Ø±Ø¯"],
    "Ø§ÛŒÙ„Ø§Ù…": ["Ø§ÛŒÙ„Ø§Ù…", "Ø§ÛŒÙˆØ§Ù†", "Ø¯Ù‡Ù„Ø±Ø§Ù†", "Ø¢Ø¨Ø¯Ø§Ù†Ø§Ù†", "Ø¯Ø±Ù‡ Ø´Ù‡Ø±", "Ù…Ù‡Ø±Ø§Ù†", "Ø³Ø±Ø§Ø¨Ù„Ù‡", "Ø§Ø±Ú©ÙˆØ§Ø²", "Ø¢Ø³Ù…Ø§Ù† Ø¢Ø¨Ø§Ø¯", "Ú†ÙˆØ§Ø±"],
    "Ø¨ÙˆØ´Ù‡Ø±": ["Ø¨ÙˆØ´Ù‡Ø±", "Ø¨Ø±Ø§Ø²Ø¬Ø§Ù†", "Ø¨Ù†Ø¯Ø± Ú¯Ù†Ø§ÙˆÙ‡", "Ø¨Ù†Ø¯Ø± Ú©Ù†Ú¯Ø§Ù†", "Ø®ÙˆØ±Ù…ÙˆØ¬", "Ø¬Ù…", "Ø¨Ù†Ø¯Ø± Ø¯ÛŒÙ„Ù…", "Ø¨Ù†Ø¯Ø± Ø¯ÛŒØ±", "Ø¹Ø§Ù„ÛŒ Ø´Ù‡Ø±",
              "Ø¢Ø¨ Ù¾Ø®Ø´"],
    "ØªÙ‡Ø±Ø§Ù†": ["ØªÙ‡Ø±Ø§Ù†", "Ø§Ø³Ù„Ø§Ù…Ø´Ù‡Ø±", "Ø´Ù‡Ø±ÛŒØ§Ø±", "Ù‚Ø¯Ø³", "Ù…Ù„Ø§Ø±Ø¯", "Ú¯Ù„Ø³ØªØ§Ù†", "Ù¾Ø§Ú©Ø¯Ø´Øª", "Ø±ÛŒ", "Ù‚Ø±Ú†Ú©", "ÙˆØ±Ø§Ù…ÛŒÙ†"],
    "Ú†Ù‡Ø§Ø±Ù…Ø­Ø§Ù„ Ùˆ Ø¨Ø®ØªÛŒØ§Ø±ÛŒ": ["Ø´Ù‡Ø±Ú©Ø±Ø¯", "Ø¨Ø±ÙˆØ¬Ù†", "Ù„Ø±Ø¯Ú¯Ø§Ù†", "ÙØ±Ø®Ø´Ù‡Ø±", "ÙØ§Ø±Ø³Ø§Ù†", "Ù‡ÙØ´Ø¬Ø§Ù†", "Ø¬ÙˆÙ†Ù‚Ø§Ù†", "Ø³Ø§Ù…Ø§Ù†", "ÙØ±Ø§Ø¯Ù†Ø¨Ù‡",
                           "Ø¨Ù†"],
    "Ø®Ø±Ø§Ø³Ø§Ù† Ø¬Ù†ÙˆØ¨ÛŒ": ["Ø¨ÛŒØ±Ø¬Ù†Ø¯", "Ù‚Ø§Ø¦Ù†", "Ø·Ø¨Ø³", "ÙØ±Ø¯ÙˆØ³", "Ù†Ù‡Ø¨Ù†Ø¯Ø§Ù†", "Ø³Ø±Ø§ÛŒØ§Ù†", "Ø¨Ø´Ø±ÙˆÛŒÙ‡", "Ø³Ø± Ø¨ÛŒØ´Ù‡", "Ø®ÙˆØ³Ù", "Ø¯Ø±Ù…ÛŒØ§Ù†"],
    "Ø®Ø±Ø§Ø³Ø§Ù† Ø±Ø¶ÙˆÛŒ": ["Ù…Ø´Ù‡Ø¯", "Ù†ÛŒØ´Ø§Ø¨ÙˆØ±", "Ø³Ø¨Ø²ÙˆØ§Ø±", "ØªØ±Ø¨Øª Ø­ÛŒØ¯Ø±ÛŒÙ‡", "Ú©Ø§Ø´Ù…Ø±", "Ù‚ÙˆÚ†Ø§Ù†", "ØªØ±Ø¨Øª Ø¬Ø§Ù…", "ØªØ§ÛŒØ¨Ø§Ø¯", "Ú†Ù†Ø§Ø±Ø§Ù†",
                    "Ø³Ø±Ø®Ø³"],
    "Ø®Ø±Ø§Ø³Ø§Ù† Ø´Ù…Ø§Ù„ÛŒ": ["Ø¨Ø¬Ù†ÙˆØ±Ø¯", "Ø´ÛŒØ±ÙˆØ§Ù†", "Ø§Ø³ÙØ±Ø§ÛŒÙ†", "Ø¢Ø´Ø®Ø§Ù†Ù‡", "Ø¬Ø§Ø¬Ø±Ù…", "ÙØ§Ø±ÙˆØ¬", "Ú¯Ø±Ù…Ù‡", "Ø±Ø§Ø²", "Ù¾ÛŒØ´ Ù‚Ù„Ø¹Ù‡", "ØµÙÛŒ Ø¢Ø¨Ø§Ø¯"],
    "Ø®ÙˆØ²Ø³ØªØ§Ù†": ["Ø§Ù‡ÙˆØ§Ø²", "Ø¯Ø²ÙÙˆÙ„", "Ø¢Ø¨Ø§Ø¯Ø§Ù†", "Ø®Ø±Ù…Ø´Ù‡Ø±", "Ø§Ù†Ø¯ÛŒÙ…Ø´Ú©", "Ø¨Ù‡Ø¨Ù‡Ø§Ù†", "Ù…Ø§Ù‡Ø´Ù‡Ø±", "Ø´ÙˆØ´ØªØ±", "Ø§ÛŒØ°Ù‡", "Ø´ÙˆØ´"],
    "Ø²Ù†Ø¬Ø§Ù†": ["Ø²Ù†Ø¬Ø§Ù†", "Ø§Ø¨Ù‡Ø±", "Ø®Ø¯Ø§Ø¨Ù†Ø¯Ù‡", "Ø·Ø§Ø±Ù…", "Ø®Ø±Ù…Ø¯Ø±Ù‡", "Ø³Ù„Ø·Ø§Ù†ÛŒÙ‡", "Ù‡ÛŒØ¯Ø¬", "ØµØ§Ø¦ÛŒÙ† Ù‚Ù„Ø¹Ù‡", "Ø²Ø±ÛŒÙ† Ø¢Ø¨Ø§Ø¯", "Ú†ÙˆØ±Ø²Ù‚"],
    "Ø³Ù…Ù†Ø§Ù†": ["Ø³Ù…Ù†Ø§Ù†", "Ø´Ø§Ù‡Ø±ÙˆØ¯", "Ø¯Ø§Ù…ØºØ§Ù†", "Ú¯Ø±Ù…Ø³Ø§Ø±", "Ù…Ù‡Ø¯ÛŒ Ø´Ù‡Ø±", "Ø³Ø±Ø®Ù‡", "Ø§ÛŒÙˆØ§Ù†Ú©ÛŒ", "Ø¢Ø±Ø§Ø¯Ø§Ù†", "Ø¨Ø³Ø·Ø§Ù…", "Ø¨ÛŒØ§Ø±Ø¬Ù…Ù†Ø¯"],
    "Ø³ÛŒØ³ØªØ§Ù† Ùˆ Ø¨Ù„ÙˆÚ†Ø³ØªØ§Ù†": ["Ø²Ø§Ù‡Ø¯Ø§Ù†", "Ø²Ø§Ø¨Ù„", "Ø§ÛŒØ±Ø§Ù†Ø´Ù‡Ø±", "Ú†Ø§Ø¨Ù‡Ø§Ø±", "Ø³Ø±Ø§ÙˆØ§Ù†", "Ø®Ø§Ø´", "Ú©Ù†Ø§Ø±Ú©", "Ù†ÛŒÚ© Ø´Ù‡Ø±", "Ø±Ø§Ø³Ú©",
                          "Ù…ÛŒØ±Ø¬Ø§ÙˆÙ‡"],
    "ÙØ§Ø±Ø³": ["Ø´ÛŒØ±Ø§Ø²", "Ù…Ø±ÙˆØ¯Ø´Øª", "Ø¬Ù‡Ø±Ù…", "ÙØ³Ø§", "Ú©Ø§Ø²Ø±ÙˆÙ†", "ØµØ¯Ø±Ø§", "Ø¯Ø§Ø±Ø§Ø¨", "ÙÛŒØ±ÙˆØ²Ø¢Ø¨Ø§Ø¯", "Ù„Ø§Ø±", "Ø¢Ø¨Ø§Ø¯Ù‡"],
    "Ù‚Ø²ÙˆÛŒÙ†": ["Ù‚Ø²ÙˆÛŒÙ†", "ØªØ§Ú©Ø³ØªØ§Ù†", "Ø§Ù„ÙˆÙ†Ø¯", "Ø¨ÙˆÛŒÛŒÙ† Ø²Ù‡Ø±Ø§", "Ø¢Ø¨ÛŒÚ©", "Ù…Ø­Ù…ÙˆØ¯Ø¢Ø¨Ø§Ø¯ Ù†Ù…ÙˆÙ†Ù‡", "Ù…Ø­Ù…Ø¯ÛŒÙ‡", "Ø¨ÛŒØ¯Ø³ØªØ§Ù†", "Ø´Ø§Ù„",
              "Ø¯Ø§Ù†Ø³ÙÙ‡Ø§Ù†"],
    "Ù‚Ù…": ["Ù‚Ù…", "Ù‚Ù†ÙˆØ§Øª", "Ø¬Ø¹ÙØ±ÛŒÙ‡", "Ú©Ù‡Ú©", "Ø¯Ø³ØªØ¬Ø±Ø¯", "Ø³Ù„ÙÚ†Ú¯Ø§Ù†"],
    "Ú©Ø±Ø¯Ø³ØªØ§Ù†": ["Ø³Ù†Ù†Ø¯Ø¬", "Ø³Ù‚Ø²", "Ù…Ø±ÛŒÙˆØ§Ù†", "Ø¨Ø§Ù†Ù‡", "Ù‚Ø±ÙˆÙ‡", "Ú©Ø§Ù…ÛŒØ§Ø±Ø§Ù†", "Ø¨ÛŒØ¬Ø§Ø±", "Ø¯ÛŒÙˆØ§Ù†Ø¯Ø±Ù‡", "Ø¯Ù‡Ú¯Ù„Ø§Ù†", "Ø³Ø±ÛŒØ´ Ø¢Ø¨Ø§Ø¯"],
    "Ú©Ø±Ù…Ø§Ù†": ["Ú©Ø±Ù…Ø§Ù†", "Ø³ÛŒØ±Ø¬Ø§Ù†", "Ø±ÙØ³Ù†Ø¬Ø§Ù†", "Ø¬ÛŒØ±ÙØª", "Ø¨Ù…", "Ø²Ø±Ù†Ø¯", "Ú©Ù‡Ù†ÙˆØ¬", "Ø´Ù‡Ø± Ø¨Ø§Ø¨Ú©", "Ø¨Ø§ÙØª", "Ø¨Ø±Ø¯Ø³ÛŒØ±"],
    "Ú©Ø±Ù…Ø§Ù†Ø´Ø§Ù‡": ["Ú©Ø±Ù…Ø§Ù†Ø´Ø§Ù‡", "Ø§Ø³Ù„Ø§Ù… Ø¢Ø¨Ø§Ø¯ ØºØ±Ø¨", "Ø¬ÙˆØ§Ù†Ø±ÙˆØ¯", "Ú©Ù†Ú¯Ø§ÙˆØ±", "Ù‡Ø±Ø³ÛŒÙ†", "Ø³Ø±Ù¾Ù„ Ø°Ù‡Ø§Ø¨", "Ø³Ù†Ù‚Ø±", "ØµØ­Ù†Ù‡", "Ú¯ÛŒÙ„Ø§Ù† ØºØ±Ø¨",
                 "Ù¾Ø§ÙˆÙ‡"],
    "Ú©Ù‡Ú¯ÛŒÙ„ÙˆÛŒÙ‡ Ùˆ Ø¨ÙˆÛŒØ±Ø§Ø­Ù…Ø¯": ["ÛŒØ§Ø³ÙˆØ¬", "Ø¯ÙˆÚ¯Ù†Ø¨Ø¯Ø§Ù†", "Ø³ÛŒ Ø³Ø®Øª", "Ø¯Ù‡Ø¯Ø´Øª", "Ù„ÛŒÚ©Ú©", "Ú†Ø±Ø§Ù…", "Ø¨Ø§Ø´Øª", "Ù…Ø§Ø¯ÙˆØ§Ù†", "Ù¾Ø§ØªØ§ÙˆÙ‡",
                            "Ù…Ø§Ø±Ú¯ÙˆÙ†"],
    "Ú¯Ù„Ø³ØªØ§Ù†": ["Ú¯Ø±Ú¯Ø§Ù†", "Ú¯Ù†Ø¨Ø¯ Ú©Ø§ÙˆÙˆØ³", "Ø¹Ù„ÛŒ Ø¢Ø¨Ø§Ø¯ Ú©ØªÙˆÙ„", "Ø¨Ù†Ø¯Ø± ØªØ±Ú©Ù…Ù†", "Ø¢Ø²Ø§Ø¯Ø´Ù‡Ø±", "Ú©Ø±Ø¯Ú©ÙˆÛŒ", "Ú©Ù„Ø§Ù„Ù‡", "Ø¢Ù‚ Ù‚Ù„Ø§", "Ù…ÛŒÙ†ÙˆØ¯Ø´Øª",
               "Ú¯Ø§Ù„ÛŒÚ©Ø´"],
    "Ú¯ÛŒÙ„Ø§Ù†": ["Ø±Ø´Øª", "Ø¨Ù†Ø¯Ø± Ø§Ù†Ø²Ù„ÛŒ", "Ù„Ø§Ù‡ÛŒØ¬Ø§Ù†", "Ù„Ù†Ú¯Ø±ÙˆØ¯", "Ù‡Ø´ØªÙ¾Ø±", "Ø¢Ø³ØªØ§Ø±Ø§", "ØµÙˆÙ…Ø¹Ù‡ Ø³Ø±Ø§", "Ø¢Ø³ØªØ§Ù†Ù‡ Ø§Ø´Ø±ÙÛŒÙ‡", "Ø±ÙˆØ¯Ø³Ø±",
              "ÙÙˆÙ…Ù†"],
    "Ù„Ø±Ø³ØªØ§Ù†": ["Ø®Ø±Ù… Ø¢Ø¨Ø§Ø¯", "Ø¨Ø±ÙˆØ¬Ø±Ø¯", "Ø¯ÙˆØ±ÙˆØ¯", "Ø§Ù„ÛŒÚ¯ÙˆØ¯Ø±Ø²", "Ú©ÙˆÙ‡Ø¯Ø´Øª", "Ù†ÙˆØ±Ø¢Ø¨Ø§Ø¯", "Ø§Ø²Ù†Ø§", "Ø§Ù„Ø´ØªØ±", "Ù¾Ù„Ø¯Ø®ØªØ±", "Ø³Ù¾ÛŒØ¯Ø¯Ø´Øª"],
    "Ù…Ø§Ø²Ù†Ø¯Ø±Ø§Ù†": ["Ø³Ø§Ø±ÛŒ", "Ø¨Ø§Ø¨Ù„", "Ø¢Ù…Ù„", "Ù‚Ø§Ø¦Ù… Ø´Ù‡Ø±", "Ø¨Ù‡Ø´Ù‡Ø±", "Ú†Ø§Ù„ÙˆØ³", "Ù†ÙˆØ´Ù‡Ø±", "ØªÙ†Ú©Ø§Ø¨Ù†", "Ø±Ø§Ù…Ø³Ø±", "Ù…Ø­Ù…ÙˆØ¯Ø¢Ø¨Ø§Ø¯"],
    "Ù…Ø±Ú©Ø²ÛŒ": ["Ø§Ø±Ø§Ú©", "Ø³Ø§ÙˆÙ‡", "Ø®Ù…ÛŒÙ†", "Ù…Ø­Ù„Ø§Øª", "Ø¯Ù„ÛŒØ¬Ø§Ù†", "Ø²Ø±Ù†Ø¯ÛŒÙ‡", "Ø´Ø§Ø²Ù†Ø¯", "Ø¢Ø´ØªÛŒØ§Ù†", "ØªÙØ±Ø´", "Ú©Ù…ÛŒØ¬Ø§Ù†"],
    "Ù‡Ø±Ù…Ø²Ú¯Ø§Ù†": ["Ø¨Ù†Ø¯Ø±Ø¹Ø¨Ø§Ø³", "Ù…ÛŒÙ†Ø§Ø¨", "Ù‚Ø´Ù…", "Ú©ÛŒØ´", "Ø±ÙˆØ¯Ø§Ù†", "Ø¨Ù†Ø¯Ø± Ù„Ù†Ú¯Ù‡", "Ø­Ø§Ø¬ÛŒ Ø¢Ø¨Ø§Ø¯", "Ú©Ù†Ú¯", "Ù¾Ø§Ø±Ø³ÛŒØ§Ù†", "Ø¬Ø§Ø³Ú©"],
    "Ù‡Ù…Ø¯Ø§Ù†": ["Ù‡Ù…Ø¯Ø§Ù†", "Ù…Ù„Ø§ÛŒØ±", "Ù†Ù‡Ø§ÙˆÙ†Ø¯", "Ø§Ø³Ø¯Ø¢Ø¨Ø§Ø¯", "ØªÙˆÛŒØ³Ø±Ú©Ø§Ù†", "Ø¨Ù‡Ø§Ø±", "Ú©Ø¨ÙˆØ¯Ø±Ø§Ù‡Ù†Ú¯", "Ù„Ø§Ù„Ø¬ÛŒÙ†", "Ø±Ø²Ù†", "ÙØ§Ù…Ù†ÛŒÙ†"],
    "ÛŒØ²Ø¯": ["ÛŒØ²Ø¯", "Ù…ÛŒØ¨Ø¯", "Ø§Ø±Ø¯Ú©Ø§Ù†", "Ø­Ù…ÛŒØ¯ÛŒØ§", "Ù…Ù‡Ø±ÛŒØ²", "Ø¨Ø§ÙÙ‚", "ØªÙØª", "Ø§Ø¨Ø±Ú©ÙˆÙ‡", "Ø²Ø§Ø±Ú†", "Ø§Ø´Ú©Ø°Ø±"]
}

# Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ
main_markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
main_markup.add("ğŸ”—Ø¨Ù‡ ÛŒÙ‡ Ù†Ø§Ø´Ù†Ø§Ø³ ÙˆØµÙ„Ù… Ú©Ù†!")
main_markup.row("ğŸ—¨ Ø¬Ø³ØªØ¬ÙˆÛŒ ÙˆÛŒÚ˜Ù‡â€Œ ğŸ—¨", "ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ğŸ”")
main_markup.row("ğŸ‘¤ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ù†", "ğŸ’° Ø§ÙØ²Ø§ÛŒØ´ Ø³Ú©Ù‡", "ğŸ“„ Ø±Ø§Ù‡Ù†Ù…Ø§")
main_markup.add("âš ï¸Ø¯Ø¹ÙˆØª Ø¯ÙˆØ³ØªØ§Ù† (Ø³Ú©Ù‡ Ø±Ø§ÛŒÚ¯Ø§Ù†)")
main_markup.add("ğŸ“«Ù„ÛŒÙ†Ú© Ù†Ø§Ø´Ù†Ø§Ø³ Ù…Ù†")


# ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ ÛŒØ§ Ú¯Ø±ÙØªÙ† Ú©Ø¯ Ø§Ø±Ø¬Ø§Ø¹
def get_referral_code(user_id):
    cursor.execute("SELECT referral_code FROM referrals WHERE user_id = ?", (user_id,))
    result = cursor.fetchone()
    if result:
        return result[0]
    else:
        # ØªÙˆÙ„ÛŒØ¯ Ú©Ø¯ Ø§Ø±Ø¬Ø§Ø¹ Ù…Ù†Ø­ØµØ±Ø¨Ù‡â€ŒÙØ±Ø¯ (ÙÙ‚Ø· Ø­Ø±ÙˆÙ Ùˆ Ø§Ø¹Ø¯Ø§Ø¯)
        referral_code = str(uuid.uuid4()).replace('-', '')[:12]
        cursor.execute(
            "INSERT INTO referrals (user_id, referral_code, referral_count) VALUES (?, ?, 0)",
            (user_id, referral_code)
        )
        conn.commit()
        return referral_code


# ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ú¯Ø±ÙØªÙ† ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø¹ÙˆØªâ€ŒÙ‡Ø§
def get_referral_count(user_id):
    cursor.execute("SELECT referral_count FROM referrals WHERE user_id = ?", (user_id,))
    result = cursor.fetchone()
    return result[0] if result else 0


# ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ø¯ÛŒØª Ø³Ú©Ù‡â€ŒÙ‡Ø§ Ùˆ ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø¹ÙˆØªâ€ŒÙ‡Ø§
def add_referral(user_id, referred_user_id):
    # Ú†Ú© Ú©Ø±Ø¯Ù† Ø§ÛŒÙ†Ú©Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ù‚Ø¨Ù„Ø§Ù‹ Ø¯Ø¹ÙˆØª Ù†Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ù‡
    cursor.execute("SELECT user_id FROM referrals WHERE user_id = ?", (referred_user_id,))
    if cursor.fetchone():
        return False  # Ú©Ø§Ø±Ø¨Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ø¯Ø¹ÙˆØª Ø´Ø¯Ù‡

    # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† 20 Ø³Ú©Ù‡ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø¹ÙˆØªâ€ŒÚ©Ù†Ù†Ø¯Ù‡
    cursor.execute("UPDATE users SET coins = coins + 20 WHERE user_id = ?", (user_id,))
    # Ø¢Ù¾Ø¯ÛŒØª ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø¹ÙˆØªâ€ŒÙ‡Ø§
    cursor.execute("UPDATE referrals SET referral_count = referral_count + 1 WHERE user_id = ?", (user_id,))
    conn.commit()
    return True


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ "ğŸ“„ Ø±Ø§Ù‡Ù†Ù…Ø§"
@bot.message_handler(func=lambda message: message.text == "ğŸ“„ Ø±Ø§Ù‡Ù†Ù…Ø§")
def show_help(message):
    user_id = message.from_user.id
    help_text = """
ğŸ”¹Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±Ø¨Ø§Øª:

Ù…Ù† Ø§ÛŒÙ†Ø¬Ø§Ù… Ú©Ù‡ Ú©Ù…Ú©Øª Ú©Ù†Ù…! Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ Ø¯Ø± Ù…ÙˆØ±Ø¯ Ù‡Ø± Ù…ÙˆØ¶ÙˆØ¹ØŒ Ú©Ø§ÙÛŒÙ‡ Ø¯Ø³ØªÙˆØ± Ø¢Ø¨ÛŒ Ø±Ù†Ú¯ÛŒ Ú©Ù‡ Ù…Ù‚Ø§Ø¨Ù„ Ø§ÙˆÙ† Ø³ÙˆØ§Ù„ Ù‡Ø³Øª Ø±Ùˆ Ù„Ù…Ø³ Ú©Ù†ÛŒ:

â‰ï¸ Ú†Ú¯ÙˆÙ†Ù‡ Ø¨ØµÙˆØ±Øª Ù†Ø§Ø´Ù†Ø§Ø³ Ú†Øª Ú©Ù†Ù…ØŸ /help_chat
â‰ï¸ Ø³Ú©Ù‡ ÛŒØ§ Ø§Ù…ØªÛŒØ§Ø² Ú†ÛŒØ³ØªØŸ /help_seke
â‰ï¸ Ú†Ú¯ÙˆÙ†Ù‡ Ø§ÙØ±Ø§Ø¯ Ù†Ø²Ø¯ÛŒÚ©Ù…Ùˆ Ù¾ÛŒØ¯Ø§ Ú©Ù†Ù…ØŸ /help_gps
â‰ï¸ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú†ÛŒØ³ØªØŸ /help_profile
â‰ï¸ Ú†Ú¯ÙˆÙ†Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú†Øª Ø¨ÙØ±Ø³ØªÙ…ØŸ /help_sendchat
â‰ï¸ Ù¾ÛŒØ§Ù… Ø¯Ø§ÛŒØ±Ú©Øª Ú†ÛŒØ³ØªØŸ /help_direct
â‰ï¸ Ø§Ø·Ù„Ø§Ø¹ Ø±Ø³Ø§Ù†ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ† Ø´Ø¯Ù† Ù…Ø®Ø§Ø·Ø¨ /help_onw
â‰ï¸ Ø§Ø·Ù„Ø§Ø¹ Ø±Ø³Ø§Ù†ÛŒ Ø§ØªÙ…Ø§Ù… Ú†Øª Ù…Ø®Ø§Ø·Ø¨ /help_chw
â‰ï¸ Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø±Ø¯Ù† Ú†ÛŒØ³Øª ØŸ /help_contacts
â‰ï¸ Ø¢Ù…ÙˆØ²Ø´ Ø­Ø°Ù Ù¾ÛŒØ§Ù… Ø¯Ø± Ú†Øª /help_deleteMessage
â‰ï¸ Ø¢Ù…ÙˆØ²Ø´ Ø­Ø°Ù Ø§Ú©Ø§Ù†Øª Ø¯Ø± Ø±Ø¨Ø§Øª /help_deleteAccount
âš–ï¸ Ù‚ÙˆØ§Ù†ÛŒÙ† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±Ø¨Ø§Øª /rules
ğŸ‘¨â€ğŸ’» Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø±Ø¨Ø§Øª:
@chatoogram100
"""
    bot.send_message(user_id, help_text, reply_markup=main_markup)


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ /help_chat
@bot.message_handler(commands=['help_chat'])
def help_chat(message):
    user_id = message.from_user.id
    help_chat_text = """
ğŸ”¹ Ú†Ú¯ÙˆÙ†Ù‡ Ø¨ØµÙˆØ±Øª Ù†Ø§Ø´Ù†Ø§Ø³ Ú†Øª Ú©Ù†Ù…ØŸ

ÙÙ‚Ø· Ú©Ø§ÙÛŒÙ‡ ØªÙˆ Ù…Ù†ÙˆÛŒ Ø±Ø¨Ø§Øª <<ğŸ”— Ø¨Ù‡ ÛŒÙ‡ Ù†Ø§Ø´Ù†Ø§Ø³ ÙˆØµÙ„Ù… Ú©Ù†!>> Ø±Ùˆ Ø¨Ø²Ù†ÛŒ Ùˆ ÛŒÚ©ÛŒ Ø§Ø² Ú¯Ø²ÛŒÙ†Ù‡ Ù‡Ø§Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒ :

ğŸ² Ø¬Ø³ØªØ¬ÙˆÛŒ Ø´Ø§Ù†Ø³ÛŒ
- Ø¨ØµÙˆØ±Øª ØªØµØ§Ø¯ÙÛŒ Ø¨Ù‡ ÛŒÚ© Ù†ÙØ± ÙˆØµÙ„ Ù…ÛŒØ´ÛŒ (Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø³Ú©Ù‡ğŸ’°)

ğŸ›° Ø¬Ø³ØªØ¬ÙˆÛŒ Ø§Ø·Ø±Ø§Ù
 - Ø¨ØµÙˆØ±Øª ØªØµØ§Ø¯ÙÛŒ Ø¨Ù‡ ÛŒÚ© Ø¯Ø®ØªØ± ÛŒØ§ Ù¾Ø³Ø± Ú©Ù‡ Ù†Ø²Ø¯ÛŒÚ©ØªÙ‡ ÙˆØµÙ„ Ù…ÛŒØ´ÛŒ (2 Ø³Ú©Ù‡ ğŸ’°)

ğŸ™â€â™‚ï¸Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾Ø³Ø±
 - Ø¨ØµÙˆØ±Øª ØªØµØ§Ø¯ÙÛŒ Ø¨Ù‡ ÛŒÚ© Ù¾Ø³Ø± ÙˆØµÙ„ Ù…ÛŒØ´ÛŒ ( Û² Ø³Ú©Ù‡ğŸ’° )

ğŸ™â€â™€ï¸Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¯Ø®ØªØ±
 - Ø¨ØµÙˆØ±Øª ØªØµØ§Ø¯ÙÛŒ Ø¨Ù‡ ÛŒÚ© Ø¯Ø®ØªØ± ÙˆØµÙ„ Ù…ÛŒØ´ÛŒ ( Û² Ø³Ú©Ù‡ğŸ’° )

âš ï¸ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®ØµÛŒ Ø´Ù…Ø§ Ù…Ø«Ù„ Ù…ÙˆÙ‚Ø¹ÛŒØª GPS ÛŒØ§ Ø§Ø³Ù… Ø´Ù…Ø§ Ø¯Ø± ØªÙ„Ú¯Ø±Ø§Ù… ÛŒØ§ Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ùˆ.. Ú©Ø§Ù…Ù„Ø§Ù‹ Ù…Ø®ÙÛŒ Ù‡Ø³Øª Ùˆ ÙÙ‚Ø· Ø§Ø·Ù„Ø§Ø¹Ø§ØªÛŒ Ú©Ù‡ ØªÙˆ Ø±Ø¨Ø§Øª Ø«Ø¨Øª Ù…ÛŒÚ©Ù†ÛŒØ¯ Ù…Ø§Ù†Ù†Ø¯ Ø´Ù‡Ø± Ùˆ Ø¹Ú©Ø³(ØªÙˆÛŒ Ø±Ø¨Ø§Øª) Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª Ù‚Ø§Ø¨Ù„ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù‡Ø³Øª.

ğŸ”¸ - â€ Ø±Ø§Ù‡Ù†Ù…Ø§ : /help
"""
    bot.send_message(user_id, help_chat_text, reply_markup=main_markup)


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ /help_seke
@bot.message_handler(commands=['help_seke'])
def help_seke(message):
    user_id = message.from_user.id
    help_seke_text = """
ğŸ”¹ Ø³Ú©Ù‡ ÛŒØ§ Ø§Ù…ØªÛŒØ§Ø² Ú†ÛŒØ³ØªØŸ

Ø´Ù…Ø§ Ø¨Ø§ Ø¯Ø§Ø´ØªÙ† Ø³Ú©Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ :

- Ù¾ÛŒØ§Ù… Ø¯Ø§ÛŒØ±Ú©Øª Ø¨ÙØ±Ø³ØªÛŒØ¯ (1Ø³Ú©Ù‡)
- Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú†Øª Ø¨ÙØ±Ø³ØªÛŒØ¯(2Ø³Ú©Ù‡)
- Ø§Ø·Ù„Ø§Ø¹ Ø§Ø² Ø¢Ù†Ù„Ø§ÛŒÙ† Ø¨ÙˆØ¯Ù† (1 Ø³Ú©Ù‡)
- Ø§Ø·Ù„Ø§Ø¹ Ø§Ø² Ø§ØªÙ…Ø§Ù… Ú†Øª Ú©Ø§Ø±Ø¨Ø± (1Ø³Ú©Ù‡ )
- Ø§Ø² Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾Ø³Ø± ÛŒØ§ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¯Ø®ØªØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯(2Ø³Ú©Ù‡)

ğŸ“¢ ØªÙˆØ¬Ù‡ : Ø³Ú©Ù‡ ÙÙ‚Ø· Ø¯Ø± ØµÙˆØ±ØªÛŒ Ú©Ø³Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ú©Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…ÙˆÙÙ‚ Ø¨Ø§Ø´Ø¯ ( Ù…Ø«Ù„Ø§Ù‹ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú†Øª Ø´Ù…Ø§ ØªÙˆØ³Ø· Ú©Ø§Ø±Ø¨Ø± Ù…Ù‚Ø§Ø¨Ù„ Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´ÙˆØ¯ )

â“Ø±ÙˆØ´â€ŒÙ‡Ø§ÛŒ Ø¨Ø¯Ø³Øª Ø¢ÙˆØ±Ø¯Ù† Ø³Ú©Ù‡ Ú†ÛŒØ³ØªØŸ

1ï¸âƒ£ Ù…Ø¹Ø±ÙÛŒ Ø¯ÙˆØ³ØªØ§Ù† (Ø±Ø§ÛŒÚ¯Ø§Ù†) :
Ø¨Ø±Ø§ÛŒ Ø§ÙØ²Ø§ÛŒØ´ Ø³Ú©Ù‡ Ø¨Ù‡ ØµÙˆØ±Øª Ø±Ø§ÛŒÚ¯Ø§Ù† Ø¨Ù†Ø± Ù„ÛŒÙ†Ú©âš¡ï¸ Ù…Ø®ØµÙˆØµ Ø®ÙˆØ¯Øª (/link) Ø±Ùˆ Ø¨Ø±Ø§ÛŒ Ø¯ÙˆØ³ØªØ§Øª Ø¨ÙØ±Ø³Øª Ùˆ 10 Ø³Ú©Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†
- Ø¨Ù‡ Ø§Ø²Ø§ÛŒ Ù‡Ø±Ù†ÙØ±ÛŒ Ú©Ù‡ Ø¨Ø§ Ù„ÛŒÙ†Ú©âš¡ï¸ Ø´Ù…Ø§ ÙˆØ§Ø±Ø¯ Ø±Ø¨Ø§Øª Ù…ÛŒØ´Ù‡ Ø¨Ù‡ Ù…Ø­Ø¶ ÙˆØ±ÙˆØ¯ 10 ØªØ§ Ø³Ú©Ù‡ Ùˆ Ø¨Ø¹Ø¯ Ø§Ø² ØªÚ©Ù…ÛŒÙ„ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ 10 Ø³Ú©Ù‡ Ø¯ÛŒÚ¯Ø± Ø±Ø§ÛŒÚ¯Ø§Ù† Ø¯Ø±ÛŒØ§ÙØª Ù…ÛŒâ€ŒÚ©Ù†ÛŒ ğŸ˜

2ï¸âƒ£ Ø®Ø±ÛŒØ¯ Ø³Ú©Ù‡ Ø¨ØµÙˆØ±Øª Ø¢Ù†Ù„Ø§ÛŒÙ† :
â€Œ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ ã€ŠØ§ÙØ²Ø§ÛŒØ´ Ø³Ú©Ù‡ ğŸ’°ã€‹ Ø±Ùˆ Ù„Ù…Ø³ Ú©Ù†ÛŒ Ùˆ Ø¨ØµÙˆØ±Øª Ø¢Ù†Ù„Ø§ÛŒÙ† Ø³Ú©Ù‡ Ø®Ø±ÛŒØ¯ Ø¨Ú©Ù†ÛŒ

ğŸ”¸ - â€ Ø±Ø§Ù‡Ù†Ù…Ø§ : /help
"""
    bot.send_message(user_id, help_seke_text, reply_markup=main_markup)


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ /help_gps
@bot.message_handler(commands=['help_gps'])
def help_gps(message):
    user_id = message.from_user.id
    help_gps_text = """
ğŸ”¹Ú†Ú¯ÙˆÙ†Ù‡ Ø§ÙØ±Ø§Ø¯ Ù†Ø²Ø¯ÛŒÚ©Ù…Ùˆ Ù¾ÛŒØ¯Ø§ Ú©Ù†Ù…ØŸ

Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù† Ù„ÛŒØ³Øª Ø§ÙØ±Ø§Ø¯ Ù†Ø²Ø¯ÛŒÚ©Øª ÙÙ‚Ø· Ú©Ø§ÙÛŒÙ‡ ã€ŠğŸ“Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø§ÙØ±Ø§Ø¯ Ù†Ø²Ø¯ÛŒÚ© Ø¨Ø§ GPSã€‹ Ø±Ùˆ Ù„Ù…Ø³ Ú©Ù†ÛŒ.

- Ø¬Ø³ØªØ¬ÙˆÛŒ Ø§ÙØ±Ø§Ø¯ Ù†Ø²Ø¯ÛŒÚ© Ú©Ø§Ù…Ù„Ø§Ù‹ Ø±Ø§ÛŒÚ¯Ø§Ù† Ù‡Ø³Øª (Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø³Ú©Ù‡)

Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ø±Ø¯Ù† Ùˆ ÛŒØ§ Ú†Øª Ú©Ø±Ø¯Ù† Ø¨Ø§ Ø§ÙØ±Ø§Ø¯ Ù†Ø²Ø¯ÛŒÚ©Øª Ú©Ø§ÙÛŒÙ‡ ØªÙˆÛŒ Ù„ÛŒØ³Øª Ø±ÙˆÛŒ Ø¢ÛŒØ¯ÛŒ Ø´ÙˆÙ† Ø¨Ø²Ù†ÛŒ ØªØ§ Ù¾Ø±ÙˆÙØ§ÛŒÙ„Ø´ÙˆÙ†Ùˆ Ø¨Ø¨ÛŒÙ†ÛŒ.

ğŸ“¢ ØªÙˆØ¬Ù‡ : Ø§Ù…Ú©Ø§Ù† Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ Ùˆ ÙÙ‚Ø· ÙØ§ØµÙ„Ù‡ Ø¢Ù†Ù‡Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.

ğŸ”¸ - â€ Ø±Ø§Ù‡Ù†Ù…Ø§ : /help
"""
    bot.send_message(user_id, help_gps_text, reply_markup=main_markup)


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ /help_profile
@bot.message_handler(commands=['help_profile'])
def help_profile(message):
    user_id = message.from_user.id
    help_profile_text = """
ğŸ”¹Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú†ÛŒØ³ØªØŸ

- Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù† Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø®ÙˆØ¯Øª Ú©Ø§ÙÛŒÙ‡ ã€ŠğŸ‘¤ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ã€‹ Ø±Ùˆ Ù„Ù…Ø³ Ú©Ù†ÛŒ.
- Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù† Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø³ÛŒ Ú©Ù‡ Ø¨Ø§Ù‡Ø§Ø´ Ú†Øª Ù…ÛŒâ€ŒÚ©Ù†ÛŒ Ú©Ø§ÙÛŒÙ‡ ã€Šâ—»ï¸ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø§ÛŒÙ† Ù…Ø®Ø§Ø·Ø¨ â—»ï¸ ã€‹ Ø±Ùˆ Ù„Ù…Ø³ Ú©Ù†ÛŒ.
- Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù† Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù‡Ø±Ú©Ø§Ø±Ø¨Ø± Ú©Ø§ÙÛŒÙ‡ Ø±ÙˆÛŒ Ø¢ÛŒØ¯ÛŒØ´ ØªÙˆ Ø±Ø¨Ø§Øª Ø¨Ø²Ù†ÛŒ.

ğŸ“¢ Ø¢ÛŒØ¯ÛŒ Ú†ÛŒØ³ØªØŸ Ú©Ø¯ Ø§Ø®ØªØµØ§ØµÛŒ Ù‡Ø± Ú©Ø§Ø±Ø¨Ø± Ú©Ù‡ Ø¨Ø§ Ø²Ø¯Ù† Ø¢Ù† Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø± Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø¨Ù‡ ØµÙˆØ±Øª /user_X Ø§Ø³Øª.

- Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù‡Ø± Ú©Ø§Ø±Ø¨Ø± Ø´Ø§Ù…Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§ØªÛŒ Ú©Ù‡ ØªÙˆ Ø±Ø¨Ø§Øª Ø«Ø¨Øª Ú©Ø±Ø¯Ù‡ (Ù†Ø§Ù…ØŒØ³Ù†ØŒØ¬Ù†Ø³ÛŒØªØŒØ´Ù‡Ø±ØŒØ¹Ú©Ø³) Ùˆ ØªØ§Ø±ÛŒØ® Ø­Ø¶ÙˆØ±Ø´ ØªÙˆ Ø±Ø¨Ø§Øª Ùˆ ÙØ§ØµÙ„Ø´ Ø¨Ø§ Ø´Ù…Ø§Ù…ÛŒØ´Ù‡.

Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¯Ø§ÛŒØ±Ú©Øª ÛŒØ§ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú†Øª Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ú©Ø§Ø±Ø¨Ø± Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ù¾Ø±ÙˆÙØ§ÛŒÙ„Ø´ Ø±Ùˆ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ù†ÛŒ Ùˆ Ø³Ù¾Ø³ Ø¯Ú©Ù…Ù‡ Ù¾ÛŒØ§Ù… Ø¯Ø§ÛŒØ±Ú©Øª ÛŒØ§ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú†Øª Ø±Ùˆ Ø¨Ø²Ù†ÛŒ.

ğŸ”¸ - â€ Ø±Ø§Ù‡Ù†Ù…Ø§ : /help
"""
    bot.send_message(user_id, help_profile_text, reply_markup=main_markup)


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ /help_sendchat
@bot.message_handler(commands=['help_sendchat'])
def help_sendchat(message):
    user_id = message.from_user.id
    help_sendchat_text = """
ğŸ”¹Ú†Ú¯ÙˆÙ†Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú†Øª Ø¨ÙØ±Ø³ØªÙ…ØŸ

Ø¨Ø§ Ù¾ÛŒØ§Ù… Ø¯Ø§ÛŒØ±Ú©Øª Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø¨ØµÙˆØ±Øª Ø¢Ù†ÛŒ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù¾ÛŒØ§Ù… Ù…ØªÙ†ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¨Ú©Ù†ÛŒ Ø­ØªÛŒ Ø§Ú¯Ù‡ Ø¯Ø±Ø­Ø§Ù„ Ú†Øª Ú©Ø±Ø¯Ù† Ø¨Ø§Ø´Ù‡ !

ÙÙ‚Ø· Ú©Ø§ÙÛŒÙ‡ ÙˆÙ‚ØªÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø± Ø±Ùˆ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒ Ø±ÙˆÛŒ Ú¯Ø²ÛŒÙ†Ù‡ ã€ŠğŸ“¨ Ù¾ÛŒØ§Ù… Ø¯Ø§ÛŒØ±Ú©Øªã€‹ Ø¨Ø²Ù†ÛŒ Ùˆ Ù…ØªÙ† Ù¾ÛŒØ§Ù…ØªÙˆ Ø¨ÙØ±Ø³ØªÛŒ.

- Ø¯Ø±ØµÙˆØ±Øª Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¯Ø§ÛŒØ±Ú©Øª 1 Ø³Ú©Ù‡ Ø§Ø²Øª Ú©Ù… Ù…ÛŒâ€ŒØ´Ù‡
- Ø§ÛŒÙ† Ù¾ÛŒØ§Ù… Ù‡Ù…ÙˆÙ† Ù„Ø­Ø¸Ù‡ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´Ù‡ Ùˆ Ø¨Ø¹Ø¯Ø§ ØªÙˆ Ø±Ø¨Ø§Øª Ø¢Ø±Ø´ÛŒÙˆ Ù†Ù…ÛŒâ€ŒØ´Ù‡.

ğŸ“¢ ØªÙˆØ¬Ù‡ : Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ø­Ø¯Ø§Ú©Ø«Ø± Ù…ÛŒâ€ŒØªÙˆÙ†Ù‡ 200 Ø­Ø±Ù Ø¨Ø§Ø´Ù‡ Ùˆ Ø§Ú¯Ù‡ Ù…ØªÙ†ÛŒ Ú©Ù‡ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒ Ø¨ÛŒØ´ØªØ± Ø§Ø² 200 Ø­Ø±Ù Ø¨ÙˆØ¯ ÙÙ‚Ø· 200 Ø­Ø±Ù Ø§ÙˆÙ„Ø´ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´Ù‡.

ğŸ’¥ Ù‚Ø§Ø¨Ù„ÛŒØª ÙˆÛŒÚ˜Ù‡ Ù¾ÛŒØ§Ù… Ø¯Ø§ÛŒØ±Ú©Øª : Ø¯Ø±ØµÙˆØ±ØªÛŒ Ú©Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†Ù†Ø¯Ù‡ ØŒ Ø±Ø¨Ø§Øª Ø±Ø§ Ø¨Ù„Ø§Ú© Ú©Ø±Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ Ù¾ÛŒØ§Ù… Ø¯Ø§ÛŒØ±Ú©Øª Ø¨Ù‡ Ù…Ø­Ø¶ Ø¢Ù†Ø¨Ù„Ø§Ú© Ø´Ø¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ Ø§Ùˆ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø¯ ØªØ§ Ø­ØªÙ…Ø§Ù‹ Ù¾ÛŒØ§Ù… Ø¯Ø§ÛŒØ±Ú©Øª Ø±Ø§ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ù†Ø¯.

ğŸ”¸ - â€ Ø±Ø§Ù‡Ù†Ù…Ø§ : /help
"""
    bot.send_message(user_id, help_sendchat_text, reply_markup=main_markup)


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ /help_direct
@bot.message_handler(commands=['help_direct'])
def help_direct(message):
    user_id = message.from_user.id
    help_direct_text = """
ğŸ”¹Ù¾ÛŒØ§Ù… Ø¯Ø§ÛŒØ±Ú©Øª Ú†ÛŒØ³ØªØŸ

Ø¨Ø§ Ù¾ÛŒØ§Ù… Ø¯Ø§ÛŒØ±Ú©Øª Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø¨ØµÙˆØ±Øª Ø¢Ù†ÛŒ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù¾ÛŒØ§Ù… Ù…ØªÙ†ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¨Ú©Ù†ÛŒ Ø­ØªÛŒ Ø§Ú¯Ù‡ Ø¯Ø±Ø­Ø§Ù„ Ú†Øª Ú©Ø±Ø¯Ù† Ø¨Ø§Ø´Ù‡ !

ÙÙ‚Ø· Ú©Ø§ÙÛŒÙ‡ ÙˆÙ‚ØªÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø± Ø±Ùˆ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒ Ø±ÙˆÛŒ Ú¯Ø²ÛŒÙ†Ù‡ ã€ŠğŸ“¨ Ù¾ÛŒØ§Ù… Ø¯Ø§ÛŒrektã€‹ Ø¨Ø²Ù†ÛŒ Ùˆ Ù…ØªÙ† Ù¾ÛŒØ§Ù…ØªÙˆ Ø¨ÙØ±Ø³ØªÛŒ.

- Ø¯Ø±ØµÙˆØ±Øª Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¯Ø§ÛŒØ±Ú©Øª 1 Ø³Ú©Ù‡ Ø§Ø²Øª Ú©Ù… Ù…ÛŒâ€ŒØ´Ù‡
- Ø§ÛŒÙ† Ù¾ÛŒØ§Ù… Ù‡Ù…ÙˆÙ† Ù„Ø­Ø¸Ù‡ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´Ù‡ Ùˆ Ø¨Ø¹Ø¯Ø§ ØªÙˆ Ø±Ø¨Ø§Øª Ø¢Ø±Ø´ÛŒÙˆ Ù†Ù…ÛŒâ€ŒØ´Ù‡.

ğŸ“¢ ØªÙˆØ¬Ù‡ : Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ø­Ø¯Ø§Ú©Ø«Ø± Ù…ÛŒâ€ŒØªÙˆÙ†Ù‡ 200 Ø­Ø±Ù Ø¨Ø§Ø´Ù‡ Ùˆ Ø§Ú¯Ù‡ Ù…ØªÙ†ÛŒ Ú©Ù‡ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒ Ø¨ÛŒØ´ØªØ± Ø§Ø² 200 Ø­Ø±Ù Ø¨ÙˆØ¯ ÙÙ‚Ø· 200 Ø­Ø±Ù Ø§ÙˆÙ„Ø´ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´Ù‡.

ğŸ’¥ Ù‚Ø§Ø¨Ù„ÛŒØª ÙˆÛŒÚ˜Ù‡ Ù¾ÛŒØ§Ù… Ø¯Ø§ÛŒØ±Ú©Øª : Ø¯Ø±ØµÙˆØ±ØªÛŒ Ú©Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†Ù†Ø¯Ù‡ ØŒ Ø±Ø¨Ø§Øª Ø±Ø§ Ø¨Ù„Ø§Ú© Ú©Ø±Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ Ù¾ÛŒØ§Ù… Ø¯Ø§ÛŒØ±Ú©Øª Ø¨Ù‡ Ù…Ø­Ø¶ Ø¢Ù†Ø¨Ù„Ø§Ú© Ø´Ø¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ Ø§Ùˆ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø¯ ØªØ§ Ø­ØªÙ…Ø§Ù‹ Ù¾ÛŒØ§Ù… Ø¯Ø§ÛŒØ±Ú©Øª Ø±Ø§ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ù†Ø¯.

ğŸ”¸ - â€ Ø±Ø§Ù‡Ù†Ù…Ø§ : /help
"""
    bot.send_message(user_id, help_direct_text, reply_markup=main_markup)


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ /help_onw
@bot.message_handler(commands=['help_onw'])
def help_onw(message):
    user_id = message.from_user.id
    help_onw_text = """
ğŸ”¹ Ø§Ø·Ù„Ø§Ø¹ Ø±Ø³Ø§Ù†ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ† Ø´Ø¯Ù† Ù…Ø®Ø§Ø·Ø¨

Ø¨Ø§ Ø§ÛŒÙ† Ù‚Ø§Ø¨Ù„ÛŒØª ÙˆÙ‚ØªÛŒ Ú©Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø±Øª Ø¢Ù†Ù„Ø§ÛŒÙ† Ø´Ø¯ ØŒ Ø¨Ù‡Øª Ø§Ø·Ù„Ø§Ø¹ Ø±Ø³Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´Ù‡.

- Ø¯Ø±ØµÙˆØ±Øª ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ† Ù‚Ø§Ø¨Ù„ÛŒØª Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ú©Ø§Ø±Ø¨Ø± 1 ğŸ’°Ø³Ú©Ù‡ Ø§Ø²Øª Ú©Ù… Ù…ÛŒâ€ŒØ´Ù‡
- Ø§ÛŒÙ† Ù‚Ø§Ø¨Ù„ÛŒØª ÛŒÚ©Ø¨Ø§Ø± ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´Ù‡ Ùˆ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹ Ø±Ø³Ø§Ù†ÛŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø§ÛŒØ¯ ÛŒÚ©Ø¨Ø§Ø± Ø¯ÛŒÚ¯Ù‡ ÙØ¹Ø§Ù„Ø´ Ú©Ù†ÛŒ.
- Ø§Ú¯Ù‡ Ø¨Ø¹Ø¯ Ø§Ø² 10 Ø±ÙˆØ² Ú©Ø§Ø±Ø¨Ø± Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø±Øª Ø¢Ù†Ù„Ø§ÛŒÙ† Ù†Ø´Ø¯ Ø§ÛŒÙ† Ù‚Ø§Ø¨Ù„ÛŒØª ØºÛŒØ± ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´Ù‡.

ğŸ”´ Ø¨Ø±Ø§ÛŒ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ† Ù‚Ø§Ø¨Ù„ÛŒØª Ú¯Ø²ÛŒÙ†Ù‡ <<ğŸ”” Ø¨Ù‡ Ù…Ø­Ø¶ Ø¢Ù†Ù„Ø§ÛŒÙ† Ø´Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹ Ø¨Ø¯Ù‡ >> ØªÙˆÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø± Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø±Øª Ø±Ùˆ Ø¨Ø²Ù† .
(Ø¯Ø± ØµÙˆØ±ØªÛŒ Ú©Ù‡ Ø§ÛŒÙ† Ú¯Ø²ÛŒÙ†Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ù‡ ÛŒØ§ Ú©Ø§Ø±Ø¨Ø± Ø¢Ù†Ù„Ø§ÛŒÙ†Ù‡ Ùˆ ÛŒØ§ Ø§ÛŒÙ† Ù‚Ø§Ø¨Ù„ÛŒØª Ø±Ùˆ Ù‚Ø¨Ù„Ø§Ù‹ Ø¨Ø±Ø§Ø´ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯ÛŒ)

ğŸ”¸ - â€ Ø±Ø§Ù‡Ù†Ù…Ø§ : /help
"""
    bot.send_message(user_id, help_onw_text, reply_markup=main_markup)


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ /help_chw
@bot.message_handler(commands=['help_chw'])
def help_chw(message):
    user_id = message.from_user.id
    help_chw_text = """
ğŸ”¹ Ø§Ø·Ù„Ø§Ø¹ Ø±Ø³Ø§Ù†ÛŒ Ø§ØªÙ…Ø§Ù… Ú†Øª Ù…Ø®Ø§Ø·Ø¨

Ø¨Ø§ Ø§ÛŒÙ† Ù‚Ø§Ø¨Ù„ÛŒØª ÙˆÙ‚ØªÛŒ Ú©Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø±Øª Ú†ØªØ´ Ø¨Ø§ Ù…Ø®Ø§Ø·Ø¨Ø´ ØªÙ…ÙˆÙ… Ø¨Ø´Ù‡ ØŒ Ø¨Ù‡Øª Ø§Ø·Ù„Ø§Ø¹ Ø±Ø³Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´Ù‡.

- Ø¯Ø±ØµÙˆØ±Øª ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ† Ù‚Ø§Ø¨Ù„ÛŒØª Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ú©Ø§Ø±Ø¨Ø± 1 ğŸ’°Ø³Ú©Ù‡ Ø§Ø²Øª Ú©Ù… Ù…ÛŒâ€ŒØ´Ù‡
- Ø§ÛŒÙ† Ù‚Ø§Ø¨Ù„ÛŒØª ÛŒÚ©Ø¨Ø§Ø± ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´Ù‡ Ùˆ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹ Ø±Ø³Ø§Ù†ÛŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø§ÛŒØ¯ ÛŒÚ©Ø¨Ø§Ø± Ø¯ÛŒÚ¯Ù‡ ÙØ¹Ø§Ù„Ø´ Ú©Ù†ÛŒ.
- Ø§Ú¯Ù‡ Ø¨Ø¹Ø¯ Ø§Ø² 10 Ø±ÙˆØ² Ú†Øª Ú©Ø§Ø±Ø¨Ø± Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø±Øª ØªÙ…ÙˆÙ… Ù†Ø´Ø¯ Ø§ÛŒÙ† Ù‚Ø§Ø¨Ù„ÛŒØª ØºÛŒØ± ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´Ù‡.

ğŸ”´ Ø¨Ø±Ø§ÛŒ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ† Ù‚Ø§Ø¨Ù„ÛŒØª Ú¯Ø²ÛŒÙ†Ù‡ << Ú†Øª Ú©Ø±Ø¯Ù†Ø´ ØªÙ…ÙˆÙ… Ø´Ø¯ Ø¨Ù‡Ù… Ø®Ø¨Ø± Ø¨Ø¯Ù‡ ğŸ”Š>> ØªÙˆÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø± Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø±Øª Ø±Ùˆ Ø¨Ø²Ù† .
(Ø¯Ø± ØµÙˆØ±ØªÛŒ Ú©Ù‡ Ø§ÛŒÙ† Ú¯Ø²ÛŒÙ†Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ù‡ ÛŒØ§ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø±Ø¬Ø§Ù„ Ú†Øª Ù†ÛŒØ³Øª Ùˆ ÛŒØ§ Ø§ÛŒÙ† Ù‚Ø§Ø¨Ù„ÛŒØª Ø±Ùˆ Ù‚Ø¨Ù„Ø§Ù‹ Ø¨Ø±Ø§Ø´ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯ÛŒ)

ğŸ”¸ - â€ Ø±Ø§Ù‡Ù†Ù…Ø§ : /help
"""
    bot.send_message(user_id, help_chw_text, reply_markup=main_markup)


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ /help_contacts
@bot.message_handler(commands=['help_contacts'])
def help_contacts(message):
    user_id = message.from_user.id
    help_contacts_text = """
ğŸ”¹ â€ Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø±Ø¯Ù† Ú†ÛŒØ³Øª ØŸ

Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØª Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø±Ø¯Ù† Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ù…Ø®Ø§Ø·Ø¨ Ù‡Ø§ØªÙˆ ØªÙˆ Ø±Ø¨Ø§Øª Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒ Ùˆ Ú¯Ù…Ø´ÙˆÙ† Ù†Ú©Ù†ÛŒ !

- Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù† Ù„ÛŒØ³Øª Ø¯Ù†Ø¨Ø§Ù„ Ú©Ù†Ù†Ø¯Ù‡â€ŒÙ‡Ø§ (ÙØ§Ù„ÙˆØ±) Ø®ÙˆØ¯Øª Ú©Ø§ÙÛŒÙ‡ ã€ŠğŸ‘« Ø¯ÙˆØ³ØªØ§Ù†ã€‹ Ø±Ùˆ Ø§Ø² Ù…Ù†ÙˆÛŒ Ø±Ø¨Ø§Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒ Ùˆ <<ğŸ‘« Ø§ÙˆÙ†Ø§ÛŒÛŒ Ú©Ù‡ ÙØ§Ù„Ùˆ Ú©Ø±Ø¯Ù… â™¡>> Ø±Ùˆ Ù„Ù…Ø³ Ú©Ù†ÛŒ.
Ùˆ ÛŒØ§ << /followers >> Ø±Ùˆ Ø§Ø² Ù…Ù†ÙˆÛŒ Ù…ÛŒØ§Ù†Ø¨Ø±â€ŒÙ‡Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒ.

Ø¨Ø±Ø§ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ Ù„ÛŒØ³Øª ÙØ§Ù„ÙˆØ± Ú¯Ø²ÛŒÙ†Ù‡ <<ğŸš¶â€â™‚ï¸Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø±Ø¯Ù† >> Ø±Ùˆ ØªÙˆ Ù¾Ø±ÙˆÙØ§ÛŒÙ„Ø´ Ø¨Ø²Ù†.

ğŸ”¸ - â€ Ø±Ø§Ù‡Ù†Ù…Ø§ : /help
"""
    bot.send_message(user_id, help_contacts_text, reply_markup=main_markup)


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ /help_deleteMessage
@bot.message_handler(commands=['help_deleteMessage'])
def help_deleteMessage(message):
    user_id = message.from_user.id
    help_deleteMessage_text = """
ğŸ”¹ Ø¢Ù…ÙˆØ²Ø´ Ø­Ø°Ù Ù¾ÛŒØ§Ù… Ø¯Ø± Ú†Øª

Ù‡Ø± Ù¾ÛŒØ§Ù…ÛŒ Ú©Ù‡ ØªÙˆ Ú†Øª ÙØ±Ø³ØªØ§Ø¯ÛŒ Ùˆ Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ Ø­Ø°ÙØ´ Ú©Ù†ÛŒ Ú©Ø§ÙÛŒÙ‡ Ø±ÛŒÙ¾Ù„Ø§ÛŒØ´ Ú©Ù†ÛŒ Ùˆ Ú©Ù„Ù…Ù‡ Â«Ø­Ø°ÙÂ» Ø±Ùˆ ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒ ØªØ§ Ø§Ø² Ú†Øª Ù…Ø®Ø§Ø·Ø¨Øª Ø­Ø°Ù Ø¨Ø´Ù‡.

ğŸ”¸ - â€ Ø±Ø§Ù‡Ù†Ù…Ø§ : /help

Ú©Ø§Ù†Ø§Ù„ Ø±Ø³Ù…ÛŒ Ù…Ø§ ğŸ¤– (Ø§Ø®Ø¨Ø§Ø±ØŒØ¢Ù¾Ø¯ÛŒØªâ€ŒÙ‡Ø§ Ùˆ ØªØ±ÙÙ†Ø¯â€ŒÙ‡Ø§) ğŸ
"""
    bot.send_message(user_id, help_deleteMessage_text, reply_markup=main_markup)


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ /help_deleteAccount
@bot.message_handler(commands=['help_deleteAccount'])
def help_deleteAccount(message):
    user_id = message.from_user.id
    help_deleteAccount_text = """
ğŸ”¹ Ø¢Ù…ÙˆØ²Ø´ Ø­Ø°Ù Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¯Ø± Ø±Ø¨Ø§Øª

Ø§Ú¯Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ Ù‡Ù…Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±ÛŒØª Ø¯Ø§Ø®Ù„ Ø±Ø¨Ø§Øª Ù¾Ø§Ú© Ø¨Ø´Ù‡ØŒ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø§Ø² Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒ ØªØ§ Ø¨Ù‡ Ø·ÙˆØ± Ú©Ø§Ù…Ù„ Ø§Ø² Ø³Ø±ÙˆØ± Ù…Ø§ Ø­Ø°Ù Ø¨Ø´Ù‡.

ğŸ”¸ - â€ Ø±Ø§Ù‡Ù†Ù…Ø§ : /help
"""
    bot.send_message(user_id, help_deleteAccount_text, reply_markup=main_markup)


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ /rules
@bot.message_handler(commands=['rules'])
def rules(message):
    user_id = message.from_user.id
    rules_text = """
ğŸš« Ù‚ÙˆØ§Ù†ÛŒÙ† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú†ØªÙˆÚ¯Ø±Ø§Ù…

Ù…ÙˆØ§Ø±Ø¯ Ø²ÛŒØ± Ø¨Ø§Ø¹Ø« Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯Ù† Ø¯Ø§Ø¦Ù…ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯

1ï¸âƒ£ ØªØ¨Ù„ÛŒØºØ§Øª Ø³Ø§ÛŒØªâ€ŒÙ‡Ø§ Ø±Ø¨Ø§Øªâ€ŒÙ‡Ø§ Ùˆ Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§
2ï¸âƒ£ Ø§Ø±Ø³Ø§Ù„ Ù‡Ø±Ú¯ÙˆÙ†Ù‡ Ù…Ø­ØªÙˆØ§ÛŒ ØºÛŒØ± Ø§Ø®Ù„Ø§Ù‚ÛŒ
3ï¸âƒ£ Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø²Ø§Ø­Ù…Øª Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
4ï¸âƒ£ Ù¾Ø®Ø´ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ ÛŒØ§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®ØµÛŒ Ø¯ÛŒÚ¯Ø±Ø§Ù†
5ï¸âƒ£ Ù…Ø­ØªÙˆØ§ÛŒ ØºÛŒØ± Ø§Ø®Ù„Ø§Ù‚ÛŒ Ùˆ ÛŒØ§ ØªÙˆÙ‡ÛŒÙ† Ø¢Ù…ÛŒØ² Ø¯Ø± Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú†ØªÙˆÚ¯Ø±Ø§Ù…
6ï¸âƒ£ Ø«Ø¨Øª Ø¬Ù†Ø³ÛŒØª Ø§Ø´ØªØ¨Ø§Ù‡ Ø¯Ø± Ù¾Ø±ÙˆÙØ§ÛŒÙ„
7ï¸âƒ£ ØªÙ‡Ø¯ÛŒØ¯ Ùˆ Ø¬Ø§ Ø²Ø¯Ù† Ø®ÙˆØ¯ Ø¨Ø¹Ù†ÙˆØ§Ù† Ù…Ø¯ÛŒØ± Ø±Ø¨Ø§Øª ÛŒØ§ Ù¾Ù„ÛŒØ³ ÙØªØ§ !

Ø¨Ø±Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´ Ø¹Ø¯Ù… Ø±Ø¹Ø§ÛŒØª Ù‚ÙˆØ§Ù†ÛŒÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø§ Ù„Ù…Ø³ ã€Š ğŸš« Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ø±Ø¨Ø± ã€‹ Ø¯Ø± Ù¾Ø±ÙˆÙØ§ÛŒÙ„ØŒ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ú¯Ø²Ø§Ø±Ø´ Ú©Ù†ÛŒØ¯.

ğŸ‘ˆØ¯Ø±ØµÙˆØ±Øª Ú¯Ø²Ø§Ø±Ø´ ØµØ­ÛŒØ­ Ú©Ø§Ø±Ø¨Ø± Ù…ØªØ®Ù„Ù ğŸ’° 5 Ø³Ú©Ù‡ Ø¨Ø¹Ù†ÙˆØ§Ù† Ù‡Ø¯ÛŒÙ‡ Ø¯Ø±ÛŒØ§ÙØª Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯.

ğŸ”¸ - â€ Ø±Ø§Ù‡Ù†Ù…Ø§ : /help
"""
    bot.send_message(user_id, rules_text, reply_markup=main_markup)


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø¯Ø¹ÙˆØª Ø¯ÙˆØ³ØªØ§Ù†
@bot.message_handler(func=lambda message: message.text == "âš ï¸Ø¯Ø¹ÙˆØª Ø¯ÙˆØ³ØªØ§Ù† (Ø³Ú©Ù‡ Ø±Ø§ÛŒÚ¯Ø§Ù†)")
def invite_friends(message):
    user_id = message.from_user.id
    update_last_online(user_id)  # ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù‡

    # Ú¯Ø±ÙØªÙ† ÛŒØ§ ØªÙˆÙ„ÛŒØ¯ Ú©Ø¯ Ø§Ø±Ø¬Ø§Ø¹
    referral_code = get_referral_code(user_id)
    referral_link = f"https://t.me/testdeletebot0039_bot?start={referral_code}"
    referral_count = get_referral_count(user_id)

    # Ù¾ÛŒØ§Ù… Ø§ÙˆÙ„ Ø¨Ø§ Ø¹Ú©Ø³ Ùˆ Ú©Ù¾Ø´Ù† (Ø¨Ø§ HTML)
    photo_file_id = "AgACAgQAAxkBAAIEy2iOReCzNHcp47RvZUJlLCSj2eyoAAJY0jEbjol4UEmrSb48pP90AQADAgADeQADNgQ"
    caption = (
        "<b>ğŸ”¥ Ù‡Ù…ÛŒÙ† Ø§Ù„Ø¢Ù† Ú©Ø±Ø§Ø´ÙØªÙˆ Ù¾ÛŒØ¯Ø§ Ú©Ù† ğŸ˜ğŸ‘«</b>\n\n"
        "Ø¨Ø§ <b>Ú†ØªÙˆÚ¯Ø±Ø§Ù…</b> Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ:\n"
        "ğŸ“¡ Ø§ÙØ±Ø§Ø¯ <b>#Ù†Ø²Ø¯ÛŒÚ©</b> Ø®ÙˆØ¯ØªÙˆ Ù¾ÛŒØ¯Ø§Ú©Ù†ÛŒ Ùˆ Ø¨Ø§Ù‡Ø§Ø´ÙˆÙ† Ø¢Ø´Ù†Ø§ Ø¨Ø´ÛŒ\n"
        "ğŸ’¬ Ø¨Ù‡ ØµÙˆØ±Øª <b>#Ù†Ø§Ø´Ù†Ø§Ø³</b> Ø¨Ø§ ÛŒÚ© Ù†ÙØ± Ú†Øª Ú©Ù†ÛŒ\n"
        "ğŸ‘¤ Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø·Ø±Ù Ø±Ùˆ Ø¨Ø¨ÛŒÙ†ÛŒ Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒ\n\n"
        f"Ù‡Ù…ÛŒÙ† Ø§Ù„Ø¢Ù† Ø±ÙˆÛŒ Ù„ÛŒÙ†Ú© Ø¨Ø²Ù† ğŸ‘‡\n<a href='{referral_link}'>Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª</a>\n"
        "<b>âœ… Ø±Ø§ÛŒÚ¯Ø§Ù† Ùˆ ÙˆØ§Ù‚Ø¹ÛŒ ğŸ˜</b>"
    )
    try:
        bot.send_photo(user_id, photo_file_id, caption=caption, parse_mode="HTML")
    except telebot.apihelper.ApiTelegramException as e:
        print(f"Error sending photo to user {user_id}: {e}")
        # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ø¯ÙˆÙ† Ø¹Ú©Ø³ Ø§Ú¯Ù‡ Ø®Ø·Ø§ Ø¨Ø¯Ù‡
        bot.send_message(user_id, caption, parse_mode="HTML", reply_markup=main_markup)

    # Ù¾ÛŒØ§Ù… Ø¯ÙˆÙ… Ø¨Ø§ Ù„ÛŒÙ†Ú© Ø§Ø®ØªØµØ§ØµÛŒ Ùˆ ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø¹ÙˆØªâ€ŒÙ‡Ø§ (Ø¨Ø§ HTML)
    second_message = (
        f"<b>ğŸ”— Ù„ÛŒÙ†Ú© Ø§Ø®ØªØµØ§ØµÛŒ Ø´Ù…Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯ âš¡ï¸</b>\n"
        f"<a href='{referral_link}'>Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª</a>\n\n"
        "Ø¨Ø§ Ø¯Ø¹ÙˆØª Ù‡Ø± ÛŒÚ© Ù†ÙØ± <b>20 Ø³Ú©Ù‡</b> Ø¯Ø±ÛŒØ§ÙØª Ù…ÛŒâ€ŒÚ©Ù†ÛŒ ğŸ˜\n"
        f"ØªØ§ Ø­Ø§Ù„Ø§ <b>{referral_count}</b> Ù†ÙØ± Ø±Ùˆ Ø¯Ø¹ÙˆØª Ú©Ø±Ø¯ÛŒ\n\n"
        "Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ú©Ù‡ Ø¯ÙˆØ³ØªØ§Øª Ø±Ùˆ Ø¨Ù‡ Ø±Ø¨Ø§Øª Ø¯Ø¹ÙˆØª Ú©Ù†ÛŒ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø§Ø² Ù„ÛŒÙ†Ú© Ø§Ø®ØªØµØ§ØµÛŒØª Ú©Ù‡ Ø¨Ø§Ù„Ø§ Ø¨Ø±Ø§Øª ÙØ±Ø³ØªØ§Ø¯Ù… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒ ğŸ˜â•"
    )
    try:
        bot.send_message(user_id, second_message, parse_mode="HTML")
    except telebot.apihelper.ApiTelegramException as e:
        print(f"Error sending second message to user {user_id}: {e}")
        bot.send_message(user_id, second_message, reply_markup=main_markup)


# # Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø¬Ø§Ø¹
# @bot.message_handler(commands=['start'])
# def handle_start(message):
#     user_id = message.from_user.id
#     update_last_online(user_id)
#
#     # Ú†Ú© Ú©Ø±Ø¯Ù† Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ù„ÛŒÙ†Ú© Ø§Ø±Ø¬Ø§Ø¹ Ø¯Ø§Ø±Ù‡ ÛŒØ§ Ù†Ù‡
#
#                 bot.send_message(
#                     user_id,
#                     "Ø¨Ù‡ <b>Ú†ØªÙˆÚ¯Ø±Ø§Ù…</b> Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ! ğŸ˜ Ø¨Ø§ Ø§ÛŒÙ† Ø±Ø¨Ø§Øª Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø¯ÙˆØ³ØªØ§ÛŒ Ø¬Ø¯ÛŒØ¯ Ù¾ÛŒØ¯Ø§ Ú©Ù†ÛŒ!",
#                     parse_mode="HTML",
#                 )
#         else:
#             bot.send_message(
#                 user_id,
#                 "Ø¨Ù‡ <b>Ú†ØªÙˆÚ¯Ø±Ø§Ù…</b> Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ! ğŸ˜ Ø¨Ø§ Ø§ÛŒÙ† Ø±Ø¨Ø§Øª Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø¯ÙˆØ³ØªØ§ÛŒ Ø¬Ø¯ÛŒØ¯ Ù¾ÛŒØ¯Ø§ Ú©Ù†ÛŒ!",
#                 parse_mode="HTML"
#             )
#     else:
#         bot.send_message(
#             user_id,
#             "Ø¨Ù‡ <b>Ú†ØªÙˆÚ¯Ø±Ø§Ù…</b> Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ! ğŸ˜ Ø¨Ø§ Ø§ÛŒÙ† Ø±Ø¨Ø§Øª Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø¯ÙˆØ³ØªØ§ÛŒ Ø¬Ø¯ÛŒØ¯ Ù¾ÛŒØ¯Ø§ Ú©Ù†ÛŒ!",
#             parse_mode="HTML"
#         )



# ØªØ¹Ø±ÛŒÙ Ø¢ÛŒØ¯ÛŒ Ú©Ø§Ù†Ø§Ù„
CHANNEL_ID = "@chatooogram"


@bot.message_handler(commands=['start'])
def start(message):
    user_id = message.from_user.id
    first_name = message.from_user.first_name or "Ú©Ø§Ø±Ø¨Ø±"
    chat_id = message.chat.id
    unique_id = ''.join(random.choices(string.ascii_letters + string.digits, k=8))
    cursor = conn.cursor()

    # Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ú©Ø§Ù†Ø§Ù„
    try:
        member = bot.get_chat_member(CHANNEL_ID, user_id)
        if member.status in ['member', 'administrator', 'creator']:
            # Ú©Ø§Ø±Ø¨Ø± Ø¹Ø¶Ùˆ Ú©Ø§Ù†Ø§Ù„ Ø§Ø³ØªØŒ Ø§Ø¯Ø§Ù…Ù‡ ÙØ±Ø¢ÛŒÙ†Ø¯
            args = message.text.split()
            if len(args) > 1:
                referral_code = args[1]
                cursor.execute("SELECT user_id FROM referrals WHERE referral_code = ?", (referral_code,))
                result = cursor.fetchone()
                if result:
                    inviter_user_id = result[0]
                    # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø§Ú¯Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù‡
                    cursor.execute("SELECT user_id FROM users WHERE user_id = ?", (user_id,))
                    if not cursor.fetchone():
                        cursor.execute(
                            "INSERT INTO users (user_id, status, coins, last_online) VALUES (?, 'idle', 10, ?)",
                            (user_id, datetime.now())
                        )
                        conn.commit()
                    # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø³Ú©Ù‡ Ùˆ Ø¢Ù¾Ø¯ÛŒØª ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø¹ÙˆØªâ€ŒÙ‡Ø§
                    if add_referral(inviter_user_id, user_id):
                        bot.send_message(
                            inviter_user_id,
                            "ğŸ‰ ÛŒÙ‡ Ù†ÙØ± Ø¨Ø§ Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ø´Ù…Ø§ ÙˆØ§Ø±Ø¯ Ø±Ø¨Ø§Øª Ø´Ø¯! <b>20 Ø³Ú©Ù‡</b> Ø¨Ù‡ Ø­Ø³Ø§Ø¨Øª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯! ğŸ˜",
                            parse_mode="HTML"
                        )
                        bot.send_message(
                            user_id,
                            "ğŸ‰ Ø¨Ø§ Ù„ÛŒÙ†Ú© Ø¯Ø¹ÙˆØª Ø¯ÙˆØ³ØªØª ÙˆØ§Ø±Ø¯ Ø±Ø¨Ø§Øª Ø´Ø¯ÛŒ! Ø­Ø§Ù„Ø§ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø¨Ø§ <b>Ú†ØªÙˆÚ¯Ø±Ø§Ù…</b> Ú©Ø±Ø§Ø´ØªÙˆ Ù¾ÛŒØ¯Ø§ Ú©Ù†ÛŒ! ğŸ˜",
                            parse_mode="HTML"
                        )
                else:
                    handle_new_user(user_id, first_name, chat_id, unique_id)
            else:
                handle_new_user(user_id, first_name, chat_id, unique_id)
        else:
            # Ú©Ø§Ø±Ø¨Ø± Ø¹Ø¶Ùˆ Ú©Ø§Ù†Ø§Ù„ Ù†ÛŒØ³Øª
            markup = types.InlineKeyboardMarkup()
            markup.add(types.InlineKeyboardButton("Ø¹Ø¶ÙˆÛŒØª Ø¯Ø± Ú©Ø§Ù†Ø§Ù„", url=f"https://t.me/chatooogram"))
            markup.add(types.InlineKeyboardButton("Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª", callback_data="check_membership"))
            bot.send_message(
                user_id,
                f"Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±Ø¨Ø§ØªØŒ Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ {CHANNEL_ID} Ø¹Ø¶Ùˆ Ø¨Ø´ÛŒ! ğŸ˜Š\nØ¨Ø¹Ø¯ Ø§Ø² Ø¹Ø¶ÙˆÛŒØªØŒ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ 'Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª' Ú©Ù„ÛŒÚ© Ú©Ù†.",
                reply_markup=markup
            )
    except Exception as e:
        bot.send_message(user_id, "Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.")
        print(f"Error checking membership: {e}")


# ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
def handle_new_user(user_id, first_name, chat_id, unique_id):
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM users WHERE user_id=?", (user_id,))
    if not cursor.fetchone():
        cursor.execute(
            "INSERT INTO users (user_id, name, chat_id, unique_id, profile_photo, last_online) VALUES (?, ?, ?, ?, ?, ?)",
            (user_id, first_name, chat_id, unique_id, DEFAULT_PROFILE_PHOTO,
             datetime.now().strftime('%Y-%m-%d %H:%M:%S'))
        )
        conn.commit()
        welcome_text = f"""Ø³Ù„Ø§Ù… {first_name} Ø¹Ø²ÛŒØ² âœ‹

Ø¨Ù‡ ã€ŠØ±Ø¨Ø§Øª Ú†Øª Ù†Ø§Ø´Ù†Ø§Ø³ Ú†ÙØªÙˆÚ¯ÙØ±Ø§Ù… ğŸ“¡ã€‹ Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ ØŒ ØªÙˆÛŒ Ø§ÛŒÙ† Ø±Ø¨Ø§Øª Ù…ÛŒ ØªÙˆÙ†ÛŒ Ø§ÙØ±Ø§Ø¯ #Ù†Ø²Ø¯ÛŒÚ© Ø§Øª Ø±Ùˆ Ù¾ÛŒØ¯Ø§ Ú©Ù†ÛŒ Ùˆ Ø¨Ø§Ù‡Ø§Ø´ÙˆÙ† Ø¢Ø´Ù†Ø§ Ø´ÛŒ Ùˆ ÛŒØ§ Ø¨Ù‡ ÛŒÙ‡ Ù†ÙØ± Ø¨ØµÙˆØ±Øª #Ù†Ø§Ø´Ù†Ø§Ø³ ÙˆØµÙ„ Ø´ÛŒ Ùˆ Ø¨Ø§Ù‡Ø§Ø´ #Ú†Øª Ú©Ù†ÛŒ â—ï¸

- Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§ÛŒÙ† Ø±Ø¨Ø§Øª Ø±Ø§ÛŒÚ¯Ø§Ù†Ù‡ Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù… Ø´Ù…Ø§ Ù…Ø«Ù„ Ø§Ø³Ù…ØŒØ¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ ÛŒØ§ Ù…ÙˆÙ‚Ø¹ÛŒØª GPS Ú©Ø§Ù…Ù„Ø§ Ù…Ø­Ø±Ù…Ø§Ù†Ù‡ Ù‡Ø³ØªğŸ˜

Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø¨Ù‡Ù… Ø¨Ú¯Ùˆ Ø¯Ø®ØªØ±ÛŒ ÛŒØ§ Ù¾Ø³Ø± ØŸ ğŸ‘‡"""
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
        markup.add("Ù…Ù† Ù¾Ø³Ø±Ù…", "Ù…Ù† Ø¯Ø®ØªØ±Ù…")
        markup.add("Ù„ØºÙˆ âŒ")
        bot.send_message(user_id, welcome_text, reply_markup=markup)
    else:
        bot.send_message(user_id, "Ø®ÙˆØ´ Ø¨Ø±Ú¯Ø´ØªÛŒ! Ú†ÛŒ Ú©Ù…Ú©ÛŒ Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ø¨Ú©Ù†Ù…ØŸ", reply_markup=main_markup)


# Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ú©Ù…Ù‡ Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª
@bot.callback_query_handler(func=lambda call: call.data == "check_membership")
def check_membership_callback(call):
    user_id = call.from_user.id
    first_name = call.from_user.first_name or "Ú©Ø§Ø±Ø¨Ø±"
    chat_id = call.message.chat.id
    unique_id = ''.join(random.choices(string.ascii_letters + string.digits, k=8))

    try:
        member = bot.get_chat_member(CHANNEL_ID, user_id)
        if member.status in ['member', 'administrator', 'creator']:
            bot.delete_message(chat_id, call.message.message_id)  # Ø­Ø°Ù Ù¾ÛŒØ§Ù… Ù‚Ø¨Ù„ÛŒ
            handle_new_user(user_id, first_name, chat_id, unique_id)
        else:
            bot.answer_callback_query(call.id, "Ø´Ù…Ø§ Ù‡Ù†ÙˆØ² Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ Ø¹Ø¶Ùˆ Ù†Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯! Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø¹Ø¶Ùˆ Ø´ÙˆÛŒØ¯.")
    except Exception as e:
        bot.answer_callback_query(call.id, "Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.")
        print(f"Error checking membership: {e}")
# Ù‡Ù†Ø¯Ù„Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø¬Ù†Ø³ÛŒØª
@bot.message_handler(func=lambda message: message.text in ["Ù…Ù† Ù¾Ø³Ø±Ù…", "Ù…Ù† Ø¯Ø®ØªØ±Ù…", "Ù„ØºÙˆ âŒ"])
def set_gender(message):
    user_id = message.from_user.id
    if message.text == "Ù„ØºÙˆ âŒ":
        bot.send_message(user_id, "Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯.", reply_markup=main_markup)
        return

    if message.text == "Ù…Ù† Ù¾Ø³Ø±Ù…":
        gender = 'male'
        gender_title = "Ù¾Ø³Ø±"
    else:
        gender = 'female'
        gender_title = "Ø¯Ø®ØªØ±"

    cursor.execute("UPDATE users SET gender = ? WHERE user_id = ?", (gender, user_id))
    conn.commit()

    text = f"Ú†Ù†Ø¯ Ø³Ø§Ù„ØªÙ‡ {gender_title} ØŸ\nØ®Ø¨ {gender_title} Ø¹Ø²ÛŒØ²ØŒ ÙˆØ§Ø³Ù‡ Ø§Ø¯Ø§Ù…Ù‡ Ø«Ø¨Øª Ù†Ø§Ù… Ø¨Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒØ´ØªØ±ÛŒ Ø§Ø²Øª Ù†ÛŒØ§Ø² Ø¯Ø§Ø±Ù… Ú©Ù‡ Ø¨ØªÙˆÙ†Ù… Ø¨Ø±Ø§Øª Ø§ÙØ±Ø§Ø¯ Ø±Ùˆ Ù¾ÛŒØ¯Ø§ Ú©Ù†Ù… ØªØ§ Ø¨Ø§Ù‡Ø§Ø´ÙˆÙ† ØµØ­Ø¨Øª Ú©Ù†ÛŒ."
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    row = []
    for age in range(13, 61):
        row.append(str(age))
        if len(row) == 7:
            markup.row(*row)
            row = []
    if row:
        markup.row(*row)
    markup.add("Ù„ØºÙˆ âŒ")
    bot.send_message(user_id, text, reply_markup=markup)


# --------------------------------------------------------------------------------------------------------------------------


# ØªÙ†Ø¸ÛŒÙ…Ø§Øª
MERCHANT_ID = "your_merchant_id_here"  # Ù…Ø±Ú†Ù†Øª Ø¢ÛŒØ¯ÛŒ Ø²Ø±ÛŒÙ†â€ŒÙ¾Ø§Ù„
BOT_USERNAME = "@Chatoogrambot"  # Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø±Ø¨Ø§ØªØª
ZARINPAL_API_URL = "https://www.zarinpal.com/pg/v4/payment/request.json"  # ÛŒØ§ sandbox
ZARINPAL_VERIFY_URL = "https://www.zarinpal.com/pg/v4/payment/verify.json"  # ÛŒØ§ sandbox
CALLBACK_URL = f"https://t.me/{BOT_USERNAME}?start=payment_"

# Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³
def get_db_connection():
    conn = sqlite3.connect('chatbot.db')  # Ù…Ø³ÛŒØ± Ø¯ÛŒØªØ§Ø¨ÛŒØ³Øª
    conn.row_factory = sqlite3.Row
    return conn

# ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ú¯Ø±ÙØªÙ† ØªØ¹Ø¯Ø§Ø¯ Ø³Ú©Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
def get_user_coins(user_id):
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT coins FROM users WHERE user_id = ?", (user_id,))
    result = cursor.fetchone()
    conn.close()
    return result[0] if result else 10  # 10 Ø³Ú©Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø§Ú¯Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø¨Ø§Ø´Ù‡

# ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒÙ†Ú© Ù¾Ø±Ø¯Ø§Ø®Øª Ø²Ø±ÛŒÙ†â€ŒÙ¾Ø§Ù„
def create_payment_link(user_id, amount, coins):
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute(
        "INSERT INTO payments (user_id, amount, coins, status, created_at) VALUES (?, ?, ?, 'pending', ?)",
        (user_id, amount, coins, datetime.now())
    )
    conn.commit()
    payment_id = cursor.lastrowid

    payload = {
        "merchant_id": MERCHANT_ID,
        "amount": amount * 10,  # ØªØ¨Ø¯ÛŒÙ„ ØªÙˆÙ…Ø§Ù† Ø¨Ù‡ Ø±ÛŒØ§Ù„
        "description": f"Ø®Ø±ÛŒØ¯ {coins} Ø³Ú©Ù‡ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± {user_id}",
        "callback_url": f"{CALLBACK_URL}{payment_id}",
        "metadata": {"mobile": "", "email": ""}
    }
    try:
        response = requests.post(ZARINPAL_API_URL, json=payload)
        result = response.json()
        if result.get("data", {}).get("code") == 100:
            authority = result["data"]["authority"]
            cursor.execute("UPDATE payments SET authority = ? WHERE payment_id = ?", (authority, payment_id))
            conn.commit()
            conn.close()
            return f"https://www.zarinpal.com/pg/StartPay/{authority}"
            # Ø¨Ø±Ø§ÛŒ sandbox: return f"https://sandbox.zarinpal.com/pg/StartPay/{authority}"
        else:
            print(f"Zarinpal error: {result.get('errors')}")
            conn.close()
            return None
    except Exception as e:
        print(f"Error creating payment link: {e}")
        conn.close()
        return None

# ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª
def verify_payment(payment_id, authority):
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT amount, user_id, coins FROM payments WHERE payment_id = ?", (payment_id,))
    payment = cursor.fetchone()
    if not payment:
        conn.close()
        return False, "Ù¾Ø±Ø¯Ø§Ø®Øª Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯."

    amount, user_id, coins = payment['amount'], payment['user_id'], payment['coins']

    # ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø² Ø²Ø±ÛŒÙ†â€ŒÙ¾Ø§Ù„
    verify_payload = {
        "merchant_id": MERCHANT_ID,
        "amount": amount * 10,  # ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø±ÛŒØ§Ù„
        "authority": authority
    }
    try:
        response = requests.post(ZARINPAL_VERIFY_URL, json=verify_payload)
        result = response.json()
        if result.get("data", {}).get("code") == 100:
            # Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÙˆÙÙ‚
            cursor.execute("UPDATE payments SET status = 'success' WHERE payment_id = ?", (payment_id,))
            cursor.execute("UPDATE users SET coins = coins + ? WHERE user_id = ?", (coins, user_id))
            conn.commit()
            conn.close()
            return True, f"Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÙˆÙÙ‚! {coins} Ø³Ú©Ù‡ Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯."
        else:
            cursor.execute("UPDATE payments SET status = 'failed' WHERE payment_id = ?", (payment_id,))
            conn.commit()
            conn.close()
            return False, "Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯."
    except Exception as e:
        print(f"Error verifying payment: {e}")
        cursor.execute("UPDATE payments SET status = 'failed' WHERE payment_id = ?", (payment_id,))
        conn.commit()
        conn.close()
        return False, "Ø®Ø·Ø§ Ø¯Ø± ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª."

# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ callback Ù¾Ø±Ø¯Ø§Ø®Øª
@bot.message_handler(commands=['start'])
def handle_start(message):
    user_id = message.from_user.id
    update_last_online(user_id)  # ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù‡

    if message.text.startswith('/start payment_'):
        try:
            payment_id = int(message.text.split('_')[1])
            conn = get_db_connection()
            cursor = conn.cursor()
            cursor.execute("SELECT authority, status FROM payments WHERE payment_id = ?", (payment_id,))
            payment = cursor.fetchone()
            conn.close()

            if not payment:
                bot.send_message(message.chat.id, "Ø®Ø·Ø§: Ù¾Ø±Ø¯Ø§Ø®Øª Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.", reply_markup=main_markup)
                return

            if payment['status'] == 'success':
                bot.send_message(message.chat.id, "Ø§ÛŒÙ† Ù¾Ø±Ø¯Ø§Ø®Øª Ù‚Ø¨Ù„Ø§Ù‹ ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù‡ Ø§Ø³Øª.", reply_markup=main_markup)
                return

            # ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª
            success, response_message = verify_payment(payment_id, payment['authority'])
            bot.send_message(message.chat.id, response_message, reply_markup=main_markup)
        except Exception as e:
            print(f"Error in start handler: {e}")
            bot.send_message(message.chat.id, "Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾Ø±Ø¯Ø§Ø®Øª. Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.", reply_markup=main_markup)
    else:
        # Ù‡Ù†Ø¯Ù„Ø± Ø¹Ø§Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ /start
        bot.send_message(message.chat.id, "Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!", reply_markup=main_markup)

# Ù‡Ù†Ø¯Ù„Ø± Ø¯Ú©Ù…Ù‡ Ø§ÙØ²Ø§ÛŒØ´ Ø³Ú©Ù‡
@bot.message_handler(func=lambda message: message.text == "ğŸ’° Ø§ÙØ²Ø§ÛŒØ´ Ø³Ú©Ù‡")
def show_payment_options(message):
    user_id = message.from_user.id
    update_last_online(user_id)

    coins = get_user_coins(user_id)
    text = (
        f"ğŸ’° Ø´Ù…Ø§ <b>{coins}</b> Ø³Ú©Ù‡ Ø¯Ø± Ø­Ø³Ø§Ø¨ Ø®ÙˆØ¯ Ø¯Ø§Ø±ÛŒØ¯ ğŸ˜ƒ.\n"
        "Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€\n"
        "Ø±Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ§Ø¯ÛŒ Ø¬Ù‡Øª Ø¯Ø±ÛŒØ§ÙØª Ø³Ú©Ù‡ Ø¨ÛŒØ´ØªØ± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù‡. Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø§Ø² Ù„ÛŒØ³Øª Ø²ÛŒØ±ØŒ ÛŒÚ©ÛŒ Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒ! ğŸ˜‡\n"
        "1ï¸âƒ£ Ù…Ø¹Ø±ÙÛŒ Ø¯ÙˆØ³ØªØ§Ù† (Ø±Ø§ÛŒÚ¯Ø§Ù†):\n"
        "Ø¨Ø±Ø§ÛŒ Ø§ÙØ²Ø§ÛŒØ´ Ø³Ú©Ù‡ Ø¨Ù‡ ØµÙˆØ±Øª Ø±Ø§ÛŒÚ¯Ø§Ù† Ø¨Ù†Ø± Ù„ÛŒÙ†Ú©âš¡ï¸ Ù…Ø®ØµÙˆØµ Ø®ÙˆØ¯Øª (/link) Ø±Ùˆ Ø¨Ø±Ø§ÛŒ Ø¯ÙˆØ³ØªØ§Øª Ø¨ÙØ±Ø³Øª Ùˆ 20 Ø³Ú©Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†\n"
        "2ï¸âƒ£ Ø®Ø±ÛŒØ¯ Ø³Ú©Ù‡ Ø¨ØµÙˆØ±Øª Ø¢Ù†Ù„Ø§ÛŒÙ†:\n"
        "Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ø³Ú©Ù‡ ÛŒÚ©ÛŒ Ø§Ø² ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù…Ø§ÛŒÛŒØ¯ğŸ‘‡\n"
        "<b>ğŸ”° Ø¢Ù…ÙˆØ²Ø´ Ù…Ø±Ø­Ù„Ù‡ Ø¨Ù‡ Ù…Ø±Ø­Ù„Ù‡ Ø®Ø±ÛŒØ¯ Ø³Ú©Ù‡ ğŸ’°</b>"
    )
    bot.send_message(message.chat.id, text, parse_mode="HTML", reply_markup=create_payment_keyboard())

# Ø§ÛŒØ¬Ø§Ø¯ InlineKeyboard Ø¨Ø±Ø§ÛŒ ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§
def create_payment_keyboard():
    keyboard = types.InlineKeyboardMarkup(row_width=1)
    buttons = [
        types.InlineKeyboardButton("ğŸ’µ 110 Ø³Ú©Ù‡ - 44,000 ØªÙˆÙ…Ø§Ù†", callback_data="pay_44000_110"),
        types.InlineKeyboardButton("ğŸ’µ 250 Ø³Ú©Ù‡ - 71,000 ØªÙˆÙ…Ø§Ù†", callback_data="pay_71000_250"),
        types.InlineKeyboardButton("ğŸ’µ 480 Ø³Ú©Ù‡ - 97,000 ØªÙˆÙ…Ø§Ù†", callback_data="pay_97000_480"),
        types.InlineKeyboardButton("ğŸ’µ 1060 Ø³Ú©Ù‡ - 161,000 ØªÙˆÙ…Ø§Ù†", callback_data="pay_161000_1060"),
        types.InlineKeyboardButton("ğŸ’µ 2024 Ø³Ú©Ù‡ - 285,000 ØªÙˆÙ…Ø§Ù†", callback_data="pay_285000_2024"),
        types.InlineKeyboardButton("ğŸ”¥ Ø¨Ø³ØªÙ‡ ÙˆÛŒÚ˜Ù‡ 4,040 Ø³Ú©Ù‡ - 510,000 ØªÙˆÙ…Ø§Ù†", callback_data="pay_510000_4040"),
        types.InlineKeyboardButton("ğŸ Ù‡Ø¯ÛŒÙ‡ Ø¨Ù‡ Ø¯ÙˆØ³Øª", callback_data="pay_gift")
    ]
    keyboard.add(*buttons)
    return keyboard

# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ ØªØ¹Ø±ÙÙ‡
@bot.callback_query_handler(func=lambda call: call.data.startswith('pay_') and not call.data == 'pay_gift')
def handle_payment_selection(call):
    user_id = call.from_user.id
    update_last_online(user_id)

    amount, coins = map(int, call.data.split('_')[1:])
    payment_link = create_payment_link(user_id, amount, coins)
    if not payment_link:
        bot.send_message(user_id, "âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒÙ†Ú© Ù¾Ø±Ø¯Ø§Ø®Øª! Ù„Ø·ÙØ§Ù‹ Ø¨Ø¹Ø¯Ø§Ù‹ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.", reply_markup=main_markup)
        bot.answer_callback_query(call.id)
        return

    text = (
        f"Ù„ÛŒÙ†Ú© Ù¾Ø±Ø¯Ø§Ø®Øª Ø¢Ù†Ù„Ø§ÛŒÙ† <b>{coins} Ø³Ú©Ù‡</b> Ø¨Ù‡ Ù…Ø¨Ù„Øº <b>{amount:,} ØªÙˆÙ…Ø§Ù†</b> Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯ ğŸ‘‡\n"
        f"<a href='{payment_link}'>Ù¾Ø±Ø¯Ø§Ø®Øª Ø¢Ù†Ù„Ø§ÛŒÙ†</a>\n\n"
        "ÛŒÚ© Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\n"
        "â–ªï¸ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¢Ù†Ù„Ø§ÛŒÙ† (Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø² Ø·Ø±ÛŒÙ‚ Ø¯Ø±Ú¯Ø§Ù‡ Ø¨Ø§Ù†Ú©ÛŒ Ø´ØªØ§Ø¨ÛŒ Ø¨ØµÙˆØ±Øª Ú©Ø§Ù…Ù„Ø§ Ø§Ù…Ù† Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯.)\n"
        "â–«ï¸ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¢ÙÙ„Ø§ÛŒÙ† (Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø² Ø·Ø±ÛŒÙ‚ Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª ğŸ’³)\n"
        "âš ï¸ ØªÙˆØ¬Ù‡: Ù‡Ù†Ú¯Ø§Ù… Ù¾Ø±Ø¯Ø§Ø®Øª Ø¢Ù†Ù„Ø§ÛŒÙ† Ø­ØªÙ…Ø§ Ø¨Ø§ÛŒØ¯ ÙÛŒÙ„ØªØ±Ø´Ú©Ù† Ø®ÙˆØ¯ Ø±Ø§ Ø®Ø§Ù…ÙˆØ´ Ú©Ù†ÛŒØ¯ â—ï¸"
    )
    markup = types.InlineKeyboardMarkup(row_width=1)
    markup.add(
        types.InlineKeyboardButton("â–ªï¸ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¢Ù†Ù„Ø§ÛŒÙ†", url=payment_link),
        types.InlineKeyboardButton("â–«ï¸ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¢ÙÙ„Ø§ÛŒÙ†", callback_data=f"offline_payment_{amount}_{coins}"),
        types.InlineKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data="back_to_payment_options")
    )

    try:
        bot.edit_message_text(
            text,
            chat_id=user_id,
            message_id=call.message.message_id,
            parse_mode="HTML",
            reply_markup=markup
        )
    except telebot.apihelper.ApiTelegramException as e:
        print(f"Error editing message for user {user_id}: {e}")
        bot.send_message(user_id, text, parse_mode="HTML", reply_markup=markup)
    bot.answer_callback_query(call.id, f"Ù„ÛŒÙ†Ú© Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø±Ø§ÛŒ {coins} Ø³Ú©Ù‡ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯!")

# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¢ÙÙ„Ø§ÛŒÙ†
@bot.callback_query_handler(func=lambda call: call.data.startswith('offline_payment_'))
def handle_offline_payment(call):
    user_id = call.from_user.id
    update_last_online(user_id)
    amount, coins = map(int, call.data.split('_')[2:])

    text = (
        f"Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¢ÙÙ„Ø§ÛŒÙ† <b>{coins} Ø³Ú©Ù‡</b> Ø¨Ù‡ Ù…Ø¨Ù„Øº <b>{amount:,} ØªÙˆÙ…Ø§Ù†</b>:\n"
        "Ù„Ø·ÙØ§Ù‹ Ù…Ø¨Ù„Øº Ø±Ø§ Ø¨Ù‡ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ø²ÛŒØ± ÙˆØ§Ø±ÛŒØ² Ú©Ù†ÛŒØ¯ Ùˆ Ø±Ø³ÛŒØ¯ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:\n\n"
        "ğŸ§ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª: <YOUR_CARD_NUMBER>\n"
        "ğŸ¦ Ø¨Ø§Ù†Ú©: <YOUR_BANK_NAME>\n"
        "ğŸ‘¤ Ø¨Ù‡ Ù†Ø§Ù…: <YOUR_NAME>\n\n"
        "ğŸ“ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ: @chatoogram100\n"
        "âš ï¸ ØªÙˆØ¬Ù‡: Ù¾Ø³ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ Ø±Ø³ÛŒØ¯ØŒ Ø³Ú©Ù‡â€ŒÙ‡Ø§ Ø¨Ù‡ Ø­Ø³Ø§Ø¨ØªÙˆÙ† Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´Ù‡."
    )
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data="back_to_payment_options"))

    try:
        bot.edit_message_text(
            text,
            chat_id=user_id,
            message_id=call.message.message_id,
            parse_mode="HTML",
            reply_markup=markup
        )
    except telebot.apihelper.ApiTelegramException as e:
        print(f"Error editing message for user {user_id}: {e}")
        bot.send_message(user_id, text, parse_mode="HTML", reply_markup=markup)
    bot.answer_callback_query(call.id, "Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ø¢ÙÙ„Ø§ÛŒÙ† Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯!")

# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§
@bot.callback_query_handler(func=lambda call: call.data == 'back_to_payment_options')
def back_to_payment_options(call):
    user_id = call.from_user.id
    update_last_online(user_id)
    coins = get_user_coins(user_id)
    text = (
        f"ğŸ’° Ø´Ù…Ø§ <b>{coins}</b> Ø³Ú©Ù‡ Ø¯Ø± Ø­Ø³Ø§Ø¨ Ø®ÙˆØ¯ Ø¯Ø§Ø±ÛŒØ¯ ğŸ˜ƒ.\n"
        "Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€\n"
        "Ø±Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ§Ø¯ÛŒ Ø¬Ù‡Øª Ø¯Ø±ÛŒØ§ÙØª Ø³Ú©Ù‡ Ø¨ÛŒØ´ØªØ± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù‡. Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø§Ø² Ù„ÛŒØ³Øª Ø²ÛŒØ±ØŒ ÛŒÚ©ÛŒ Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒ! ğŸ˜‡\n"
        "1ï¸âƒ£ Ù…Ø¹Ø±ÙÛŒ Ø¯ÙˆØ³ØªØ§Ù† (Ø±Ø§ÛŒÚ¯Ø§Ù†):\n"
        "Ø¨Ø±Ø§ÛŒ Ø§ÙØ²Ø§ÛŒØ´ Ø³Ú©Ù‡ Ø¨Ù‡ ØµÙˆØ±Øª Ø±Ø§ÛŒÚ¯Ø§Ù† Ø¨Ù†Ø± Ù„ÛŒÙ†Ú©âš¡ï¸ Ù…Ø®ØµÙˆØµ Ø®ÙˆØ¯Øª (/link) Ø±Ùˆ Ø¨Ø±Ø§ÛŒ Ø¯ÙˆØ³ØªØ§Øª Ø¨ÙØ±Ø³Øª Ùˆ 20 Ø³Ú©Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†\n"
        "2ï¸âƒ£ Ø®Ø±ÛŒØ¯ Ø³Ú©Ù‡ Ø¨ØµÙˆØ±Øª Ø¢Ù†Ù„Ø§ÛŒÙ†:\n"
        "Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ø³Ú©Ù‡ ÛŒÚ©ÛŒ Ø§Ø² ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù…Ø§ÛŒÛŒØ¯ğŸ‘‡\n"
        "<b>ğŸ”° Ø¢Ù…ÙˆØ²Ø´ Ù…Ø±Ø­Ù„Ù‡ Ø¨Ù‡ Ù…Ø±Ø­Ù„Ù‡ Ø®Ø±ÛŒØ¯ Ø³Ú©Ù‡ ğŸ’°</b>"
    )
    try:
        bot.edit_message_text(
            text,
            chat_id=user_id,
            message_id=call.message.message_id,
            parse_mode="HTML",
            reply_markup=create_payment_keyboard()
        )
    except telebot.apihelper.ApiTelegramException as e:
        print(f"Error editing message for user {user_id}: {e}")
        bot.send_message(user_id, text, parse_mode="HTML", reply_markup=create_payment_keyboard())
    bot.answer_callback_query(call.id, "Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ÙØ²Ø§ÛŒØ´ Ø³Ú©Ù‡")
# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ Ù‡Ø¯ÛŒÙ‡ Ø¨Ù‡ Ø¯ÙˆØ³Øª (ÙØ¹Ù„Ø§Ù‹ placeholder)
@bot.callback_query_handler(func=lambda call: call.data == 'pay_gift')
def handle_gift_payment(call):
    user_id = call.from_user.id
    update_last_online(user_id)
    bot.send_message(user_id, "ğŸ Ø§ÛŒÙ† Ù‚Ø§Ø¨Ù„ÛŒØª Ù‡Ù†ÙˆØ² Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù†Ø´Ø¯Ù‡! Ø¨Ù‡â€ŒØ²ÙˆØ¯ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´Ù‡ ğŸ˜Š", reply_markup=main_markup)
    bot.answer_callback_query(call.id)


# Ø¯ÛŒÚ©Ø´Ù†Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ Ùˆ ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ
search_results = defaultdict(list)
current_page = defaultdict(int)


# ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ ÙØ§ØµÙ„Ù‡ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ Ø¨Ø§ ÙØ±Ù…ÙˆÙ„ Haversine
def haversine_distance(lat1, lon1, lat2, lon2):
    R = 6371  # Ø´Ø¹Ø§Ø¹ Ø²Ù…ÛŒÙ† (Ú©ÛŒÙ„ÙˆÙ…ØªØ±)
    lat1, lon1, lat2, lon2 = map(math.radians, [lat1, lon1, lat2, lon2])
    dlat = lat2 - lat1
    dlon = lon2 - lon1
    a = math.sin(dlat / 2) ** 2 + math.cos(lat1) * math.cos(lat2) * math.sin(dlon / 2) ** 2
    c = 2 * math.asin(math.sqrt(a))
    return R * c


# ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¯Ø± ÛŒÚ© ØµÙØ­Ù‡ Ø®Ø§Øµ
def display_users_page(user_id, search_type, page=1):
    users = search_results[user_id]
    if not users:
        bot.send_message(user_id, "Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!", reply_markup=main_markup)
        return

    users_per_page = 10
    start_idx = (page - 1) * users_per_page
    end_idx = start_idx + users_per_page
    page_users = users[start_idx:end_idx]

    if not page_users:
        bot.send_message(user_id, "ØµÙØ­Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!", reply_markup=main_markup)
        return

    message_text = "ğŸŒ Ù„ÛŒØ³Øª Ø§ÙØ±Ø§Ø¯ Ø¬Ø³ØªØ¬Ùˆ Ø´Ø¯Ù‡:\n\n"
    for user in page_users:
        name, age, province, unique_id, last_online = user[:5]
        gender_display = "ğŸ‘¨â€ğŸ¦°" if user[5] == 'male' else "ğŸ‘©"
        province_display = province if province else "Ù†Ø§Ù…Ø´Ø®Øµ"
        age_display = age if age else "Ù†Ø§Ù…Ø´Ø®Øµ"
        message_text += f"{gender_display} Ù†Ø§Ù…â€Œ: {name} (Ø³Ù†: {age_display})\n"
        message_text += f"Ø§Ø³ØªØ§Ù†:â€Œ {province_display}\n"
        message_text += f"{format_last_online(last_online)}\n"
        message_text += f"ğŸ†” : /user_{unique_id}\n"
        message_text += "ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸\n"

    markup = types.InlineKeyboardMarkup(row_width=2)
    if end_idx < len(users):
        markup.add(
            types.InlineKeyboardButton("ØµÙØ­Ù‡ Ø¨Ø¹Ø¯ÛŒ", callback_data=f'next_page_{search_type}_{page + 1}')
        )
    markup.add(
        types.InlineKeyboardButton("Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø¬Ø³ØªØ¬Ùˆ", callback_data='back_to_search_menu')
    )

    try:
        bot.send_message(user_id, message_text, reply_markup=markup)
    except telebot.apihelper.ApiTelegramException as e:
        print(f"Error sending message to user {user_id}: {e}")
        bot.send_message(user_id, message_text, reply_markup=main_markup)


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
@bot.message_handler(func=lambda message: message.text == "ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ğŸ”")
def user_search(message):
    user_id = message.from_user.id
    update_last_online(user_id)
    markup = types.InlineKeyboardMarkup(row_width=2)
    markup.add(
        types.InlineKeyboardButton("Ù‡Ù… Ø§Ø³ØªØ§Ù†ÛŒâ€ŒÙ‡Ø§ ğŸŒ", callback_data='search_same_province'),
        types.InlineKeyboardButton("Ù‡Ù… Ø³Ù†â€ŒÙ‡Ø§ ğŸ‘¥", callback_data='search_same_age')
    )
    markup.add(
        types.InlineKeyboardButton("ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ ğŸ”", callback_data='search_advanced'),
        types.InlineKeyboardButton("Ø¨Ø¯ÙˆÙ† Ú†Øªâ€ŒÙ‡Ø§ ğŸš¶â€â™€ï¸â€â¡ï¸", callback_data='search_no_chat')
    )
    markup.add(
        types.InlineKeyboardButton("Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¬Ø¯ÛŒØ¯ ğŸ™‹â€â™€ï¸", callback_data='search_new_users'),
        types.InlineKeyboardButton("Ø§ÙØ±Ø§Ø¯ Ù†Ø²Ø¯ÛŒÚ© ğŸ“", callback_data='search_nearby')
    )
    bot.send_message(
        user_id,
        "Ú©ÛŒÙˆ Ù¾ÛŒØ¯Ø§ Ú©Ù†Ù… Ø¨Ø±Ø§ØªØŸ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ğŸ‘‡",
        reply_markup=markup
    )


search_results = defaultdict(list)
current_page = defaultdict(int)


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡
@bot.callback_query_handler(func=lambda call: call.data == "search_advanced")
def special_search(message):
    user_id = message.from_user.id
    update_last_online(user_id)  # Ø¢Ù¾Ø¯ÛŒØª Ø²Ù…Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†
    markup = types.InlineKeyboardMarkup(row_width=2)
    markup.add(
        types.InlineKeyboardButton("ÙÙ‚Ø· Ù¾Ø³Ø± Ø¨Ø§Ø´Ù‡ ğŸ‘±â€â™‚ï¸", callback_data='special_search_male'),
        types.InlineKeyboardButton("ÙÙ‚Ø· Ø¯Ø®ØªØ± Ø¨Ø§Ø´Ù‡ ğŸ‘±â€â™€ï¸", callback_data='special_search_female')
    )
    markup.add(
        types.InlineKeyboardButton("Ù‡Ù…Ù‡ Ø±Ùˆ Ù†Ø´ÙˆÙ† Ø¨Ø¯Ù‡ ğŸ§‘â€ğŸ¤â€ğŸ§‘", callback_data='special_search_all')
    )
    bot.send_message(
        user_id,
        """Ú†Ù‡ Ú©Ø³Ø§ÛŒÛŒ Ø±Ùˆ Ø§Ø² Ù„ÛŒØ³Øª ğŸ—¨ Ø¬Ø³ØªØ¬ÙˆÛŒ ÙˆÛŒÚ˜Ù‡â€Œ ğŸ—¨ Ù†Ø´ÙˆÙ†Øª Ø¨Ø¯Ù…ØŸ
Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ğŸ‘‡""",
        reply_markup=markup
    )


# ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¯Ø± ÛŒÚ© ØµÙØ­Ù‡ Ø®Ø§Øµ
def display_users_page(user_id, search_type, page=1):
    # Ú¯Ø±ÙØªÙ† Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ Ø§Ø² Ø¯ÛŒÚ©Ø´Ù†Ø±ÛŒ
    users = search_results[user_id]
    if not users:
        bot.send_message(user_id, "Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø± Ø¢Ù†Ù„Ø§ÛŒÙ†ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!", reply_markup=main_markup)
        return

    # ØªÙ†Ø¸ÛŒÙ… Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø±Ø§ÛŒ ØµÙØ­Ù‡ ÙØ¹Ù„ÛŒ
    users_per_page = 10
    start_idx = (page - 1) * users_per_page
    end_idx = start_idx + users_per_page
    page_users = users[start_idx:end_idx]

    if not page_users:
        bot.send_message(user_id, "ØµÙØ­Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!", reply_markup=main_markup)
        return

    # Ø³Ø§Ø®Øª Ù…ØªÙ† Ø®Ø±ÙˆØ¬ÛŒ
    message_text = "ğŸŒ Ù„ÛŒØ³Øª Ø§ÙØ±Ø§Ø¯ Ø¬Ø³Øª Ùˆ Ø¬Ùˆ Ø´Ø¯Ù‡ Ø´Ù…Ø§ Ú©Ù‡ Ø¯Ø± Û³ Ø±ÙˆØ² Ø§Ø®ÛŒØ± Ø¢Ù†Ù„Ø§ÛŒÙ† Ø¨ÙˆØ¯Ù‡ Ø§Ù†Ø¯.\n\n"
    for user in page_users:
        name, gender, age, province, city, unique_id, last_online = user
        gender_display = "ğŸ‘¨â€ğŸ¦°" if gender == 'male' else "ğŸ‘©"
        province_display = province if province else "Ù†Ø§Ù…Ø´Ø®Øµ"
        city_display = city if city else "Ù†Ø§Ù…Ø´Ø®Øµ"
        age_display = age if age else "Ù†Ø§Ù…Ø´Ø®Øµ"
        message_text += f"{gender_display} Ù†Ø§Ù…â€Œ: {name} (Ø³Ù†: {age_display})\n"
        message_text += f"Ø§Ø³ØªØ§Ù†:â€Œ {province_display} ({city_display})\n"
        message_text += f"{format_last_online(last_online)}\n"
        message_text += f"ğŸ†” : /user_{unique_id}\n"
        message_text += "ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸\n"

    # Ø³Ø§Ø®Øª Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø§ÛŒÙ†Ù„Ø§ÛŒÙ†
    markup = types.InlineKeyboardMarkup(row_width=2)
    if end_idx < len(users):
        markup.add(
            types.InlineKeyboardButton("ØµÙØ­Ù‡ Ø¨Ø¹Ø¯ÛŒ", callback_data=f'next_page_{search_type}_{page + 1}')
        )
    markup.add(
        types.InlineKeyboardButton("Ù†Ù…Ø§ÛŒØ´ Ú©Ø´ÙˆÛŒÛŒ", callback_data=f'slider_view_{search_type}')
    )

    # Ø§Ø±Ø³Ø§Ù„ ÛŒØ§ ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…
    try:
        bot.send_message(user_id, message_text, reply_markup=markup)
    except telebot.apihelper.ApiTelegramException as e:
        print(f"Error sending message to user {user_id}: {e}")
        bot.send_message(user_id, message_text, reply_markup=main_markup)


# Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ ÙˆÛŒÚ˜Ù‡
@bot.callback_query_handler(
    func=lambda call: call.data in ['special_search_male', 'special_search_female',
                                    'special_search_all'] or call.data.startswith('next_page_'))
def handle_special_search(call):
    user_id = call.from_user.id
    update_last_online(user_id)  # Ø¢Ù¾Ø¯ÛŒØª Ø²Ù…Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†
    search_type = call.data.split('_')[2] if call.data.startswith('next_page_') else call.data
    page = int(call.data.split('_')[3]) if call.data.startswith('next_page_') else 1

    # Ø§Ú¯Ø± Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¬Ø¯ÛŒØ¯Ù‡ØŒ Ù†ØªØ§ÛŒØ¬ Ø±Ùˆ Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¨Ú¯ÛŒØ±ÛŒÙ…
    if not call.data.startswith('next_page_'):
        now = datetime.now()
        three_days_ago = now - timedelta(days=3)

        cursor = conn.cursor()
        if search_type == 'special_search_male':
            cursor.execute(
                """
                SELECT name, gender, age, province, city, unique_id, last_online 
                FROM users 
                WHERE gender = 'male' AND last_online >= ? AND user_id != ?
                """,
                (three_days_ago.strftime('%Y-%m-%d %H:%M:%S'), user_id)
            )
        elif search_type == 'special_search_female':
            cursor.execute(
                """
                SELECT name, gender, age, province, city, unique_id, last_online 
                FROM users 
                WHERE gender = 'female' AND last_online >= ? AND user_id != ?
                """,
                (three_days_ago.strftime('%Y-%m-%d %H:%M:%S'), user_id)
            )
        else:  # special_search_all
            cursor.execute(
                """
                SELECT name, gender, age, province, city, unique_id, last_online 
                FROM users 
                WHERE last_online >= ? AND user_id != ?
                """,
                (three_days_ago.strftime('%Y-%m-%d %H:%M:%S'), user_id)
            )

        # Ø°Ø®ÛŒØ±Ù‡ Ù†ØªØ§ÛŒØ¬ Ø¯Ø± Ø¯ÛŒÚ©Ø´Ù†Ø±ÛŒ
        search_results[user_id] = cursor.fetchall()
        cursor.close()
        current_page[user_id] = 1
    else:
        current_page[user_id] = page

    # Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ØµÙØ­Ù‡ ÙØ¹Ù„ÛŒ
    display_users_page(user_id, search_type, current_page[user_id])
    bot.answer_callback_query(call.id, f"ØµÙØ­Ù‡ {current_page[user_id]} Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯!")


# -----------------------------------------------------------------------------------------
# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ callback queryÙ‡Ø§ÛŒ Ø¬Ø³ØªØ¬Ùˆ
@bot.callback_query_handler(
    func=lambda call: call.data in [
        'search_same_province', 'search_same_age', 'search_advanced',
        'search_no_chat', 'search_new_users', 'search_nearby',
        'back_to_search_menu'
    ] or call.data.startswith('next_page_'))
def handle_user_search(call):
    user_id = call.from_user.id
    update_last_online(user_id)

    if call.data == 'back_to_search_menu':
        markup = types.InlineKeyboardMarkup(row_width=2)
        markup.add(
            types.InlineKeyboardButton("Ù‡Ù… Ø§Ø³ØªØ§Ù†ÛŒâ€ŒÙ‡Ø§ ğŸŒ", callback_data='search_same_province'),
            types.InlineKeyboardButton("Ù‡Ù… Ø³Ù†â€ŒÙ‡Ø§ ğŸ‘¥", callback_data='search_same_age')
        )
        markup.add(
            types.InlineKeyboardButton("ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ ğŸ”", callback_data='search_advanced'),
            types.InlineKeyboardButton("Ø¨Ø¯ÙˆÙ† Ú†Øªâ€ŒÙ‡Ø§ ğŸš¶â€â™€ï¸â€â¡ï¸", callback_data='search_no_chat')
        )
        markup.add(

            types.InlineKeyboardButton("Ø§ÙØ±Ø§Ø¯ Ù†Ø²Ø¯ÛŒÚ© ğŸ“", callback_data='search_nearby')
        )
        bot.edit_message_text(
            "Ú©ÛŒÙˆ Ù¾ÛŒØ¯Ø§ Ú©Ù†Ù… Ø¨Ø±Ø§ØªØŸ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ğŸ‘‡",
            chat_id=user_id,
            message_id=call.message.message_id,
            reply_markup=markup
        )
        bot.answer_callback_query(call.id)
        return

    search_type = call.data.split('_')[2] if call.data.startswith('next_page_') else call.data
    page = int(call.data.split('_')[3]) if call.data.startswith('next_page_') else 1

    if not call.data.startswith('next_page_'):
        now = datetime.now()
        three_days_ago = now - timedelta(days=3)
        cursor = conn.cursor()

        # Ú¯Ø±ÙØªÙ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø§ÛŒØ³Ù‡
        cursor.execute("SELECT province, age, latitude, longitude FROM users WHERE user_id = ?", (user_id,))
        user_data = cursor.fetchone()
        if not user_data:
            bot.send_message(user_id, "Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ ÛŒØ§ÙØª Ù†Ø´Ø¯!", reply_markup=main_markup)
            cursor.close()
            return
        user_province, user_age, user_lat, user_lon = user_data

        # ØªØ¹Ø±ÛŒÙ Ú©ÙˆØ¦Ø±ÛŒâ€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù†ÙˆØ¹ Ø¬Ø³ØªØ¬Ùˆ
        if search_type == 'search_same_province':
            cursor.execute(
                """
                SELECT name, gender, age, province, city, unique_id, last_online 
                FROM users 
                WHERE province = ? AND last_online >= ? AND user_id != ?
                """,
                (user_province, three_days_ago.strftime('%Y-%m-%d %H:%M:%S'), user_id)
            )
        elif search_type == 'search_same_age':
            cursor.execute(
                """
                SELECT name, gender, age, province, city, unique_id, last_online 
                FROM users 
                WHERE age = ? AND last_online >= ? AND user_id != ?
                """,
                (user_age, three_days_ago.strftime('%Y-%m-%d %H:%M:%S'), user_id)
            )
        elif search_type == 'search_no_chat':
            cursor.execute(
                """
                SELECT name, gender, age, province, city, unique_id, last_online 
                FROM users 
                WHERE status = 'idle' AND last_online >= ? AND user_id != ?
                """,
                (three_days_ago.strftime('%Y-%m-%d %H:%M:%S'), user_id)
            )
        elif search_type == 'search_new_users':
            cursor.execute(
                """
                SELECT name, gender, age, province, city, unique_id, last_online 
                FROM users 
                WHERE last_online >= ? AND user_id != ?
                ORDER BY created_at DESC
                """,
                (three_days_ago.strftime('%Y-%m-%d %H:%M:%S'), user_id)
            )
        elif search_type == 'search_nearby':
            cursor.execute(
                """
                SELECT name, gender, age, province, city, unique_id, last_online, latitude, longitude 
                FROM users 
                WHERE last_online >= ? AND user_id != ? AND latitude IS NOT NULL AND longitude IS NOT NULL
                """,
                (three_days_ago.strftime('%Y-%m-%d %H:%M:%S'), user_id)
            )
            users = cursor.fetchall()
            if user_lat is None or user_lon is None:
                bot.send_message(user_id, "Ù…ÙˆÙ‚Ø¹ÛŒØª Ø´Ù…Ø§ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª!", reply_markup=main_markup)
                cursor.close()
                return
            # Ù…Ø­Ø§Ø³Ø¨Ù‡ ÙØ§ØµÙ„Ù‡ Ùˆ Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ
            users_with_distance = [
                (name, gender, age, province, city, unique_id, last_online,
                 haversine_distance(user_lat, user_lon, lat, lon))
                for name, gender, age, province, city, unique_id, last_online, lat, lon in users
            ]
            users_with_distance.sort(key=lambda x: x[7])  # Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙØ§ØµÙ„Ù‡
            search_results[user_id] = [(name, gender, age, province, city, unique_id, last_online) for
                                       name, gender, age, province, city, unique_id, last_online, _ in
                                       users_with_distance]
        elif search_type == 'search_advanced':
            bot.send_message(user_id, "Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ù‡Ù†ÙˆØ² Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª!", reply_markup=main_markup)
            cursor.close()
            bot.answer_callback_query(call.id, "Ø§ÛŒÙ† Ù‚Ø§Ø¨Ù„ÛŒØª Ø¨Ø¹Ø¯Ø§Ù‹ Ø§Ø¶Ø§ÙÙ‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯!")
            return

        if search_type != 'search_nearby':
            search_results[user_id] = cursor.fetchall()
        cursor.close()
        current_page[user_id] = 1

    display_users_page(user_id, search_type, current_page[user_id])
    bot.answer_callback_query(call.id, f"ØµÙØ­Ù‡ {current_page[user_id]} Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯!")


# Ú©ÛŒØ¨ÙˆØ±Ø¯ Ú†Øª
chat_markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
chat_markup.add("Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ø®Ø§Ø·Ø¨ ğŸ‘€")
chat_markup.add("ÙØ¹Ø§Ù„ Ø³Ø§Ø²ÛŒ Ú†Øª Ø®ØµÙˆØµÛŒ ğŸ”â€Œ")
chat_markup.add("Ù¾Ø§ÛŒØ§Ù† Ú†Øª âŒ")

try:
    cursor.execute("ALTER TABLE users ADD COLUMN private_chat_enabled INTEGER DEFAULT 0")
    conn.commit()
except sqlite3.OperationalError:
    # Ø§Ú¯Ù‡ Ø³ØªÙˆÙ† Ù‚Ø¨Ù„Ø§Ù‹ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù‡ØŒ Ø®Ø·Ø§ Ø±Ùˆ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ø¨Ú¯ÛŒØ±
    pass

BOT_USERNAME = "@testdeletebot0039_bot"
# Ø¯ÛŒÚ©Ø´Ù†Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ Ùˆ ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ
search_results = defaultdict(list)
current_page = defaultdict(int)


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ ÙˆÛŒÚ˜Ù‡
@bot.message_handler(func=lambda message: message.text == "ğŸ—¨ Ø¬Ø³ØªØ¬ÙˆÛŒ ÙˆÛŒÚ˜Ù‡â€Œ ğŸ—¨")
def special_search(message):
    user_id = message.from_user.id
    update_last_online(user_id)  # Ø¢Ù¾Ø¯ÛŒØª Ø²Ù…Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†
    markup = types.InlineKeyboardMarkup(row_width=2)
    markup.add(
        types.InlineKeyboardButton("ÙÙ‚Ø· Ù¾Ø³Ø± Ø¨Ø§Ø´Ù‡ ğŸ‘±â€â™‚ï¸", callback_data='special_search_male'),
        types.InlineKeyboardButton("ÙÙ‚Ø· Ø¯Ø®ØªØ± Ø¨Ø§Ø´Ù‡ ğŸ‘±â€â™€ï¸", callback_data='special_search_female')
    )
    markup.add(
        types.InlineKeyboardButton("Ù‡Ù…Ù‡ Ø±Ùˆ Ù†Ø´ÙˆÙ† Ø¨Ø¯Ù‡ ğŸ§‘â€ğŸ¤â€ğŸ§‘", callback_data='special_search_all')
    )
    bot.send_message(
        user_id,
        """Ú†Ù‡ Ú©Ø³Ø§ÛŒÛŒ Ø±Ùˆ Ø§Ø² Ù„ÛŒØ³Øª ğŸ—¨ Ø¬Ø³ØªØ¬ÙˆÛŒ ÙˆÛŒÚ˜Ù‡â€Œ ğŸ—¨ Ù†Ø´ÙˆÙ†Øª Ø¨Ø¯Ù…ØŸ
Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ğŸ‘‡""",
        reply_markup=markup
    )


# ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¯Ø± ÛŒÚ© ØµÙØ­Ù‡ Ø®Ø§Øµ
def display_users_page(user_id, search_type, page=1):
    # Ú¯Ø±ÙØªÙ† Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ Ø§Ø² Ø¯ÛŒÚ©Ø´Ù†Ø±ÛŒ
    users = search_results[user_id]
    if not users:
        bot.send_message(user_id, "Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø± Ø¢Ù†Ù„Ø§ÛŒÙ†ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!", reply_markup=main_markup)
        return

    # ØªÙ†Ø¸ÛŒÙ… Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø±Ø§ÛŒ ØµÙØ­Ù‡ ÙØ¹Ù„ÛŒ
    users_per_page = 10
    start_idx = (page - 1) * users_per_page
    end_idx = start_idx + users_per_page
    page_users = users[start_idx:end_idx]

    if not page_users:
        bot.send_message(user_id, "ØµÙØ­Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!", reply_markup=main_markup)
        return

    # Ø³Ø§Ø®Øª Ù…ØªÙ† Ø®Ø±ÙˆØ¬ÛŒ
    message_text = "ğŸŒ Ù„ÛŒØ³Øª Ø§ÙØ±Ø§Ø¯ Ø¬Ø³Øª Ùˆ Ø¬Ùˆ Ø´Ø¯Ù‡ Ø´Ù…Ø§ Ú©Ù‡ Ø¯Ø± Û³ Ø±ÙˆØ² Ø§Ø®ÛŒØ± Ø¢Ù†Ù„Ø§ÛŒÙ† Ø¨ÙˆØ¯Ù‡ Ø§Ù†Ø¯.\n\n"
    for user in page_users:
        name, gender, age, province, city, unique_id, last_online = user
        gender_display = "ğŸ‘¨â€ğŸ¦°" if gender == 'male' else "ğŸ‘©"
        province_display = province if province else "Ù†Ø§Ù…Ø´Ø®Øµ"
        city_display = city if city else "Ù†Ø§Ù…Ø´Ø®Øµ"
        age_display = age if age else "Ù†Ø§Ù…Ø´Ø®Øµ"
        message_text += f"{gender_display} Ù†Ø§Ù…â€Œ: {name} (Ø³Ù†: {age_display})\n"
        message_text += f"Ø§Ø³ØªØ§Ù†:â€Œ {province_display} ({city_display})\n"
        message_text += f"{format_last_online(last_online)}\n"
        message_text += f"ğŸ†” : /user_{unique_id}\n"
        message_text += "ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸\n"

    # Ø³Ø§Ø®Øª Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø§ÛŒÙ†Ù„Ø§ÛŒÙ†
    markup = types.InlineKeyboardMarkup(row_width=2)
    if end_idx < len(users):
        markup.add(
            types.InlineKeyboardButton("ØµÙØ­Ù‡ Ø¨Ø¹Ø¯ÛŒ", callback_data=f'next_page_{search_type}_{page + 1}')
        )
    markup.add(
        types.InlineKeyboardButton("Ù†Ù…Ø§ÛŒØ´ Ú©Ø´ÙˆÛŒÛŒ", callback_data=f'slider_view_{search_type}')
    )

    # Ø§Ø±Ø³Ø§Ù„ ÛŒØ§ ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…
    try:
        bot.send_message(user_id, message_text, reply_markup=markup)
    except telebot.apihelper.ApiTelegramException as e:
        print(f"Error sending message to user {user_id}: {e}")
        bot.send_message(user_id, message_text, reply_markup=main_markup)


# Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ ÙˆÛŒÚ˜Ù‡
@bot.callback_query_handler(
    func=lambda call: call.data in ['special_search_male', 'special_search_female',
                                    'special_search_all'] or call.data.startswith('next_page_'))
def handle_special_search(call):
    user_id = call.from_user.id
    update_last_online(user_id)  # Ø¢Ù¾Ø¯ÛŒØª Ø²Ù…Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†
    search_type = call.data.split('_')[2] if call.data.startswith('next_page_') else call.data
    page = int(call.data.split('_')[3]) if call.data.startswith('next_page_') else 1

    # Ø§Ú¯Ø± Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¬Ø¯ÛŒØ¯Ù‡ØŒ Ù†ØªØ§ÛŒØ¬ Ø±Ùˆ Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¨Ú¯ÛŒØ±ÛŒÙ…
    if not call.data.startswith('next_page_'):
        now = datetime.now()
        three_days_ago = now - timedelta(days=3)

        cursor = conn.cursor()
        if search_type == 'special_search_male':
            cursor.execute(
                """
                SELECT name, gender, age, province, city, unique_id, last_online 
                FROM users 
                WHERE gender = 'male' AND last_online >= ? AND user_id != ?
                """,
                (three_days_ago.strftime('%Y-%m-%d %H:%M:%S'), user_id)
            )
        elif search_type == 'special_search_female':
            cursor.execute(
                """
                SELECT name, gender, age, province, city, unique_id, last_online 
                FROM users 
                WHERE gender = 'female' AND last_online >= ? AND user_id != ?
                """,
                (three_days_ago.strftime('%Y-%m-%d %H:%M:%S'), user_id)
            )
        else:  # special_search_all
            cursor.execute(
                """
                SELECT name, gender, age, province, city, unique_id, last_online 
                FROM users 
                WHERE last_online >= ? AND user_id != ?
                """,
                (three_days_ago.strftime('%Y-%m-%d %H:%M:%S'), user_id)
            )

        # Ø°Ø®ÛŒØ±Ù‡ Ù†ØªØ§ÛŒØ¬ Ø¯Ø± Ø¯ÛŒÚ©Ø´Ù†Ø±ÛŒ
        search_results[user_id] = cursor.fetchall()
        cursor.close()
        current_page[user_id] = 1
    else:
        current_page[user_id] = page

    # Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ØµÙØ­Ù‡ ÙØ¹Ù„ÛŒ
    display_users_page(user_id, search_type, current_page[user_id])
    bot.answer_callback_query(call.id, f"ØµÙØ­Ù‡ {current_page[user_id]} Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯!")


# Ú©Ø´ÙˆÛŒÛŒ Ø±Ùˆ Ø§Ø² Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø±Ø¯Ø§Ø´ØªÙ…


# ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª Ø§ÛŒÙ†Ù„Ø§ÛŒÙ† Ú©ÛŒØ¨ÙˆØ±Ø¯ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
def get_profile_inline_keyboard(user_id):
    cursor.execute("SELECT private_chat_enabled FROM users WHERE user_id = ?", (user_id,))
    result = cursor.fetchone()
    private_chat_enabled = result[0] if result else 0

    markup = types.InlineKeyboardMarkup(row_width=2)
    markup.add(
        types.InlineKeyboardButton("âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„", callback_data='edit_profile'),
        types.InlineKeyboardButton("ğŸ–Šï¸ ØªØºÛŒÛŒØ± ÛŒÙˆØ²Ø±Ù†ÛŒÙ…", callback_data='change_username')
    )
    markup.add(
        types.InlineKeyboardButton("âœ… Ù„Ø§ÛŒÚ© (ÙØ¹Ø§Ù„)", callback_data='like_profile'),
        types.InlineKeyboardButton("â¤ï¸ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù„Ø§ÛŒÚ© Ú©Ù†Ù†Ø¯Ù‡ Ù‡Ø§", callback_data='view_likers')
    )
    markup.add(
        types.InlineKeyboardButton("ğŸ§‘â€ğŸ¤â€ğŸ§‘ Ú¯ÙØª Ùˆ Ú¯Ùˆ Ù‡Ø§ÛŒ Ø§Ø®ÛŒØ±", callback_data='recent_chats'),
        types.InlineKeyboardButton("ğŸš« Ø¨Ù„Ø§Ú© Ù„ÛŒØ³Øª â—", callback_data='block_list')
    )
    markup.add(
        types.InlineKeyboardButton("ğŸ“ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ", callback_data='location'),
        types.InlineKeyboardButton("ğŸ§â€â™‚ï¸ğŸ§â€â™€ï¸ Ø¯ÙˆØ³ØªØ§Ù†", callback_data='friends')
    )

    private_chat_text = "ğŸ”’ Ú†Øª Ø®ØµÙˆØµÛŒ (ÙØ¹Ø§Ù„ âœ…)" if private_chat_enabled else "ğŸ”’ Ú†Øª Ø®ØµÙˆØµÛŒ (ØºÛŒØ±ÙØ¹Ø§Ù„ âŒ)"
    markup.row(types.InlineKeyboardButton(private_chat_text, callback_data='private_chat_toggle'))
    markup.add(
        types.InlineKeyboardButton("âŒ Ø¯ÛŒÙ„ÛŒØª Ø§Ú©Ø§Ù†Øª", callback_data='delete_account')
    )
    return markup


def register_block_partner_handler(bot, conn):
    @bot.callback_query_handler(func=lambda call: call.data.startswith('block_partner_'))
    def block_partner(call):
        user_id = call.from_user.id
        partner_id = int(call.data.split('_')[-1])
        bot.answer_callback_query(call.id, "Ú©Ø§Ø±Ø¨Ø± Ø¨Ù„Ø§Ú© Ø´Ø¯!")

        cursor = conn.cursor()
        # Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ú©Ø§Ø±Ø¨Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ø¨Ù„Ø§Ú© Ø´Ø¯Ù‡
        cursor.execute('''
            SELECT 1 FROM block WHERE blocker_id = ? AND blocked_id = ?
        ''', (user_id, partner_id))
        already_blocked = cursor.fetchone()

        if already_blocked:
            bot.send_message(call.message.chat.id, "Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ø¨Ù„Ø§Ú© Ø´Ø¯Ù‡ Ø§Ø³Øª!")
            cursor.close()
            return

        # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ Ø¬Ø¯ÙˆÙ„ block
        cursor.execute('''
            INSERT INTO block (blocker_id, blocked_id) VALUES (?, ?)
        ''', (user_id, partner_id))
        # Ø­Ø°Ù Ø±Ø§Ø¨Ø·Ù‡ ÙØ§Ù„Ùˆ/ÙØ§Ù„ÙˆØ¦Ø± Ø§Ú¯Ù‡ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù‡
        cursor.execute('''
            DELETE FROM follow WHERE (follower_id = ? AND followed_id = ?) OR (follower_id = ? AND followed_id = ?)
        ''', (user_id, partner_id, partner_id, user_id))
        # Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ¹Ø¯Ø§Ø¯ ÙØ§Ù„ÙˆØ¦Ø±Ù‡Ø§ Ùˆ ÙØ§Ù„ÙˆÙˆÛŒÙ†Ú¯â€ŒÙ‡Ø§
        cursor.execute('''
            UPDATE users SET following_count = following_count - 1 WHERE user_id = ? AND following_count > 0
        ''', (user_id,))
        cursor.execute('''
            UPDATE users SET followers_count = followers_count - 1 WHERE user_id = ? AND followers_count > 0
        ''', (user_id,))
        cursor.execute('''
            UPDATE users SET following_count = following_count - 1 WHERE user_id = ? AND following_count > 0
        ''', (partner_id,))
        cursor.execute('''
            UPDATE users SET followers_count = followers_count - 1 WHERE user_id = ? AND followers_count > 0
        ''', (partner_id,))
        conn.commit()
        cursor.close()


def register_block_list_handler(bot, conn):
    @bot.callback_query_handler(func=lambda call: call.data == 'block_list')
    def handle_block_list_query(call):
        user_id = call.from_user.id
        bot.answer_callback_query(call.id)

        cursor = conn.cursor()
        cursor.execute('''
            SELECT u.user_id, u.unique_id
            FROM users u
            JOIN block b ON u.user_id = b.blocked_id
            WHERE b.blocker_id = ?
        ''', (user_id,))

        blocked_users = cursor.fetchall()
        cursor.close()

        if not blocked_users:
            bot.send_message(call.message.chat.id, "Ø´Ù…Ø§ Ù‡Ù†ÙˆØ² Ú©Ø³ÛŒ Ø±Ùˆ Ø¨Ù„Ø§Ú© Ù†Ú©Ø±Ø¯ÛŒØ¯!", )
            return

        message = "Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ù„Ø§Ú©â€ŒØ´Ø¯Ù‡:\n"
        for user in blocked_users:
            message += f"Ø¢ÛŒØ¯ÛŒ: /user_{user[1]}\n\n"
            keyboard = types.InlineKeyboardMarkup()
            keyboard.add(types.InlineKeyboardButton("Ø¢Ù†Ø¨Ù„Ø§Ú©", callback_data=f'unblock_partner_{user[0]}'))
            bot.send_message(call.message.chat.id, message, reply_markup=keyboard)
            message = ""  # Ø±ÛŒØ³Øª Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø¹Ø¯ÛŒ


def register_unblock_partner_handler(bot, conn):
    @bot.callback_query_handler(func=lambda call: call.data.startswith('unblock_partner_'))
    def unblock_partner(call):
        user_id = call.from_user.id
        partner_id = int(call.data.split('_')[-1])
        bot.answer_callback_query(call.id)

        cursor = conn.cursor()
        cursor.execute('''
            SELECT 1 FROM block WHERE blocker_id = ? AND blocked_id = ?
        ''', (user_id, partner_id))
        is_blocked = cursor.fetchone()

        if not is_blocked:
            bot.send_message(call.message.chat.id, "Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ø¨Ù„Ø§Ú© Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª!")
            cursor.close()
            return

        cursor.execute('''
            DELETE FROM block WHERE blocker_id = ? AND blocked_id = ?
        ''', (user_id, partner_id))
        conn.commit()
        cursor.close()

        bot.send_message(call.message.chat.id, "Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¢Ù†Ø¨Ù„Ø§Ú© Ø´Ø¯! âœ…")


# Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯ÙˆÙ„ follow
cursor = conn.cursor()
cursor.execute("""CREATE TABLE IF NOT EXISTS follow (
    follower_id INTEGER,
    followed_id INTEGER,
    PRIMARY KEY (follower_id, followed_id)
)""")
conn.commit()
cursor.close()

# Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø³ØªÙˆÙ† latitude Ø¨Ù‡ Ø¬Ø¯ÙˆÙ„ users (Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ Ø¨Ø§ Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ)
cursor = conn.cursor()
try:
    cursor.execute("PRAGMA table_info(users)")
    columns = [info[1] for info in cursor.fetchall()]
    if 'latitude' not in columns:
        cursor.execute("ALTER TABLE users ADD COLUMN latitude REAL")
        conn.commit()
    else:
        pass
except sqlite3.OperationalError as e:
    pass
finally:
    cursor.close()


# ØªØ¹Ø±ÛŒÙ handlerÙ‡Ø§
def register_callback_handlers(bot):
    @bot.callback_query_handler(func=lambda call: call.data == 'friends')
    def handle_friends_query(call):
        user_id = call.from_user.id
        bot.answer_callback_query(call.id)
        bot.send_message(
            call.message.chat.id,
            "Ø¨Ù‡ Ø¨Ø®Ø´ ğŸ‘« Ø¯ÙˆØ³ØªØ§Ù† Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ â•",
            reply_markup=create_friends_menu()
        )


def create_friends_menu():
    keyboard = types.InlineKeyboardMarkup()
    keyboard.add(
        types.InlineKeyboardButton("Ú©Ø³Ø§ÛŒÛŒ Ú©Ù‡ ÙØ§Ù„Ùˆ Ú©Ø±Ø¯Ù…", callback_data='following'),
        types.InlineKeyboardButton("Ú©Ø³Ø§ÛŒÛŒ Ú©Ù‡ Ù…Ù†Ùˆ ÙØ§Ù„Ùˆ Ú©Ø±Ø¯Ù†", callback_data='followers')
    )
    return keyboard


def register_following_handler(bot, conn):
    @bot.callback_query_handler(func=lambda call: call.data == 'following')
    def handle_following_query(call):
        user_id = call.from_user.id
        bot.answer_callback_query(call.id)

        cursor = conn.cursor()
        cursor.execute('''
            SELECT u.user_id, u.name, u.age, u.city, u.unique_id
            FROM users u
            JOIN follow f ON u.user_id = f.followed_id
            WHERE f.follower_id = ?
        ''', (user_id,))

        following = cursor.fetchall()
        cursor.close()

        if not following:
            bot.send_message(call.message.chat.id, "Ø´Ù…Ø§ Ù‡Ù†ÙˆØ² Ú©Ø³ÛŒ Ø±Ùˆ ÙØ§Ù„Ùˆ Ù†Ú©Ø±Ø¯ÛŒØ¯!", reply_markup=create_friends_menu())
            return

        message = "Ú©Ø³Ø§ÛŒÛŒ Ú©Ù‡ ÙØ§Ù„Ùˆ Ú©Ø±Ø¯ÛŒØ¯:\n"
        for user in following:
            message += f"Ù†Ø§Ù…: {user[1]}\nØ³Ù†: {user[2]}\nØ´Ù‡Ø±: {user[3]}\n/Ø¢ÛŒØ¯ÛŒ: @/user_{user[4]}\n\n"
            keyboard = types.InlineKeyboardMarkup()
            keyboard.add(types.InlineKeyboardButton("ğŸ›‘ Ø¢Ù†ÙØ§Ù„Ùˆ", callback_data=f'unfollow_partner_{user[0]}'))
            bot.send_message(call.message.chat.id, message, reply_markup=keyboard)
            message = ""  # Ø±ÛŒØ³Øª Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø¹Ø¯ÛŒ

        bot.send_message(call.message.chat.id, "Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø¯ÙˆØ³ØªØ§Ù†:", reply_markup=create_friends_menu())


def register_followers_handler(bot, conn):
    @bot.callback_query_handler(func=lambda call: call.data == 'followers')
    def handle_followers_query(call):
        user_id = call.from_user.id
        bot.answer_callback_query(call.id)

        cursor = conn.cursor()
        cursor.execute('''
            SELECT u.user_id, u.name, u.age, u.city, u.unique_id
            FROM users u
            JOIN follow f ON u.user_id = f.follower_id
            WHERE f.followed_id = ?
        ''', (user_id,))

        followers = cursor.fetchall()
        cursor.close()

        if not followers:
            bot.send_message(call.message.chat.id, "Ù‡Ù†ÙˆØ² Ú©Ø³ÛŒ Ø´Ù…Ø§ Ø±Ùˆ ÙØ§Ù„Ùˆ Ù†Ú©Ø±Ø¯Ù‡!", reply_markup=create_friends_menu())
            return

        message = "Ú©Ø³Ø§ÛŒÛŒ Ú©Ù‡ Ø´Ù…Ø§ Ø±Ùˆ ÙØ§Ù„Ùˆ Ú©Ø±Ø¯Ù†:\n"
        for user in followers:
            cursor2 = conn.cursor()
            cursor2.execute('''
                SELECT 1 FROM follow WHERE follower_id = ? AND followed_id = ?
            ''', (user_id, user[0]))
            is_following = cursor2.fetchone()
            cursor2.close()

            follow_button_text = "ğŸ›‘ Ø¢Ù†ÙØ§Ù„Ùˆ" if is_following else "ğŸ•º Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø±Ø¯Ù†"
            follow_button_data = f'unfollow_partner_{user[0]}' if is_following else f'follow_partner_{user[0]}'

            message += f"Ù†Ø§Ù…: {user[1]}\nØ³Ù†: {user[2]}\nØ´Ù‡Ø±: {user[3]}\nØ¢ÛŒØ¯ÛŒ: @{user[4]}\n\n"
            keyboard = types.InlineKeyboardMarkup()
            keyboard.add(types.InlineKeyboardButton(follow_button_text, callback_data=follow_button_data))
            bot.send_message(call.message.chat.id, message, reply_markup=keyboard)
            message = ""  # Ø±ÛŒØ³Øª Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø¹Ø¯ÛŒ

        bot.send_message(call.message.chat.id, "Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø¯ÙˆØ³ØªØ§Ù†:", reply_markup=create_friends_menu())


def register_follow_partner_handler(bot, conn):
    @bot.callback_query_handler(func=lambda call: call.data.startswith('follow_partner_'))
    def handle_follow_partner(call):
        user_id = call.from_user.id
        partner_id = int(call.data.split('_')[-1])
        bot.answer_callback_query(call.id)

        cursor = conn.cursor()
        cursor.execute('''
            SELECT 1 FROM follow WHERE follower_id = ? AND followed_id = ?
        ''', (user_id, partner_id))
        already_following = cursor.fetchone()

        if already_following:
            bot.send_message(call.message.chat.id, "Ø´Ù…Ø§ Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ù‚Ø¨Ù„Ø§Ù‹ ÙØ§Ù„Ùˆ Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯!")
            cursor.close()
            return

        cursor.execute('''
            INSERT INTO follow (follower_id, followed_id) VALUES (?, ?)
        ''', (user_id, partner_id))
        cursor.execute('''
            UPDATE users SET following_count = following_count + 1 WHERE user_id = ?
        ''', (user_id,))
        cursor.execute('''
            UPDATE users SET followers_count = followers_count + 1 WHERE user_id = ?
        ''', (partner_id,))
        conn.commit()
        cursor.close()

        bot.send_message(call.message.chat.id, "Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙØ§Ù„Ùˆ Ø´Ø¯! âœ…", reply_markup=create_friends_menu())


def register_unfollow_partner_handler(bot, conn):
    @bot.callback_query_handler(func=lambda call: call.data.startswith('unfollow_partner_'))
    def handle_unfollow_partner(call):
        user_id = call.from_user.id
        partner_id = int(call.data.split('_')[-1])
        bot.answer_callback_query(call.id)

        cursor = conn.cursor()
        cursor.execute('''
            SELECT 1 FROM follow WHERE follower_id = ? AND followed_id = ?
        ''', (user_id, partner_id))
        is_following = cursor.fetchone()

        if not is_following:
            bot.send_message(call.message.chat.id, "Ø´Ù…Ø§ Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ ÙØ§Ù„Ùˆ Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯!")
            cursor.close()
            return

        cursor.execute('''
            DELETE FROM follow WHERE follower_id = ? AND followed_id = ?
        ''', (user_id, partner_id))
        cursor.execute('''
            UPDATE users SET following_count = following_count - 1 WHERE user_id = ?
        ''', (user_id,))
        cursor.execute('''
            UPDATE users SET followers_count = followers_count - 1 WHERE user_id = ?
        ''', (partner_id,))
        conn.commit()
        cursor.close()

        bot.send_message(call.message.chat.id, "Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¢Ù†ÙØ§Ù„Ùˆ Ø´Ø¯! ğŸ›‘", reply_markup=create_friends_menu())


# ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… bot Ù‚Ø¨Ù„Ø§Ù‹ ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡


# Ø«Ø¨Øª handlerÙ‡Ø§
register_following_handler(bot, conn)
register_followers_handler(bot, conn)
register_follow_partner_handler(bot, conn)
register_unfollow_partner_handler(bot, conn)
register_callback_handlers(bot)
register_block_partner_handler(bot, conn)
register_block_list_handler(bot, conn)
register_unblock_partner_handler(bot, conn)


@bot.callback_query_handler(func=lambda call: call.data == 'private_chat_toggle')
def private_chat_toggle(call):
    user_id = call.from_user.id
    cursor.execute(
        "SELECT private_chat_enabled, name, gender, followers_count, following_count, province, city, age, likes_count, unique_id, profile_photo FROM users WHERE user_id = ?",
        (user_id,))
    user = cursor.fetchone()

    if not user:
        bot.answer_callback_query(call.id, "Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!")
        return

    private_chat_enabled, name, gender, followers_count, following_count, province, city, age, likes_count, unique_id, profile_photo = user

    # ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ú†Øª Ø®ØµÙˆØµÛŒ
    new_status = 1 if private_chat_enabled == 0 else 0
    cursor.execute("UPDATE users SET private_chat_enabled = ? WHERE user_id = ?", (new_status, user_id))
    conn.commit()

    # Ø¢Ù¾Ø¯ÛŒØª Ù…ØªÙ† Ù¾Ø±ÙˆÙØ§ÛŒÙ„
    gender_display = "Ù¾Ø³Ø± ğŸ‘¨â€ğŸ¦°" if gender == 'male' else "Ø¯Ø®ØªØ± ğŸ‘©"
    profile_text = f"""â€¢Ù†Ø§Ù…: {name} 
â€¢Ø¬Ù†Ø³ÛŒØª: {gender_display}
Ø¯Ù†Ø¨Ø§Ù„ Ú©Ù†Ù†Ø¯Ù‡ Ù‡Ø§: {followers_count}
Ø¯Ù†Ø¨Ø§Ù„ Ù…ÛŒÚ©Ù†Ø¯: {following_count}
â€¢Ø§Ø³ØªØ§Ù†: {province or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
â€¢Ø´Ù‡Ø±: {city or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
â€¢Ø³Ù†: {age or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
ğŸ†” : /user_{unique_id}
ØªØ¹Ø¯Ø§Ø¯ Ù„Ø§ÛŒÚ© Ù‡Ø§ : {likes_count}"""

    # Ø¢Ù¾Ø¯ÛŒØª Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø¨Ø§ ÙˆØ¶Ø¹ÛŒØª Ø¬Ø¯ÛŒØ¯
    markup = get_profile_inline_keyboard(user_id)

    # Ø¢Ù¾Ø¯ÛŒØª Ù¾ÛŒØ§Ù… Ù¾Ø±ÙˆÙØ§ÛŒÙ„
    try:
        if profile_photo and isinstance(profile_photo, str) and len(profile_photo) > 0:
            bot.edit_message_media(
                media=types.InputMediaPhoto(profile_photo, caption=profile_text),
                chat_id=user_id,
                message_id=call.message.message_id,
                reply_markup=markup
            )
        else:
            bot.edit_message_text(
                text=profile_text,
                chat_id=user_id,
                message_id=call.message.message_id,
                reply_markup=markup
            )
        bot.answer_callback_query(call.id, "ÙˆØ¶Ø¹ÛŒØª Ú†Øª Ø®ØµÙˆØµÛŒ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯!")
    except telebot.apihelper.ApiTelegramException as e:
        print(f"Error updating profile message: {e}")
        bot.send_message(user_id, profile_text, reply_markup=markup)
        bot.answer_callback_query(call.id, "ÙˆØ¶Ø¹ÛŒØª Ú†Øª Ø®ØµÙˆØµÛŒ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯ØŒ Ø§Ù…Ø§ Ù¾ÛŒØ§Ù… Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø¢Ù¾Ø¯ÛŒØª Ù†Ø´Ø¯!")


cursor = conn.cursor()
# Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ latitude Ùˆ longitude Ø¨Ù‡ Ø¬Ø¯ÙˆÙ„ users
try:
    cursor.execute("ALTER TABLE users ADD COLUMN latitude REAL")
    cursor.execute("ALTER TABLE users ADD COLUMN longitude REAL")
    conn.commit()
except sqlite3.OperationalError:
    # Ø§Ú¯Ù‡ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ Ù‚Ø¨Ù„Ø§Ù‹ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù†ØŒ Ø®Ø·Ø§ Ø±Ùˆ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ø¨Ú¯ÛŒØ±
    pass

# ØªØ¹Ø±ÛŒÙ Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ Ùˆ Ù„ØºÙˆ
location_markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
location_button = types.KeyboardButton("Ø§Ø±Ø³Ø§Ù„ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ ğŸ“", request_location=True)
cancel_button = types.KeyboardButton("Ù„ØºÙˆ âŒ")
location_markup.add(location_button, cancel_button)


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ
@bot.callback_query_handler(func=lambda call: call.data == 'location')
def request_location(call):
    user_id = call.from_user.id
    text = """â“Ù…ÙˆÙ‚Ø¹ÛŒØª GPS Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯ğŸ‘‡

âš ï¸ Ù‡Ù†Ú¯Ø§Ù… Ø§Ø±Ø³Ø§Ù„ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ Ù…Ø·Ù…Ø¹Ù† Ø´ÙˆÛŒØ¯ GPS Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø´Ù…Ø§ Ø±ÙˆØ´Ù† Ø§Ø³Øª.

âœ… Ú©Ø³ÛŒ Ù‚Ø§Ø¯Ø± Ø¨Ù‡ Ø¯ÛŒØ¯Ù† Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ Ø´Ù…Ø§ Ø¯Ø± Ø±Ø¨Ø§Øª Ù†Ø®ÙˆØ§Ù‡Ø¯ Ø¨ÙˆØ¯ Ùˆ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ ØªØ®Ù…ÛŒÙ† ÙØ§ØµÙ„Ù‡ Ùˆ ÛŒØ§ÙØªÙ† Ø§ÙØ±Ø§Ø¯ Ù†Ø²Ø¯ÛŒÚ© Ú©Ø§Ø±Ø¨Ø±Ø¯ Ø®ÙˆØ§Ù‡Ø¯ Ø¯Ø§Ø´Øª"""

    try:
        bot.delete_message(user_id, call.message.message_id)
    except telebot.apihelper.ApiTelegramException as e:
        print(f"Error deleting message: {e}")

    bot.send_message(user_id, text, reply_markup=location_markup)
    bot.register_next_step_handler(call.message, process_location)


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ ÛŒØ§ Ù„ØºÙˆ
def process_location(message):
    user_id = message.from_user.id

    if message.text == "Ù„ØºÙˆ âŒ":
        bot.send_message(user_id, "Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯.", reply_markup=main_markup)
        return

    if message.location:
        latitude = message.location.latitude
        longitude = message.location.longitude

        # Ø°Ø®ÛŒØ±Ù‡â€ŒÛŒ Ù…Ø®ØªØµØ§Øª Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
        cursor.execute("UPDATE users SET latitude = ?, longitude = ? WHERE user_id = ?", (latitude, longitude, user_id))
        conn.commit()

        bot.send_message(user_id, "Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯! âœ…", reply_markup=main_markup)
    else:
        bot.send_message(user_id, "Ù„Ø·ÙØ§Ù‹ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ù„ØºÙˆ Ú©Ù†ÛŒØ¯.", reply_markup=location_markup)
        bot.register_next_step_handler(message, process_location)


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ú¯ÙØªâ€ŒÙˆÚ¯ÙˆÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ±
@bot.callback_query_handler(func=lambda call: call.data == 'recent_chats')
def recent_chats(call):
    user_id = call.from_user.id
    cursor.execute('''
        SELECT u.name, u.gender, u.age, u.province, u.city, u.unique_id
        FROM chat_history ch
        JOIN users u ON ch.partner_id = u.user_id
        WHERE ch.user_id = ?
        ORDER BY ch.chat_time DESC
        LIMIT 10
    ''', (user_id,))
    recent_partners = cursor.fetchall()

    if not recent_partners:
        bot.answer_callback_query(call.id, "Ø´Ù…Ø§ Ù‡Ù†ÙˆØ² Ø¨Ø§ Ú©Ø³ÛŒ Ú†Øª Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯!")
        bot.send_message(user_id, "ğŸ“‹ Ù‡Ù†ÙˆØ² Ø¨Ø§ Ú©Ø³ÛŒ Ú†Øª Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯!", reply_markup=main_markup)
        return

    message_text = "ğŸ“‹ Ù„ÛŒØ³Øª Ú©Ø³Ø§Ù†ÛŒ Ú©Ù‡ Ø§Ø®ÛŒØ±Ø§ Ø¨Ø§Ù‡Ø§Ø´ÙˆÙ† Ú†Øª Ú©Ø±Ø¯ÛŒ â•\n\n"
    for name, gender, age, province, city, unique_id in recent_partners:
        gender_display = "ğŸ‘¨â€ğŸ¦°" if gender == 'male' else "ğŸ‘©"
        province_display = province if province else "Ù†Ø§Ù…Ø´Ø®Øµ"
        city_display = city if city else "Ù†Ø§Ù…Ø´Ø®Øµ"
        age_display = age if age else "Ù†Ø§Ù…Ø´Ø®Øµ"
        message_text += f"{gender_display} Ù†Ø§Ù…â€Œ: {name} (Ø³Ù†: {age_display})\n"
        message_text += f"Ø§Ø³ØªØ§Ù†:â€Œ {province_display} ({city_display})\n\n"
        message_text += f"ğŸ†” : /user_{unique_id}\n"
        message_text += "ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸ã€°ï¸\n"

    try:
        bot.delete_message(user_id, call.message.message_id)
    except telebot.apihelper.ApiTelegramException as e:
        print(f"Error deleting message: {e}")

    bot.send_message(user_id, message_text, reply_markup=main_markup)
    bot.answer_callback_query(call.id, "Ù„ÛŒØ³Øª Ú¯ÙØªâ€ŒÙˆÚ¯ÙˆÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ± Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯!")


@bot.callback_query_handler(func=lambda call: call.data == 'delete_account')
def delete_account(call):
    user_id = call.from_user.id
    cursor.execute("SELECT status, partner_id, name, unique_id FROM users WHERE user_id = ?", (user_id,))
    user = cursor.fetchone()

    if not user:
        bot.answer_callback_query(call.id, "Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!")
        return

    status, partner_id, name, unique_id = user

    # Ø§Ú¯Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø­Ø§Ù„ Ú†Øª Ø¨Ø§Ø´Ù‡ØŒ Ø¨Ù‡ Ù¾Ø§Ø±ØªÙ†Ø± Ø§Ø·Ù„Ø§Ø¹ Ø¨Ø¯Ù‡ Ùˆ Ú†Øª Ø±Ùˆ Ù¾Ø§ÛŒØ§Ù† Ø¨Ø¯Ù‡
    if status == 'chatting' and partner_id:
        cursor.execute("UPDATE users SET status = 'idle', partner_id = NULL WHERE user_id = ?", (partner_id,))
        conn.commit()
        bot.send_message(partner_id, f"Ú†Øª Ø¨Ø§ ({name}) /user_{unique_id} Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ Ø­Ø°Ù Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø± Ù¾Ø§ÛŒØ§Ù† ÛŒØ§ÙØª.",
                         reply_markup=main_markup)

    # Ø­Ø°Ù ØªÙ…Ø§Ù… Ù„Ø§ÛŒÚ©â€ŒÙ‡Ø§ÛŒ Ù…Ø±ØªØ¨Ø· Ø¨Ø§ Ú©Ø§Ø±Ø¨Ø± (Ú†Ù‡ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù„Ø§ÙŠÚ©â€ŒÚ©Ù†Ù†Ø¯Ù‡ Ùˆ Ú†Ù‡ Ù„Ø§ÙŠÚ©â€ŒØ´Ø¯Ù‡)
    cursor.execute("DELETE FROM likes WHERE user_id = ? OR target_id = ?", (user_id, user_id))

    # Ø¢Ù¾Ø¯ÛŒØª ØªØ¹Ø¯Ø§Ø¯ Ù„Ø§ÛŒÚ©â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†ÛŒ Ú©Ù‡ ØªÙˆØ³Ø· Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ù„Ø§ÛŒÚ© Ø´Ø¯Ù‡ Ø¨ÙˆØ¯Ù†
    cursor.execute(
        "UPDATE users SET likes_count = likes_count - 1 WHERE user_id IN (SELECT target_id FROM likes WHERE user_id = ?)",
        (user_id,))

    # Ø­Ø°Ù Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ø¬Ø¯ÙˆÙ„ users
    cursor.execute("DELETE FROM users WHERE user_id = ?", (user_id,))
    conn.commit()

    # Ø­Ø°Ù Ù¾ÛŒØ§Ù… Ù¾Ø±ÙˆÙØ§ÛŒÙ„
    try:
        bot.delete_message(user_id, call.message.message_id)
    except telebot.apihelper.ApiTelegramException as e:
        print(f"Error deleting message: {e}")

    # Ø§Ø·Ù„Ø§Ø¹ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
    bot.answer_callback_query(call.id, "Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯!")
    bot.send_message(user_id, "Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ Ø­Ø°Ù Ø´Ø¯. Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¯ÙˆØ¨Ø§Ø±Ù‡ØŒ /start Ø±Ùˆ Ø¨Ø²Ù†.",
                     reply_markup=types.ReplyKeyboardRemove())


# ØªØ§Ø¨Ø¹ Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª Ø§ÛŒÙ†Ù„Ø§ÛŒÙ† Ú©ÛŒØ¨ÙˆØ±Ø¯ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ø®Ø§Ø·Ø¨ Ø¯Ø± Ú†Øª
def get_partner_profile_inline_keyboard(user_id, partner_id):
    cursor = conn.cursor()
    cursor.execute("SELECT COUNT(*) FROM likes WHERE user_id = ? AND target_id = ?", (user_id, partner_id))
    has_liked = cursor.fetchone()[0] > 0
    cursor.close()
    like_button_text = "Unlike ğŸ¤" if has_liked else "Like ğŸ¤"
    markup = types.InlineKeyboardMarkup(row_width=2)
    markup.add(
        types.InlineKeyboardButton(like_button_text, callback_data=f'like_partner_{partner_id}'),
        types.InlineKeyboardButton("ğŸ•º Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø±Ø¯Ù†", callback_data=f'follow_partner_{partner_id}')
    )
    markup.add(
        types.InlineKeyboardButton("ğŸ’¬ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú†Øª", callback_data=f'request_chat_{partner_id}'),
        types.InlineKeyboardButton("âœ‰ï¸ Ù¾ÛŒØ§Ù… Ø¯Ø§ÛŒØ±Ú©Øª", callback_data=f'direct_message_{partner_id}')
    )
    markup.add(
        types.InlineKeyboardButton("ğŸš« Ø¨Ù„Ø§Ú©", callback_data=f'block_partner_{partner_id}'),
        types.InlineKeyboardButton("â›” Ú¯Ø²Ø§Ø±Ø´ Ú©Ø±Ø¯Ù†", callback_data=f'report_partner_{partner_id}')
    )
    markup.add(
        types.InlineKeyboardButton("ğŸ Ù‡Ø¯ÛŒÙ‡ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±", callback_data=f'gift_partner_{partner_id}'),
        types.InlineKeyboardButton("ğŸ™ï¸ Ú†Øª Ú©Ø±Ø¯Ù†Ø´ ØªÙ…ÙˆÙ… Ø´Ø¯ Ø¨Ù‡Ù… Ø®Ø¨Ø± Ø¨Ø¯Ù‡", callback_data=f'notify_chat_end_{partner_id}')
    )
    return markup


# Ø¯ÛŒÚ©Ø´Ù†Ø±ÛŒ Ù…ÙˆÙ‚Øª Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø¹Ù„Ø§Ù† Ù¾Ø§ÛŒØ§Ù† Ú†Øª
pending_chat_end_notifications = defaultdict(list)


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø§Ø¹Ù„Ø§Ù† Ù¾Ø§ÛŒØ§Ù† Ú†Øª
@bot.callback_query_handler(func=lambda call: call.data.startswith('notify_chat_end_'))
def notify_chat_end(call):
    user_id = call.from_user.id
    update_last_online(user_id)
    try:
        target_id = int(call.data.split('_')[-1])  # ÙØ±Ù…Øª: notify_chat_end_<target_id>
    except (IndexError, ValueError):
        bot.answer_callback_query(call.id, "Ø®Ø·Ø§: Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª!")
        return

    # Ú†Ú© Ú©Ø±Ø¯Ù† Ø§ÛŒÙ†Ú©Ù‡ target_id Ø¨Ø§ user_id ÛŒÚ©Ø³Ø§Ù† Ù†Ø¨Ø§Ø´Ù‡
    if target_id == user_id:
        bot.answer_callback_query(call.id, "Ù†Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ¯ØªÙˆÙ† Ø§Ø¹Ù„Ø§Ù† ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯!")
        return

    # Ú†Ú© Ú©Ø±Ø¯Ù† ÙˆØ¬ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø± Ùˆ Ù‡Ø¯Ù
    cursor = conn.cursor()
    cursor.execute("SELECT coins FROM users WHERE user_id = ?", (user_id,))
    requester = cursor.fetchone()
    cursor.execute("SELECT unique_id FROM users WHERE user_id = ?", (target_id,))
    target = cursor.fetchone()
    cursor.close()

    if not requester or not target:
        bot.answer_callback_query(call.id, "Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ Ù…Ø®Ø§Ø·Ø¨ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!")
        return

    requester_coins = requester[0]
    target_unique_id = target[0]

    # Ú†Ú© Ú©Ø±Ø¯Ù† ØªØ¹Ø¯Ø§Ø¯ Ø³Ú©Ù‡â€ŒÙ‡Ø§
    if requester_coins < 1:
        markup = types.InlineKeyboardMarkup()
        markup.add(types.InlineKeyboardButton("Ø®Ø±ÛŒØ¯ Ø³Ú©Ù‡", callback_data='buy_coins'))
        bot.send_message(
            user_id,
            """âš ï¸ ØªÙˆØ¬Ù‡: Ø´Ù…Ø§ Ø³Ú©Ù‡ Ú©Ø§ÙÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯! (Û± Ø³Ú©Ù‡ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²)
ğŸ’¡ Ø¨Ø±Ø§ÛŒ Ø¨Ø¯Ø³Øª Ø¢ÙˆØ±Ø¯Ù† Ø³Ú©Ù‡ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø±Ø¨Ø§ØªÙˆ Ø¨Ù‡ Ø¯ÙˆØ³ØªØ§Øª Ù…Ø¹Ø±ÙÛŒ Ú©Ù†ÛŒ Ùˆ Ø¨Ù‡ Ø§Ø²Ø§ÛŒ Ù…Ø¹Ø±ÙÛŒ Ù‡Ø± Ù†ÙØ± Û²Û° Ø³Ú©Ù‡ Ù‡Ø¯ÛŒÙ‡ Ø¨Ú¯ÛŒØ±ÛŒ.
â—ï¸ Ø§Ú¯Ù‡ Ø¯ÙˆØ³ØªÛŒ Ù†Ø¯Ø§Ø±ÛŒ Ú©Ù‡ Ø¯Ø¹ÙˆØª Ú©Ù†ÛŒ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø§Ø² Ù¾Ù†Ù„ Ø®Ø±ÛŒØ¯ Ø³Ú©Ù‡ ğŸ’° Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒ Ùˆ Ø³Ú©Ù‡â€ŒÙ‡Ø§ØªÙˆ Ø§ÙØ²Ø§ÛŒØ´ Ø¨Ø¯ÛŒ.""",
            reply_markup=markup
        )
        bot.answer_callback_query(call.id, "Ø³Ú©Ù‡ Ú©Ø§ÙÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯!")
        return

    # Ú†Ú© Ú©Ø±Ø¯Ù† Ø¯Ø±Ø®ÙˆØ§Ø³Øª ØªÚ©Ø±Ø§Ø±ÛŒ
    if user_id in pending_chat_end_notifications[target_id]:
        bot.answer_callback_query(call.id, "Ø´Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ø§Ø¹Ù„Ø§Ù† ØªÙ†Ø¸ÛŒÙ… Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯!")
        return

    # Ú©Ø³Ø± Û± Ø³Ú©Ù‡
    cursor = conn.cursor()
    cursor.execute("UPDATE users SET coins = coins - 1 WHERE user_id = ?", (user_id,))
    conn.commit()
    cursor.close()

    # Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø¹Ù„Ø§Ù†
    pending_chat_end_notifications[target_id].append(user_id)

    # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… ØªØ£ÛŒÛŒØ¯
    bot.send_message(
        user_id,
        f"""âœ… ÛŒÙ‡ Ø³Ú©Ù‡ Ø§Ø²Øª Ú©Ø³Ø± Ø´Ø¯.

ğŸ”” Ø¨Ù‡ Ù…Ø­Ø¶ Ø§ØªÙ…Ø§Ù… Ú†Øª Ú©Ø§Ø±Ø¨Ø± /user_{target_unique_id} Ø¨Ù‡ Ø´Ù…Ø§ Ø§Ø·Ù„Ø§Ø¹ Ø¯Ø§Ø¯Ù‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.

(Ø±Ø§Ù‡Ù†Ù…Ø§: /help_chw)""",
        reply_markup=main_markup
    )
    bot.answer_callback_query(call.id, "Ø§Ø¹Ù„Ø§Ù† Ù¾Ø§ÛŒØ§Ù† Ú†Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯!")


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø¨Ù„Ø§Ú©
@bot.callback_query_handler(func=lambda call: call.data.startswith('block_partner_'))
def block_partner(call):
    bot.answer_callback_query(call.id, "Ú©Ø§Ø±Ø¨Ø± Ø¨Ù„Ø§Ú© Ø´Ø¯!")


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ú¯Ø²Ø§Ø±Ø´ Ú©Ø±Ø¯Ù†
@bot.callback_query_handler(func=lambda call: call.data.startswith('report_partner_'))
def report_partner(call):
    bot.answer_callback_query(call.id, "Ú©Ø§Ø±Ø¨Ø± Ú¯Ø²Ø§Ø±Ø´ Ø´Ø¯!")


# Ø¯ÛŒÚ©Ø´Ù†Ø±ÛŒ Ù…ÙˆÙ‚Øª Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø­Ø§Ù„Øª Ø§Ù†ØªØ¸Ø§Ø± Ù¾ÛŒØ§Ù… Ø¯Ø§ÛŒØ±Ú©Øª
pending_direct_messages = defaultdict(dict)


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ù¾ÛŒØ§Ù… Ø¯Ø§ÛŒØ±Ú©Øª
@bot.callback_query_handler(func=lambda call: call.data.startswith('direct_message_'))
def direct_message_start(call):
    user_id = call.from_user.id
    update_last_online(user_id)
    try:
        target_id = int(call.data.split('_')[-1])  # ÙØ±Ù…Øª: direct_message_<target_id>
    except (IndexError, ValueError):
        bot.answer_callback_query(call.id, "Ø®Ø·Ø§: Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª!")
        return

    # Ú†Ú© Ú©Ø±Ø¯Ù† Ø§ÛŒÙ†Ú©Ù‡ target_id Ø¨Ø§ user_id ÛŒÚ©Ø³Ø§Ù† Ù†Ø¨Ø§Ø´Ù‡
    if target_id == user_id:
        bot.answer_callback_query(call.id, "Ù†Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒØ¯ Ø¨Ù‡ Ø®ÙˆØ¯ØªÙˆÙ† Ù¾ÛŒØ§Ù… Ø¯Ø§ÛŒØ±Ú©Øª Ø¨ÙØ±Ø³ØªÛŒØ¯!")
        return

    # Ú†Ú© Ú©Ø±Ø¯Ù† ÙˆØ¬ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø± Ùˆ Ù‡Ø¯Ù
    cursor = conn.cursor()
    cursor.execute("SELECT name, unique_id FROM users WHERE user_id = ?", (target_id,))
    target = cursor.fetchone()
    cursor.close()

    if not target:
        bot.answer_callback_query(call.id, "Ú©Ø§Ø±Ø¨Ø± Ù‡Ø¯Ù Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!")
        return

    target_name, target_unique_id = target

    # Ø°Ø®ÛŒØ±Ù‡ Ø­Ø§Ù„Øª Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù…
    pending_direct_messages[user_id] = {'target_id': target_id, 'timestamp': time.time()}

    # Ø§ÛŒØ¬Ø§Ø¯ Ú©ÛŒØ¨ÙˆØ±Ø¯ Reply Ø¨Ø±Ø§ÛŒ Ù„ØºÙˆ
    cancel_markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    cancel_markup.add(types.KeyboardButton("Ù„ØºÙˆ âŒ"))

    # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…ØªÙ† Ùˆ Ø«Ø¨Øª ØªØ§Ø¨Ø¹ Ø¨Ø¹Ø¯ÛŒ
    sent_message = bot.send_message(
        user_id,
        f"""Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ø¯Ø§ÛŒØ±Ú©Øª Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯ (Ø­Ø¯Ø§Ú©Ø«Ø± Û²Û°Û° Ø­Ø±Ù)

- Ø¨Ø±Ø§ÛŒ Ù„ØºÙˆ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¯Ø§ÛŒØ±Ú©Øª Ø¨Ù‡ ({target_name}) /user_{target_unique_id} ã€ŠÙ„ØºÙˆã€‹ Ø±Ø§ Ù„Ù…Ø³ Ú©Ù†ÛŒØ¯""",
        reply_markup=cancel_markup
    )
    bot.register_next_step_handler(sent_message, handle_direct_message_text)
    bot.answer_callback_query(call.id, "Ù„Ø·ÙØ§Ù‹ Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ø¯Ø§ÛŒØ±Ú©Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.")


# ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ø¯Ø§ÛŒØ±Ú©Øª ÛŒØ§ Ù„ØºÙˆ
def handle_direct_message_text(message):
    user_id = message.from_user.id
    text = message.text

    # Ú†Ú© Ú©Ø±Ø¯Ù† Ø¢ÛŒØ§ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø­Ø§Ù„Øª Ø§Ù†ØªØ¸Ø§Ø± Ù¾ÛŒØ§Ù… Ø¯Ø§ÛŒØ±Ú©Øª Ù‡Ø³Øª
    if user_id not in pending_direct_messages:
        bot.send_message(user_id, "Ø®Ø·Ø§: Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª!", reply_markup=main_markup)
        return

    target_id = pending_direct_messages[user_id]['target_id']
    cursor = conn.cursor()
    cursor.execute("SELECT name, unique_id, coins FROM users WHERE user_id = ?", (user_id,))
    requester = cursor.fetchone()
    cursor.execute("SELECT name, unique_id FROM users WHERE user_id = ?", (target_id,))
    target = cursor.fetchone()
    cursor.close()

    if not requester or not target:
        bot.send_message(user_id, "Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ Ù…Ø®Ø§Ø·Ø¨ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!", reply_markup=main_markup)
        del pending_direct_messages[user_id]
        return

    requester_name, requester_unique_id, requester_coins = requester
    target_name, target_unique_id = target

    # Ú†Ú© Ú©Ø±Ø¯Ù† Ù„ØºÙˆ
    if text == "Ù„ØºÙˆ âŒ":
        bot.send_message(user_id, "Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¯Ø§ÛŒØ±Ú©Øª Ù„ØºÙˆ Ø´Ø¯.", reply_markup=main_markup)
        del pending_direct_messages[user_id]
        return

    # Ú†Ú© Ú©Ø±Ø¯Ù† Ø·ÙˆÙ„ Ù¾ÛŒØ§Ù…
    if len(text) > 200:
        cancel_markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
        cancel_markup.add(types.KeyboardButton("Ù„ØºÙˆ âŒ"))
        sent_message = bot.send_message(
            user_id,
            "Ù¾ÛŒØ§Ù… Ø´Ù…Ø§ Ø¨ÛŒØ´ØªØ± Ø§Ø² Û²Û°Û° Ø­Ø±Ù Ø§Ø³Øª! Ù„Ø·ÙØ§Ù‹ Ù¾ÛŒØ§Ù… Ú©ÙˆØªØ§Ù‡â€ŒØªØ±ÛŒ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯.",
            reply_markup=cancel_markup
        )
        bot.register_next_step_handler(sent_message, handle_direct_message_text)
        return

    # Ú†Ú© Ú©Ø±Ø¯Ù† ØªØ¹Ø¯Ø§Ø¯ Ø³Ú©Ù‡â€ŒÙ‡Ø§
    if requester_coins < 1:
        markup = types.InlineKeyboardMarkup()
        markup.add(types.InlineKeyboardButton("Ø®Ø±ÛŒØ¯ Ø³Ú©Ù‡", callback_data='buy_coins'))
        bot.send_message(
            user_id,
            """âš ï¸ ØªÙˆØ¬Ù‡: Ø´Ù…Ø§ Ø³Ú©Ù‡ Ú©Ø§ÙÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯! (Û± Ø³Ú©Ù‡ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²)
ğŸ’¡ Ø¨Ø±Ø§ÛŒ Ø¨Ø¯Ø³Øª Ø¢ÙˆØ±Ø¯Ù† Ø³Ú©Ù‡ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø±Ø¨Ø§ØªÙˆ Ø¨Ù‡ Ø¯ÙˆØ³ØªØ§Øª Ù…Ø¹Ø±ÙÛŒ Ú©Ù†ÛŒ Ùˆ Ø¨Ù‡ Ø§Ø²Ø§ÛŒ Ù…Ø¹Ø±ÙÛŒ Ù‡Ø± Ù†ÙØ± Û²Û° Ø³Ú©Ù‡ Ù‡Ø¯ÛŒÙ‡ Ø¨Ú¯ÛŒØ±ÛŒ.
â—ï¸ Ø§Ú¯Ù‡ Ø¯ÙˆØ³ØªÛŒ Ù†Ø¯Ø§Ø±ÛŒ Ú©Ù‡ Ø¯Ø¹ÙˆØª Ú©Ù†ÛŒ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø§Ø² Ù¾Ù†Ù„ Ø®Ø±ÛŒØ¯ Ø³Ú©Ù‡ ğŸ’° Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒ Ùˆ Ø³Ú©Ù‡â€ŒÙ‡Ø§ØªÙˆ Ø§ÙØ²Ø§ÛŒØ´ Ø¨Ø¯ÛŒ.""",
            reply_markup=markup
        )
        del pending_direct_messages[user_id]
        return

    # Ú©Ø³Ø± Û± Ø³Ú©Ù‡
    cursor = conn.cursor()
    cursor.execute("UPDATE users SET coins = coins - 1 WHERE user_id = ?", (user_id,))
    conn.commit()
    cursor.close()

    # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¯Ø§ÛŒØ±Ú©Øª Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù‡Ø¯Ù
    message_text = f"""Ù¾ÛŒØ§Ù… Ø¯Ø§ÛŒØ±Ú©Øª Ø§Ø² ({requester_name}) /user_{requester_unique_id}:
{text}

ğŸ’¡ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø¨Ø§ /user_{requester_unique_id} Ù¾Ø±ÙˆÙØ§ÛŒÙ„Ø´ Ø±Ùˆ Ø¨Ø¨ÛŒÙ†ÛŒ ÛŒØ§ Ø¬ÙˆØ§Ø¨ Ø¨Ø¯ÛŒ!"""
    try:
        bot.send_message(target_id, message_text)
        bot.send_message(user_id, f"Ù¾ÛŒØ§Ù… Ø¯Ø§ÛŒØ±Ú©Øª Ø¨Ù‡ ({target_name}) /user_{target_unique_id} Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!",
                         reply_markup=main_markup)
    except telebot.apihelper.ApiTelegramException as e:
        print(f"Error sending direct message to {target_id}: {e}")
        # Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ØŒ Ø³Ú©Ù‡ Ø±Ùˆ Ø¨Ø±Ú¯Ø±Ø¯ÙˆÙ†
        cursor = conn.cursor()
        cursor.execute("UPDATE users SET coins = coins + 1 WHERE user_id = ?", (user_id,))
        conn.commit()
        cursor.close()
        bot.send_message(user_id, "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¯Ø§ÛŒØ±Ú©Øª! Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.", reply_markup=main_markup)

    # Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø­Ø§Ù„Øª Ø§Ù†ØªØ¸Ø§Ø±
    del pending_direct_messages[user_id]


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø®Ø±ÛŒØ¯ Ø³Ú©Ù‡ (placeholder)
@bot.callback_query_handler(func=lambda call: call.data == 'buy_coins')
def buy_coins(call):
    bot.answer_callback_query(call.id, "Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ Ù¾Ù†Ù„ Ø®Ø±ÛŒØ¯ Ø³Ú©Ù‡ Ù‡Ø¯Ø§ÛŒØª Ø¨Ø´ÛŒØ¯! (Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù†Ø´Ø¯Ù‡)")
    bot.send_message(call.from_user.id, "Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ø³Ú©Ù‡ØŒ Ù„Ø·ÙØ§Ù‹ Ø¨Ù‡ Ù¾Ù†Ù„ Ø®Ø±ÛŒØ¯ Ù…Ø±Ø§Ø¬Ø¹Ù‡ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¯ÙˆØ³ØªØ§Ù† Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø¹ÙˆØª Ú©Ù†ÛŒØ¯!",
                     reply_markup=main_markup)


pending_requests = defaultdict(dict)


# Ù‡Ù†Ø¯Ù„Ø± Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú†Øª
@bot.callback_query_handler(func=lambda call: call.data.startswith('request_chat'))
def request_chat(call):
    user_id = call.from_user.id
    # Ú¯Ø±ÙØªÙ† target_id Ø§Ø² callback_data
    try:
        target_id = int(call.data.split('_')[-1])  # ÙØ±Ù…Øª: request_chat_<target_id>
    except (IndexError, ValueError):
        bot.answer_callback_query(call.id, "Ø®Ø·Ø§: Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª!")
        return

    # Ú†Ú© Ú©Ø±Ø¯Ù† Ø§ÛŒÙ†Ú©Ù‡ target_id Ø¨Ø§ user_id ÛŒÚ©Ø³Ø§Ù† Ù†Ø¨Ø§Ø´Ù‡
    if target_id == user_id:
        bot.answer_callback_query(call.id, "Ù†Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒØ¯ Ø¨Ù‡ Ø®ÙˆØ¯ØªÙˆÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú†Øª Ø¨ÙØ±Ø³ØªÛŒØ¯!")
        return

    # Ú†Ú© Ú©Ø±Ø¯Ù† ÙˆØ¬ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø± Ùˆ Ù‡Ø¯Ù
    cursor = conn.cursor()
    cursor.execute("SELECT coins, name, unique_id FROM users WHERE user_id = ?", (user_id,))
    requester = cursor.fetchone()
    cursor.execute("SELECT name, unique_id, status, private_chat_enabled FROM users WHERE user_id = ?", (target_id,))
    target = cursor.fetchone()
    cursor.close()

    if not requester or not target:
        bot.answer_callback_query(call.id, "Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ Ù…Ø®Ø§Ø·Ø¨ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!")
        return

    requester_coins, requester_name, requester_unique_id = requester
    target_name, target_unique_id, target_status, private_chat_enabled = target

    # Ú†Ú© Ú©Ø±Ø¯Ù† Ø­Ø§Ù„Øª Ø³Ú©ÙˆØª
    if private_chat_enabled:
        bot.answer_callback_query(call.id, "Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ø­Ø§Ù„Øª Ø³Ú©ÙˆØª Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù‡ Ùˆ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ø¨Ù‡ Ø§Ùˆ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú†Øª ÙØ±Ø³ØªØ§Ø¯!")
        return

    # Ú†Ú© Ú©Ø±Ø¯Ù† ØªØ¹Ø¯Ø§Ø¯ Ø³Ú©Ù‡â€ŒÙ‡Ø§
    if requester_coins < 2:
        bot.answer_callback_query(call.id, "Ø´Ù…Ø§ Ø³Ú©Ù‡â€ŒÛŒ Ú©Ø§ÙÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯! Ø­Ø¯Ø§Ù‚Ù„ Û² Ø³Ú©Ù‡ Ù†ÛŒØ§Ø² Ø§Ø³Øª.")
        return

    # Ú†Ú© Ú©Ø±Ø¯Ù† ÙˆØ¶Ø¹ÛŒØª Ù‡Ø¯Ù (Ù†Ø¨Ø§ÛŒØ¯ Ø¯Ø± Ú†Øª Ø¨Ø§Ø´Ù‡)
    if target_status == 'chatting':
        bot.answer_callback_query(call.id, "Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ø¯Ø± Ú†Øª Ø§Ø³Øª!")
        return

    # Ú©Ø³Ø± Û² Ø³Ú©Ù‡
    cursor = conn.cursor()
    cursor.execute("UPDATE users SET coins = coins - 2 WHERE user_id = ?", (user_id,))
    conn.commit()
    cursor.close()

    # Ø«Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø± Ø¯ÛŒÚ©Ø´Ù†Ø±ÛŒ Ù…ÙˆÙ‚Øª
    pending_requests[target_id][user_id] = time.time()

    # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù‡Ø¯Ù
    request_text = f"""({requester_name}) /user_{requester_unique_id}
Ø¨Ù‡Øª ÛŒÙ‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú†Øª ÙØ±Ø³ØªØ§Ø¯Ù‡, Ù…ÛŒØªÙˆÙ†ÛŒ Ù‚Ø¨ÙˆÙ„ Ú©Ù†ÛŒ ÛŒØ§ Ø±Ø¯Ø´ Ú©Ù†ÛŒ ğŸ˜‰

ÛŒØ§Ø¯Øª Ø¨Ø§Ø´Ù‡ Ø§ÛŒÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª ØªØ§ Û´ Ø¯Ù‚ÛŒÙ‚Ù‡ Ù…Ø¹ØªØ¨Ø±Ù‡ !

ğŸ’¡Ø¨Ø§ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø­Ø§Ù„Øª Ø³Ú©ÙˆØªØŒ Ú©Ø³ÛŒ Ø§Ù…Ú©Ø§Ù† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú†Øª Ø¨Ù‡ Ø´Ù…Ø§ Ø±Ø§ Ù†Ø®ÙˆØ§Ù‡Ø¯ Ø¯Ø§Ø´Øª ğŸ‘ˆ /silent"""
    markup = types.InlineKeyboardMarkup()
    markup.add(
        types.InlineKeyboardButton("Ù‚Ø¨ÙˆÙ„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª âœ…", callback_data=f'accept_chat_{user_id}'),
        types.InlineKeyboardButton("Ø±Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª âŒ", callback_data=f'reject_chat_{user_id}')
    )
    try:
        bot.send_message(target_id, request_text, reply_markup=markup)
        bot.answer_callback_query(call.id, "Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú†Øª Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù‡Ø¯Ù Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!")
    except telebot.apihelper.ApiTelegramException as e:
        print(f"Error sending chat request to user {target_id}: {e}")
        bot.answer_callback_query(call.id, "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú†Øª!")


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ Ù‚Ø¨ÙˆÙ„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú†Øª
@bot.callback_query_handler(func=lambda call: call.data.startswith('accept_chat_'))
def accept_chat(call):
    user_id = call.from_user.id  # Ú©Ø§Ø±Ø¨Ø± Ù‡Ø¯Ù (Ú©Ø³ÛŒ Ú©Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ùˆ Ù‚Ø¨ÙˆÙ„ Ù…ÛŒâ€ŒÚ©Ù†Ù‡)
    update_last_online(user_id)
    try:
        requester_id = int(call.data.split('_')[-1])  # ÙØ±Ù…Øª: accept_chat_<requester_id>
    except (IndexError, ValueError):
        bot.answer_callback_query(call.id, "Ø®Ø·Ø§: Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª!")
        return

    # Ú†Ú© Ú©Ø±Ø¯Ù† ÙˆØ¬ÙˆØ¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª
    if requester_id not in pending_requests.get(user_id, {}):
        bot.answer_callback_query(call.id, "Ø§ÛŒÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯ÛŒÚ¯Ø± Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª ÛŒØ§ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!")
        return

    # Ú†Ú© Ú©Ø±Ø¯Ù† ÙˆØ¬ÙˆØ¯ Ùˆ ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
    cursor = conn.cursor()
    cursor.execute("SELECT status, name, unique_id FROM users WHERE user_id = ?", (user_id,))
    target = cursor.fetchone()
    cursor.execute("SELECT status, name, unique_id FROM users WHERE user_id = ?", (requester_id,))
    requester = cursor.fetchone()
    cursor.close()

    if not target or not requester:
        bot.answer_callback_query(call.id, "Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!")
        if requester_id in pending_requests[user_id]:
            del pending_requests[user_id][requester_id]
            if not pending_requests[user_id]:
                del pending_requests[user_id]
        return

    target_status, target_name, target_unique_id = target
    requester_status, requester_name, requester_unique_id = requester

    # Ú†Ú© Ú©Ø±Ø¯Ù† ÙˆØ¶Ø¹ÛŒØª (Ù†Ø¨Ø§ÛŒØ¯ Ø¯Ø± Ú†Øª Ø¨Ø§Ø´Ù†)
    if target_status == 'chatting' or requester_status == 'chatting':
        bot.answer_callback_query(call.id, "Ø´Ù…Ø§ ÛŒØ§ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡ Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ø¯Ø± Ú†Øª Ù‡Ø³ØªÛŒØ¯!")
        if requester_id in pending_requests[user_id]:
            del pending_requests[user_id][requester_id]
            if not pending_requests[user_id]:
                del pending_requests[user_id]
        return

    # Ø­Ø°Ù Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø² Ø¯ÛŒÚ©Ø´Ù†Ø±ÛŒ
    del pending_requests[user_id][requester_id]
    if not pending_requests[user_id]:
        del pending_requests[user_id]

    # Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
    cursor = conn.cursor()
    cursor.execute("UPDATE users SET status = 'chatting', partner_id = ? WHERE user_id = ?", (requester_id, user_id))
    cursor.execute("UPDATE users SET status = 'chatting', partner_id = ? WHERE user_id = ?", (user_id, requester_id))
    cursor.execute("INSERT INTO chat_history (user_id, partner_id) VALUES (?, ?)", (user_id, requester_id))
    cursor.execute("INSERT INTO chat_history (user_id, partner_id) VALUES (?, ?)", (requester_id, user_id))
    conn.commit()
    cursor.close()

    # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø´Ø±ÙˆØ¹ Ú†Øª
    start_text_target = f"Ú†Øª Ø¨Ø§ ({requester_name}) /user_{requester_unique_id} Ø´Ø±ÙˆØ¹ Ø´Ø¯! Ø¨Ù‡Ø´ Ø³Ù„Ø§Ù… Ú©Ù† :)\nğŸ¤– Ù¾ÛŒØ§Ù… Ø³ÛŒØ³ØªÙ… ğŸ‘‡ğŸ»\nâš ï¸ Ø§Ø®Ø·Ø§Ø±: Ø¨Ù‡ Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¯Ø± Ø±Ø¨Ø§Øª Ø§Ø¹ØªÙ…Ø§Ø¯ Ù†Ú©Ù†ÛŒØ¯ Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®ØµÛŒØªØ§Ù† Ø±Ø§ Ø¯Ø± Ø§Ø®ØªÛŒØ§Ø± Ú©Ø³ÛŒ Ù‚Ø±Ø§Ø± Ù†Ø¯Ù‡ÛŒØ¯!"
    start_text_requester = f"Ú†Øª Ø¨Ø§ ({target_name}) /user_{target_unique_id} Ø´Ø±ÙˆØ¹ Ø´Ø¯! Ø¨Ù‡Ø´ Ø³Ù„Ø§Ù… Ú©Ù† :)\nğŸ¤– Ù¾ÛŒØ§Ù… Ø³ÛŒØ³ØªÙ… ğŸ‘‡ğŸ»\nâš ï¸ Ø§Ø®Ø·Ø§Ø±: Ø¨Ù‡ Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¯Ø± Ø±Ø¨Ø§Øª Ø§Ø¹ØªÙ…Ø§Ø¯ Ù†Ú©Ù†ÛŒØ¯ Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®ØµÛŒØªØ§Ù† Ø±Ø§ Ø¯Ø± Ø§Ø®ØªÛŒØ§Ø± Ú©Ø³ÛŒ Ù‚Ø±Ø§Ø± Ù†Ø¯Ù‡ÛŒØ¯!"

    # ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ù‡Ø± Ø¯Ùˆ Ú©Ø§Ø±Ø¨Ø±
    target_message_sent = False
    requester_message_sent = False

    # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù‡Ø¯Ù (Ø§ÙˆÙ„ Ø³Ø¹ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ù‡ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù†Ù‡ØŒ Ø§Ú¯Ù‡ Ù†Ø´Ø¯ Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ù…ÛŒâ€ŒÙØ±Ø³ØªÙ‡)
    try:
        bot.edit_message_text(start_text_target, user_id, call.message.message_id, reply_markup=chat_markup)
        target_message_sent = True
    except telebot.apihelper.ApiTelegramException as e:
        print(f"Error editing message for target {user_id}: {e}")
        try:
            bot.send_message(user_id, start_text_target, reply_markup=chat_markup)
            target_message_sent = True
        except telebot.apihelper.ApiTelegramException as e:
            print(f"Error sending new message to target {user_id}: {e}")

    # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡
    try:
        bot.send_message(requester_id, start_text_requester, reply_markup=chat_markup)
        requester_message_sent = True
    except telebot.apihelper.ApiTelegramException as e:
        print(f"Error sending message to requester {requester_id}: {e}")

    # Ø¨Ø±Ø±Ø³ÛŒ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
    if target_message_sent and requester_message_sent:
        bot.answer_callback_query(call.id, "Ú†Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø´Ø±ÙˆØ¹ Ø´Ø¯!")
    else:
        bot.answer_callback_query(call.id, "Ø®Ø·Ø§ Ø¯Ø± Ø´Ø±ÙˆØ¹ Ú†Øª!")
        # Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ØŒ ÙˆØ¶Ø¹ÛŒØª Ø±Ùˆ Ø¨Ø±Ú¯Ø±Ø¯ÙˆÙ†
        cursor = conn.cursor()
        cursor.execute("UPDATE users SET status = 'idle', partner_id = NULL WHERE user_id IN (?, ?)",
                       (user_id, requester_id))
        conn.commit()
        cursor.close()
        if not target_message_sent:
            bot.send_message(user_id, "Ø®Ø·Ø§ Ø¯Ø± Ø´Ø±ÙˆØ¹ Ú†Øª! Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.", reply_markup=main_markup)
        if not requester_message_sent:
            try:
                bot.send_message(requester_id, "Ø®Ø·Ø§ Ø¯Ø± Ø´Ø±ÙˆØ¹ Ú†Øª! Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.", reply_markup=main_markup)
            except telebot.apihelper.ApiTelegramException as e:
                print(f"Error sending error message to requester {requester_id}: {e}")


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ Ø±Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú†Øª
@bot.callback_query_handler(func=lambda call: call.data.startswith('reject_chat_'))
def reject_chat(call):
    user_id = call.from_user.id  # Ú©Ø§Ø±Ø¨Ø± Ù‡Ø¯Ù (Ú©Ø³ÛŒ Ú©Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ùˆ Ø±Ø¯ Ù…ÛŒâ€ŒÚ©Ù†Ù‡)
    try:
        requester_id = int(call.data.split('_')[-1])  # ÙØ±Ù…Øª: reject_chat_<requester_id>
    except (IndexError, ValueError):
        bot.answer_callback_query(call.id, "Ø®Ø·Ø§: Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª!")
        return

    # Ú†Ú© Ú©Ø±Ø¯Ù† ÙˆØ¬ÙˆØ¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª
    if requester_id not in pending_requests.get(user_id, {}):
        bot.answer_callback_query(call.id, "Ø§ÛŒÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯ÛŒÚ¯Ø± Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª ÛŒØ§ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!")
        return

    # Ø­Ø°Ù Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø² Ø¯ÛŒÚ©Ø´Ù†Ø±ÛŒ
    del pending_requests[user_id][requester_id]
    if not pending_requests[user_id]:
        del pending_requests[user_id]

    # Ø§Ø·Ù„Ø§Ø¹ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
    try:
        bot.edit_message_text("Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú†Øª Ø±Ø¯ Ø´Ø¯.", user_id, call.message.message_id, reply_markup=None)
        bot.send_message(requester_id, "Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú†Øª Ø´Ù…Ø§ Ø±Ø¯ Ø´Ø¯.", reply_markup=main_markup)
        bot.answer_callback_query(call.id, "Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú†Øª Ø±Ø¯ Ø´Ø¯!")
    except telebot.apihelper.ApiTelegramException as e:
        print(f"Error rejecting chat for users {user_id} and {requester_id}: {e}")
        bot.answer_callback_query(call.id, "Ø®Ø·Ø§ Ø¯Ø± Ø±Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª!")


# ØªØ§Ø¨Ø¹ Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø¨Ø§ /user_<unique_id>
@bot.message_handler(regexp=r'^/user_([A-Za-z0-9]{8})$')
def show_user_profile_by_unique_id(message):
    user_id = message.from_user.id
    update_last_online(user_id)  # Ø¢Ù¾Ø¯ÛŒØª Ø²Ù…Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†
    unique_id = re.match(r'^/user_([A-Za-z0-9]{8})$', message.text).group(1)

    cursor = conn.cursor()
    cursor.execute(
        "SELECT user_id, name, gender, followers_count, following_count, province, city, age, likes_count, unique_id, profile_photo, coins, last_online FROM users WHERE unique_id = ?",
        (unique_id,))
    user = cursor.fetchone()
    cursor.close()

    if user:
        target_id, name, gender, followers_count, following_count, province, city, age, likes_count, unique_id, profile_photo, coins, last_online = user
        if target_id == user_id:
            bot.send_message(user_id,
                             "Ù†Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒØ¯ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø®ÙˆØ¯ØªÙˆÙ† Ø±Ùˆ Ø¨Ø§ Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ø¨Ø¨ÛŒÙ†ÛŒØ¯! Ø§Ø² 'ğŸ‘¤ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ù†' Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.",
                             reply_markup=main_markup)
            return
        gender_display = "Ù¾Ø³Ø± ğŸ‘¨â€ğŸ¦°" if gender == 'male' else "Ø¯Ø®ØªØ± ğŸ‘©"
        profile_text = f"""â€¢Ù†Ø§Ù…: {name} 
        â€¢Ø¬Ù†Ø³ÛŒØª: {gender_display}
        Ø¯Ù†Ø¨Ø§Ù„ Ú©Ù†Ù†Ø¯Ù‡ Ù‡Ø§: {followers_count}
        Ø¯Ù†Ø¨Ø§Ù„ Ù…ÛŒÚ©Ù†Ø¯: {following_count}
        â€¢Ø§Ø³ØªØ§Ù†: {province or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
        â€¢Ø´Ù‡Ø±: {city or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
        â€¢Ø³Ù†: {age or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
        ğŸ†” : /user_{unique_id}
        ØªØ¹Ø¯Ø§Ø¯ Ù„Ø§ÛŒÚ© Ù‡Ø§ : {likes_count}
        Ø³Ú©Ù‡â€ŒÙ‡Ø§: {coins}
        â€¢ÙˆØ¶Ø¹ÛŒØª: {format_last_online(last_online)}"""

        markup = get_partner_profile_inline_keyboard(user_id, target_id)
        if profile_photo and isinstance(profile_photo, str) and len(profile_photo) > 0:
            try:
                bot.send_photo(user_id, profile_photo, caption=profile_text, reply_markup=markup)
            except telebot.apihelper.ApiTelegramException as e:
                print(f"Error sending profile photo for unique_id {unique_id}: {e} (file_id: {profile_photo})")
                bot.send_message(user_id, profile_text + "\nâš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„!", reply_markup=markup)
        else:
            bot.send_message(user_id, profile_text, reply_markup=markup)
    else:
        bot.send_message(user_id, f"Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø§ Ø¢ÛŒØ¯ÛŒ /user_{unique_id} Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!", reply_markup=main_markup)


# Ù‡Ù†Ø¯Ù„Ø± Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù„Ø§ÛŒÚ© Ú©Ø±Ø¯Ù† Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ø®Ø§Ø·Ø¨
@bot.callback_query_handler(func=lambda call: call.data.startswith('like_partner_'))
def like_partner(call):
    user_id = call.from_user.id
    update_last_online(user_id)
    try:
        partner_id = int(call.data.split('_')[-1])  # ÙØ±Ù…Øª: like_partner_<partner_id>
    except (IndexError, ValueError):
        bot.answer_callback_query(call.id, "Ø®Ø·Ø§: Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª!")
        return

    if partner_id == user_id:
        bot.answer_callback_query(call.id, "Ù†Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒØ¯ Ø®ÙˆØ¯ØªÙˆÙ† Ø±Ùˆ Ù„Ø§ÛŒÚ© Ú©Ù†ÛŒØ¯!")
        return

    cursor = conn.cursor()
    cursor.execute("SELECT COUNT(*) FROM likes WHERE user_id = ? AND target_id = ?", (user_id, partner_id))
    has_liked = cursor.fetchone()[0] > 0

    if has_liked:
        # Unlike
        cursor.execute("DELETE FROM likes WHERE user_id = ? AND target_id = ?", (user_id, partner_id))
        cursor.execute("UPDATE users SET likes_count = likes_count - 1 WHERE user_id = ?", (partner_id,))
        conn.commit()
        bot.answer_callback_query(call.id, "Ù„Ø§ÛŒÚ© Ø´Ù…Ø§ Ø¨Ø±Ø¯Ø§Ø´ØªÙ‡ Ø´Ø¯!")
    else:
        # Like
        try:
            cursor.execute("INSERT INTO likes (user_id, target_id) VALUES (?, ?)", (user_id, partner_id))
            cursor.execute("UPDATE users SET likes_count = likes_count + 1 WHERE user_id = ?", (partner_id,))
            conn.commit()
            bot.answer_callback_query(call.id, "Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù„Ø§ÛŒÚ© Ø´Ø¯!")
        except sqlite3.IntegrityError:
            bot.answer_callback_query(call.id, "Ø´Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ø§ÛŒÙ† Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø±Ø§ Ù„Ø§ÛŒÚ© Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯!")

    # Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ø®Ø§Ø·Ø¨
    cursor.execute(
        "SELECT name, gender, followers_count, following_count, province, city, age, likes_count, unique_id, profile_photo, last_online FROM users WHERE user_id = ?",
        (partner_id,))
    user = cursor.fetchone()
    cursor.close()
    if user:
        p_name, p_gender, p_followers, p_following, p_province, p_city, p_age, p_likes, p_unique, profile_photo, last_online = user
        p_gender_display = "Ù¾Ø³Ø± ğŸ‘¨â€ğŸ¦°" if p_gender == 'male' else "Ø¯Ø®ØªØ± ğŸ‘©"
        profile_text = f"""â€¢Ù†Ø§Ù…: {p_name} 
    â€¢Ø¬Ù†Ø³ÛŒØª: {p_gender_display}
    Ø¯Ù†Ø¨Ø§Ù„ Ú©Ù†Ù†Ø¯Ù‡ Ù‡Ø§: {p_followers}
    Ø¯Ù†Ø¨Ø§Ù„ Ù…ÛŒÚ©Ù†Ø¯: {p_following}
    â€¢Ø§Ø³ØªØ§Ù†: {p_province or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
    â€¢Ø´Ù‡Ø±: {p_city or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
    â€¢Ø³Ù†: {p_age or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
    ğŸ†” : /user_{p_unique}
    ØªØ¹Ø¯Ø§Ø¯ Ù„Ø§ÛŒÚ© Ù‡Ø§ : {p_likes}
    â€¢ÙˆØ¶Ø¹ÛŒØª: {format_last_online(last_online)}"""
        markup = get_partner_profile_inline_keyboard(user_id, partner_id)
        try:
            if profile_photo and isinstance(profile_photo, str) and len(profile_photo) > 0:
                bot.edit_message_media(
                    media=types.InputMediaPhoto(profile_photo, caption=profile_text),
                    chat_id=user_id,
                    message_id=call.message.message_id,
                    reply_markup=markup
                )
            else:
                bot.edit_message_text(
                    text=profile_text,
                    chat_id=user_id,
                    message_id=call.message.message_id,
                    reply_markup=markup
                )
        except telebot.apihelper.ApiTelegramException as e:
            print(f"Error updating partner profile for user {user_id}: {e}")
            bot.send_message(user_id, profile_text, reply_markup=markup)
            bot.answer_callback_query(call.id, "Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„!")


# Ù‡Ù†Ø¯Ù„Ø± Ø´Ø±ÙˆØ¹


# Ù‡Ù†Ø¯Ù„Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ù†
@bot.message_handler(
    func=lambda message: message.text.isdigit() and 13 <= int(message.text) <= 60 or message.text == "Ù„ØºÙˆ âŒ")
def set_age(message):
    user_id = message.from_user.id
    if message.text == "Ù„ØºÙˆ âŒ":
        bot.send_message(user_id, "Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯.", reply_markup=main_markup)
        return

    age = int(message.text)
    cursor.execute("UPDATE users SET age = ? WHERE user_id = ?", (age, user_id))
    conn.commit()

    text = "Ø§Ø² Ú©Ø¯ÙˆÙ… Ø§Ø³ØªØ§Ù† ØŸ\nØ®Ø¨ Ø­Ø§Ù„Ø§ Ú©Ù‡ Ø³Ù†Øª Ø«Ø¨Øª Ø´Ø¯, ÙÙ‚Ø· Ù…ÛŒÙ…ÙˆÙ†Ù‡ Ø§Ø³ØªØ§Ù† Ùˆ Ø´Ù‡Ø±Øª Ú©Ù‡ Ø¨Ù‡Ù… Ø¨Ú¯ÛŒ ØªØ§ Ú©Ø§Ø±Ù…ÙˆÙ† ØªÙ…ÙˆÙ… Ø¨Ø´Ù‡ !"
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    row = []
    for i, prov in enumerate(provinces):
        row.append(prov)
        if len(row) == 3:
            markup.row(*row)
            row = []
    if row:
        markup.row(*row)
    markup.add("Ù„ØºÙˆ âŒ")
    bot.send_message(user_id, text, reply_markup=markup)


# Ù‡Ù†Ø¯Ù„Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø³ØªØ§Ù†
@bot.message_handler(func=lambda message: message.text in provinces or message.text == "Ù„ØºÙˆ âŒ")
def set_province(message):
    user_id = message.from_user.id
    if message.text == "Ù„ØºÙˆ âŒ":
        bot.send_message(user_id, "Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯.", reply_markup=main_markup)
        return

    province = message.text
    cursor.execute("UPDATE users SET province = ? WHERE user_id = ?", (province, user_id))
    conn.commit()

    text = "Ø®Ø¨ Ø­Ø§Ù„Ø§ Ú©Ù‡ Ø§Ø³ØªØ§Ù†Øª Ø«Ø¨Øª Ø´Ø¯, ÙÙ‚Ø· Ù…ÛŒÙ…ÙˆÙ†Ù‡ Ø´Ù‡Ø±Øª Ú©Ù‡ Ø¨Ù‡Ù… Ø¨Ú¯ÛŒ ØªØ§ Ú©Ø§Ø±Ù…ÙˆÙ† ØªÙ…ÙˆÙ… Ø¨Ø´Ù‡ !"
    cities = cities_by_province.get(province, [])
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    row = []
    for city in cities:
        row.append(city)
        if len(row) == 3:
            markup.row(*row)
            row = []
    if row:
        markup.row(*row)
    markup.add("Ù„ØºÙˆ âŒ")
    bot.send_message(user_id, text, reply_markup=markup)


# Ù‡Ù†Ø¯Ù„Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù‡Ø±
@bot.message_handler(func=lambda message: any(
    message.text in cities for cities in cities_by_province.values()) or message.text == "Ù„ØºÙˆ âŒ")
def set_city(message):
    user_id = message.from_user.id
    if message.text == "Ù„ØºÙˆ âŒ":
        bot.send_message(user_id, "Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯.", reply_markup=main_markup)
        return

    city = message.text
    cursor.execute("UPDATE users SET city = ? WHERE user_id = ?", (city, user_id))
    conn.commit()

    text = "ğŸŒŸ Ø®Ø¨ Ø­Ø§Ù„Ø§ ÙÙ‚Ø· Ú©Ø§ÙÛŒÙ‡ ÛŒÙ‡ Ø§Ø³Ù… Ù…Ø³ØªØ¹Ø§Ø± Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ø±Ø¨Ø§Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒ ØªØ§ ÙˆØ§Ø±Ø¯ Ø±Ø¨Ø§Øª Ø´ÛŒÙ…!\nâ€¢ Ø§Ø³Ù… Ù…Ø³ØªØ¹Ø§Ø±ØªÙˆ Ø¨ÙØ±Ø³Øª"
    bot.send_message(user_id, text, reply_markup=types.ReplyKeyboardRemove())
    bot.register_next_step_handler(message, get_name)


def get_name(message):
    user_id = message.from_user.id
    name = message.text
    cursor.execute("SELECT city FROM users WHERE user_id=?", (user_id,))
    if cursor.fetchone()[0]:
        cursor.execute("UPDATE users SET name = ? WHERE user_id = ?", (name, user_id))
        conn.commit()
        welcome = "Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ Ø¹Ø²ÛŒØ² ğŸ³\nØ«Ø¨Øª Ù†Ø§Ù…Øª ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯âœ…"
        bot.send_message(user_id, welcome, reply_markup=main_markup)
    else:
        pass


# ØªØ§Ø¨Ø¹ show_profile (Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ)
# ØªØ§Ø¨Ø¹ show_profile
@bot.message_handler(func=lambda message: message.text == "ğŸ‘¤ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ù†")
def show_profile(message):
    user_id = message.from_user.id
    update_last_online(user_id)  # Ø¢Ù¾Ø¯ÛŒØª Ø²Ù…Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†
    cursor = conn.cursor()
    cursor.execute(
        "SELECT name, gender, followers_count, following_count, province, city, age, likes_count, unique_id, profile_photo, coins, last_online FROM users WHERE user_id=?",
        (user_id,)
    )

    user = cursor.fetchone()
    cursor.close()

    if user:
        name, gender, followers_count, following_count, province, city, age, likes_count, unique_id, profile_photo, coins, last_online = user
        gender_display = "Ù¾Ø³Ø± ğŸ‘¨â€ğŸ¦°" if gender == 'male' else "Ø¯Ø®ØªØ± ğŸ‘©"
        profile_text = f"""â€¢Ù†Ø§Ù…: {name} 
â€¢Ø¬Ù†Ø³ÛŒØª: {gender_display}
Ø¯Ù†Ø¨Ø§Ù„ Ú©Ù†Ù†Ø¯Ù‡ Ù‡Ø§: {followers_count}
Ø¯Ù†Ø¨Ø§Ù„ Ù…ÛŒÚ©Ù†Ø¯: {following_count}
â€¢Ø§Ø³ØªØ§Ù†: {province or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
â€¢Ø´Ù‡Ø±: {city or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
â€¢Ø³Ù†: {age or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
ğŸ†” : /user_{unique_id}
ØªØ¹Ø¯Ø§Ø¯ Ù„Ø§ÛŒÚ© Ù‡Ø§ : {likes_count}
Ø³Ú©Ù‡â€ŒÙ‡Ø§: {coins}
â€¢ÙˆØ¶Ø¹ÛŒØª: {format_last_online(last_online)}"""

        markup = get_profile_inline_keyboard(user_id)
        if profile_photo and isinstance(profile_photo, str) and len(profile_photo) > 0:
            try:
                bot.send_photo(user_id, profile_photo, caption=profile_text, reply_markup=markup)
            except telebot.apihelper.ApiTelegramException as e:
                print(f"Error sending profile photo for user {user_id}: {e} (file_id: {profile_photo})")
                bot.send_message(user_id, profile_text + "\nâš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„!", reply_markup=markup)
        else:
            bot.send_message(user_id, profile_text, reply_markup=markup)
    else:
        bot.send_message(user_id, "Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯! Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø§ /start Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†ÛŒØ¯.", reply_markup=main_markup)


# Ú©Ø§Ù„â€ŒØ¨Ú© Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
@bot.callback_query_handler(func=lambda call: call.data == 'edit_profile')
def edit_profile(call):
    user_id = call.from_user.id
    update_last_online(user_id)
    text = "ÛŒÚ©ÛŒ Ø±Ùˆ Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†."
    markup = types.InlineKeyboardMarkup(row_width=2)
    markup.add(
        types.InlineKeyboardButton("ØªØºÛŒØ± Ù†Ø§Ù… ğŸ“", callback_data='edit_username'),
        types.InlineKeyboardButton("ØªØºÛŒØ± Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ ğŸ–¼", callback_data='edit_photo')
    )
    markup.add(
        types.InlineKeyboardButton("ØªØºÛŒØ± Ø§Ø³ØªØ§Ù† ğŸ—º", callback_data='edit_province'),
        types.InlineKeyboardButton("ØªØºÛŒØ± Ø³Ù† ğŸ‚", callback_data='edit_age')
    )
    markup.add(
        types.InlineKeyboardButton("ØªØºÛŒØ± Ø¬Ù†Ø³ÛŒØª âš¥", callback_data='edit_gender')
    )

    try:
        bot.delete_message(user_id, call.message.message_id)
    except telebot.apihelper.ApiTelegramException as e:
        print(f"Error deleting message: {e}")

    bot.send_message(user_id, text, reply_markup=markup)


# Ú©Ø§Ù„â€ŒØ¨Ú© Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ù†Ø§Ù…
@bot.callback_query_handler(func=lambda call: call.data == 'edit_username')
def request_username(call):
    user_id = call.from_user.id
    text = "Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯."
    reply_markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    reply_markup.add("Ù„ØºÙˆ âŒ")
    bot.send_message(user_id, text, reply_markup=reply_markup)
    bot.register_next_step_handler(call.message, process_username_step, call.message.message_id)


def process_username_step(message, edit_message_id):
    user_id = message.from_user.id
    if message.text == "Ù„ØºÙˆ âŒ":
        bot.send_message(user_id, "Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯.", reply_markup=types.ReplyKeyboardRemove())
        edit_markup = types.InlineKeyboardMarkup(row_width=2)
        edit_markup.add(
            types.InlineKeyboardButton("ØªØºÛŒØ± Ù†Ø§Ù… ğŸ“", callback_data='edit_username'),
            types.InlineKeyboardButton("ØªØºÛŒØ± Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ ğŸ–¼", callback_data='edit_photo')
        )
        edit_markup.add(
            types.InlineKeyboardButton("ØªØºÛŒØ± Ø§Ø³ØªØ§Ù† ğŸ—º", callback_data='edit_province'),
            types.InlineKeyboardButton("ØªØºÛŒØ± Ø³Ù† ğŸ‚", callback_data='edit_age')
        )
        edit_markup.add(
            types.InlineKeyboardButton("ØªØºÛŒØ± Ø¬Ù†Ø³ÛŒØª âš¥", callback_data='edit_gender')
        )
        bot.edit_message_reply_markup(user_id, edit_message_id, reply_markup=edit_markup)
        return

    if message.text:
        new_username = message.text
        cursor.execute("UPDATE users SET name = ? WHERE user_id = ?", (new_username, user_id))
        conn.commit()
        bot.send_message(user_id, "Ù†Ø§Ù… Ø´Ù…Ø§ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯.", reply_markup=types.ReplyKeyboardRemove())
        cursor.execute(
            "SELECT name, gender, followers_count, following_count, province, city, age, likes_count, unique_id, profile_photo, coins, last_online FROM users WHERE user_id=?",
            (user_id,)
        )
        user = cursor.fetchone()
        if user:
            name, gender, followers_count, following_count, province, city, age, likes_count, unique_id, profile_photo, coins, last_online = user
            gender_display = "Ù¾Ø³Ø± ğŸ‘¨â€ğŸ¦°" if gender == 'male' else "Ø¯Ø®ØªØ± ğŸ‘©"
            profile_text = f"""â€¢Ù†Ø§Ù…: {name} 
â€¢Ø¬Ù†Ø³ÛŒØª: {gender_display}
Ø¯Ù†Ø¨Ø§Ù„ Ú©Ù†Ù†Ø¯Ù‡ Ù‡Ø§: {followers_count}
Ø¯Ù†Ø¨Ø§Ù„ Ù…ÛŒÚ©Ù†Ø¯: {following_count}
â€¢Ø§Ø³ØªØ§Ù†: {province or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
â€¢Ø´Ù‡Ø±: {city or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
â€¢Ø³Ù†: {age or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
ğŸ†” : /user_{unique_id}
ØªØ¹Ø¯Ø§Ø¯ Ù„Ø§ÛŒÚ© Ù‡Ø§ : {likes_count}
Ø³Ú©Ù‡â€ŒÙ‡Ø§: {coins}
â€¢ÙˆØ¶Ø¹ÛŒØª: {format_last_online(last_online)}"""
            markup = get_profile_inline_keyboard(user_id)
            if profile_photo and isinstance(profile_photo, str) and len(profile_photo) > 0:
                try:
                    bot.send_photo(user_id, profile_photo, caption=profile_text, reply_markup=markup)
                except telebot.apihelper.ApiTelegramException as e:
                    print(f"Error sending profile photo for user {user_id}: {e} (file_id: {profile_photo})")
                    bot.send_message(user_id, profile_text + "\nâš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„!", reply_markup=markup)
            else:
                bot.send_message(user_id, profile_text, reply_markup=markup)
        else:
            bot.send_message(user_id, "Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!", reply_markup=main_markup)
    else:
        bot.send_message(user_id, "Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ù†Ø§Ù… Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ù„ØºÙˆ Ú©Ù†ÛŒØ¯.")
        bot.register_next_step_handler(message, process_username_step, edit_message_id)


# Ú©Ø§Ù„â€ŒØ¨Ú© Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ø¬Ù†Ø³ÛŒØª
@bot.callback_query_handler(func=lambda call: call.data == 'edit_gender')
def request_gender(call):
    user_id = call.from_user.id
    text = "Ø¬Ù†Ø³ÛŒØª Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:"
    reply_markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    reply_markup.add("Ù¾Ø³Ø± ğŸ‘¨â€ğŸ¦°", "Ø¯Ø®ØªØ± ğŸ‘©")
    reply_markup.add("Ù„ØºÙˆ âŒ")
    bot.send_message(user_id, text, reply_markup=reply_markup)
    bot.register_next_step_handler(call.message, process_gender_step, call.message.message_id)


def process_gender_step(message, edit_message_id):
    user_id = message.from_user.id

    if message.text == "Ù„ØºÙˆ âŒ":
        bot.send_message(user_id, "Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯.", reply_markup=types.ReplyKeyboardRemove())
        edit_markup = types.InlineKeyboardMarkup(row_width=2)
        edit_markup.add(
            types.InlineKeyboardButton("ØªØºÛŒØ± Ù†Ø§Ù… ğŸ“", callback_data='edit_username'),
            types.InlineKeyboardButton("ØªØºÛŒØ± Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ ğŸ–¼", callback_data='edit_photo')
        )
        edit_markup.add(
            types.InlineKeyboardButton("ØªØºÛŒØ± Ø§Ø³ØªØ§Ù† ğŸ—º", callback_data='edit_province'),
            types.InlineKeyboardButton("ØªØºÛŒØ± Ø³Ù† ğŸ‚", callback_data='edit_age')
        )
        edit_markup.add(
            types.InlineKeyboardButton("ØªØºÛŒØ± Ø¬Ù†Ø³ÛŒØª âš¥", callback_data='edit_gender')
        )
        bot.edit_message_reply_markup(user_id, edit_message_id, reply_markup=edit_markup)
        return

    if message.text in ["Ù¾Ø³Ø± ğŸ‘¨â€ğŸ¦°", "Ø¯Ø®ØªØ± ğŸ‘©"]:
        new_gender = 'male' if message.text == "Ù¾Ø³Ø± ğŸ‘¨â€ğŸ¦°" else 'female'
        cursor.execute("UPDATE users SET gender = ? WHERE user_id = ?", (new_gender, user_id))
        conn.commit()
        bot.send_message(user_id, "Ø¬Ù†Ø³ÛŒØª Ø´Ù…Ø§ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯.", reply_markup=types.ReplyKeyboardRemove())
        cursor.execute(
            "SELECT name, gender, followers_count, following_count, province, city, age, likes_count, unique_id, profile_photo, coins, last_online FROM users WHERE user_id=?",
            (user_id,)
        )
        user = cursor.fetchone()
        if user:
            name, gender, followers_count, following_count, province, city, age, likes_count, unique_id, profile_photo, coins, last_online = user
            gender_display = "Ù¾Ø³Ø± ğŸ‘¨â€ğŸ¦°" if gender == 'male' else "Ø¯Ø®ØªØ± ğŸ‘©"
            profile_text = f"""â€¢Ù†Ø§Ù…: {name} 
â€¢Ø¬Ù†Ø³ÛŒØª: {gender_display}
Ø¯Ù†Ø¨Ø§Ù„ Ú©Ù†Ù†Ø¯Ù‡ Ù‡Ø§: {followers_count}
Ø¯Ù†Ø¨Ø§Ù„ Ù…ÛŒÚ©Ù†Ø¯: {following_count}
â€¢Ø§Ø³ØªØ§Ù†: {province or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
â€¢Ø´Ù‡Ø±: {city or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
â€¢Ø³Ù†: {age or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
ğŸ†” : /user_{unique_id}
ØªØ¹Ø¯Ø§Ø¯ Ù„Ø§ÛŒÚ© Ù‡Ø§ : {likes_count}
Ø³Ú©Ù‡â€ŒÙ‡Ø§: {coins}
â€¢ÙˆØ¶Ø¹ÛŒØª: {format_last_online(last_online)}"""
            markup = get_profile_inline_keyboard(user_id)
            if profile_photo and isinstance(profile_photo, str) and len(profile_photo) > 0:
                try:
                    bot.send_photo(user_id, profile_photo, caption=profile_text, reply_markup=markup)
                except telebot.apihelper.ApiTelegramException as e:
                    print(f"Error sending profile photo for user {user_id}: {e} (file_id: {profile_photo})")
                    bot.send_message(user_id, profile_text + "\nâš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„!", reply_markup=markup)
            else:
                bot.send_message(user_id, profile_text, reply_markup=markup)
    else:
        bot.send_message(user_id, "Ù„Ø·ÙØ§Ù‹ ÛŒÚ©ÛŒ Ø§Ø² Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¬Ù†Ø³ÛŒØª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ù„ØºÙˆ Ú©Ù†ÛŒØ¯.")
        bot.register_next_step_handler(message, process_gender_step, edit_message_id)


# Ú©Ø§Ù„â€ŒØ¨Ú© Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
@bot.callback_query_handler(func=lambda call: call.data == 'edit_photo')
def request_profile_photo(call):
    user_id = call.from_user.id
    text = "ğŸ Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯."
    reply_markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    reply_markup.add("Ù„ØºÙˆ âŒ")
    bot.send_message(user_id, text, reply_markup=reply_markup)
    bot.register_next_step_handler(call.message, process_photo_step, call.message.message_id)


def process_photo_step(message, edit_message_id):
    user_id = message.from_user.id
    update_last_online(user_id)  # Ø¢Ù¾Ø¯ÛŒØª Ø²Ù…Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†
    if message.text == "Ù„ØºÙˆ âŒ":
        bot.send_message(user_id, "Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯.", reply_markup=types.ReplyKeyboardRemove())
        edit_markup = types.InlineKeyboardMarkup(row_width=2)
        edit_markup.add(
            types.InlineKeyboardButton("ØªØºÛŒØ± Ù†Ø§Ù… ğŸ“", callback_data='edit_username'),
            types.InlineKeyboardButton("ØªØºÛŒØ± Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ ğŸ–¼", callback_data='edit_photo')
        )
        edit_markup.add(
            types.InlineKeyboardButton("ØªØºÛŒØ± Ø§Ø³ØªØ§Ù† ğŸ—º", callback_data='edit_province'),
            types.InlineKeyboardButton("ØªØºÛŒØ± Ø³Ù† ğŸ‚", callback_data='edit_age')
        )
        edit_markup.add(
            types.InlineKeyboardButton("ØªØºÛŒØ± Ø¬Ù†Ø³ÛŒØª âš¥", callback_data='edit_gender')
        )
        bot.edit_message_reply_markup(user_id, edit_message_id, reply_markup=edit_markup)
        return

    if message.photo:
        photo_id = message.photo[-1].file_id
        print(f"Storing photo_id for user {user_id}: {photo_id}")
        cursor = conn.cursor()
        cursor.execute("UPDATE users SET profile_photo = ? WHERE user_id = ?", (photo_id, user_id))
        conn.commit()
        cursor.execute(
            "SELECT name, gender, followers_count, following_count, province, city, age, likes_count, unique_id, profile_photo, coins, last_online FROM users WHERE user_id=?",
            (user_id,)
        )
        user = cursor.fetchone()
        cursor.close()

        if user:
            name, gender, followers_count, following_count, province, city, age, likes_count, unique_id, profile_photo, coins, last_online = user
            gender_display = "Ù¾Ø³Ø± ğŸ‘¨â€ğŸ¦°" if gender == 'male' else "Ø¯Ø®ØªØ± ğŸ‘©"
            profile_text = f"""â€¢Ù†Ø§Ù…: {name} 
â€¢Ø¬Ù†Ø³ÛŒØª: {gender_display}
Ø¯Ù†Ø¨Ø§Ù„ Ú©Ù†Ù†Ø¯Ù‡ Ù‡Ø§: {followers_count}
Ø¯Ù†Ø¨Ø§Ù„ Ù…ÛŒÚ©Ù†Ø¯: {following_count}
â€¢Ø§Ø³ØªØ§Ù†: {province or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
â€¢Ø´Ù‡Ø±: {city or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
â€¢Ø³Ù†: {age or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
ğŸ†” : /user_{unique_id}
ØªØ¹Ø¯Ø§Ø¯ Ù„Ø§ÛŒÚ© Ù‡Ø§ : {likes_count}
Ø³Ú©Ù‡â€ŒÙ‡Ø§: {coins}
â€¢ÙˆØ¶Ø¹ÛŒØª: {format_last_online(last_online)}"""
            markup = get_profile_inline_keyboard(user_id)  # Ø§ØµÙ„Ø§Ø­ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ ØªØ§Ø¨Ø¹ Ø¨Ø§ Ø¢Ø±Ú¯ÙˆÙ…Ø§Ù† user_id
            bot.send_message(user_id, "ØªØµÙˆÛŒØ± Ø´Ù…Ø§ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯", reply_markup=types.ReplyKeyboardRemove())
            if profile_photo and isinstance(profile_photo, str) and len(profile_photo) > 0:
                try:
                    bot.send_photo(user_id, profile_photo, caption=profile_text, reply_markup=markup)
                except telebot.apihelper.ApiTelegramException as e:
                    print(f"Error sending profile photo for user {user_id}: {e} (file_id: {profile_photo})")
                    bot.send_message(user_id, profile_text + "\nâš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„!", reply_markup=markup)
            else:
                bot.send_message(user_id, profile_text, reply_markup=markup)
        else:
            bot.send_message(user_id, "Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯! Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø§ /start Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†ÛŒØ¯.",
                             reply_markup=main_markup)
    else:
        bot.send_message(user_id, "Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ø¹Ú©Ø³ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ù„ØºÙˆ Ú©Ù†ÛŒØ¯.")
        bot.register_next_step_handler(message, process_photo_step, edit_message_id)


# Ú©Ø§Ù„â€ŒØ¨Ú© Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ø§Ø³ØªØ§Ù†
@bot.callback_query_handler(func=lambda call: call.data == 'edit_province')
def request_province(call):
    user_id = call.from_user.id
    text = "Ø§Ø² Ú©Ø¯ÙˆÙ… Ø§Ø³ØªØ§Ù†ØŸ"
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    row = []
    for i, prov in enumerate(provinces):
        row.append(prov)
        if len(row) == 3:
            markup.row(*row)
            row = []
    if row:
        markup.row(*row)
    markup.add("Ù„ØºÙˆ âŒ")
    bot.send_message(user_id, text, reply_markup=markup)
    bot.register_next_step_handler(call.message, process_province_step, call.message.message_id)


def process_province_step(message, edit_message_id):
    user_id = message.from_user.id
    if message.text == "Ù„ØºÙˆ âŒ":
        bot.send_message(user_id, "Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯.", reply_markup=types.ReplyKeyboardRemove())
        edit_markup = types.InlineKeyboardMarkup(row_width=2)
        edit_markup.add(
            types.InlineKeyboardButton("ØªØºÛŒØ± Ù†Ø§Ù… ğŸ“", callback_data='edit_username'),
            types.InlineKeyboardButton("ØªØºÛŒØ± Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ ğŸ–¼", callback_data='edit_photo')
        )
        edit_markup.add(
            types.InlineKeyboardButton("ØªØºÛŒØ± Ø§Ø³ØªØ§Ù† ğŸ—º", callback_data='edit_province'),
            types.InlineKeyboardButton("ØªØºÛŒØ± Ø³Ù† ğŸ‚", callback_data='edit_age')
        )
        edit_markup.add(
            types.InlineKeyboardButton("ØªØºÛŒØ± Ø¬Ù†Ø³ÛŒØª âš¥", callback_data='edit_gender')
        )
        bot.edit_message_reply_markup(user_id, edit_message_id, reply_markup=edit_markup)
        return

    if message.text in provinces:
        province = message.text
        cursor.execute("UPDATE users SET province = ? WHERE user_id = ?", (province, user_id))
        conn.commit()
        text = "Ø®Ø¨ Ø­Ø§Ù„Ø§ Ø´Ù‡Ø± Ø¬Ø¯ÛŒØ¯Øª Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:"
        cities = cities_by_province.get(province, [])
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
        row = []
        for city in cities:
            row.append(city)
            if len(row) == 3:
                markup.row(*row)
                row = []
        if row:
            markup.row(*row)
        markup.add("Ù„ØºÙˆ âŒ")
        bot.send_message(user_id, text, reply_markup=markup)
        bot.register_next_step_handler(message, process_city_step, edit_message_id)
    else:
        bot.send_message(user_id, "Ù„Ø·ÙØ§Ù‹ ÛŒÚ©ÛŒ Ø§Ø² Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§ Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† ÛŒØ§ Ù„ØºÙˆ Ú©Ù†.")
        bot.register_next_step_handler(message, process_province_step, edit_message_id)


def process_city_step(message, edit_message_id):
    user_id = message.from_user.id
    if message.text == "Ù„ØºÙˆ âŒ":
        bot.send_message(user_id, "Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯.", reply_markup=types.ReplyKeyboardRemove())
        edit_markup = types.InlineKeyboardMarkup(row_width=2)
        edit_markup.add(
            types.InlineKeyboardButton("ØªØºÛŒØ± Ù†Ø§Ù… ğŸ“", callback_data='edit_username'),
            types.InlineKeyboardButton("ØªØºÛŒØ± Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ ğŸ–¼", callback_data='edit_photo')
        )
        edit_markup.add(
            types.InlineKeyboardButton("ØªØºÛŒØ± Ø§Ø³ØªØ§Ù† ğŸ—º", callback_data='edit_province'),
            types.InlineKeyboardButton("ØªØºÛŒØ± Ø³Ù† ğŸ‚", callback_data='edit_age')
        )
        edit_markup.add(
            types.InlineKeyboardButton("ØªØºÛŒØ± Ø¬Ù†Ø³ÛŒØª âš¥", callback_data='edit_gender')
        )
        bot.edit_message_reply_markup(user_id, edit_message_id, reply_markup=edit_markup)
        return

    if any(message.text in cities for cities in cities_by_province.values()):
        city = message.text
        cursor.execute("UPDATE users SET city = ? WHERE user_id = ?", (city, user_id))
        conn.commit()
        bot.send_message(user_id, "Ø§Ø³ØªØ§Ù† Ùˆ Ø´Ù‡Ø± Ø´Ù…Ø§ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯.", reply_markup=types.ReplyKeyboardRemove())
        cursor.execute(
            "SELECT name, gender, followers_count, following_count, province, city, age, likes_count, unique_id, profile_photo, coins, last_online FROM users WHERE user_id=?",
            (user_id,)
        )
        user = cursor.fetchone()
        if user:
            name, gender, followers_count, following_count, province, city, age, likes_count, unique_id, profile_photo, coins, last_online = user
            gender_display = "Ù¾Ø³Ø± ğŸ‘¨â€ğŸ¦°" if gender == 'male' else "Ø¯Ø®ØªØ± ğŸ‘©"
            profile_text = f"""â€¢Ù†Ø§Ù…: {name} 
â€¢Ø¬Ù†Ø³ÛŒØª: {gender_display}
Ø¯Ù†Ø¨Ø§Ù„ Ú©Ù†Ù†Ø¯Ù‡ Ù‡Ø§: {followers_count}
Ø¯Ù†Ø¨Ø§Ù„ Ù…ÛŒÚ©Ù†Ø¯: {following_count}
â€¢Ø§Ø³ØªØ§Ù†: {province or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
â€¢Ø´Ù‡Ø±: {city or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
â€¢Ø³Ù†: {age or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
ğŸ†” : /user_{unique_id}
ØªØ¹Ø¯Ø§Ø¯ Ù„Ø§ÛŒÚ© Ù‡Ø§ : {likes_count}
Ø³Ú©Ù‡â€ŒÙ‡Ø§: {coins}
â€¢ÙˆØ¶Ø¹ÛŒØª: {format_last_online(last_online)}"""
            markup = get_profile_inline_keyboard(user_id)
            if profile_photo and isinstance(profile_photo, str) and len(profile_photo) > 0:
                try:
                    bot.send_photo(user_id, profile_photo, caption=profile_text, reply_markup=markup)
                except telebot.apihelper.ApiTelegramException as e:
                    print(f"Error sending profile photo for user {user_id}: {e} (file_id: {profile_photo})")
                    bot.send_message(user_id, profile_text + "\nâš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„!", reply_markup=markup)
            else:
                bot.send_message(user_id, profile_text, reply_markup=markup)
    else:
        bot.send_message(user_id, "Ù„Ø·ÙØ§Ù‹ ÛŒÚ©ÛŒ Ø§Ø² Ø´Ù‡Ø±Ù‡Ø§ Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† ÛŒØ§ Ù„ØºÙˆ Ú©Ù†.")
        bot.register_next_step_handler(message, process_city_step, edit_message_id)


# Ú©Ø§Ù„â€ŒØ¨Ú© Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ø³Ù†
@bot.callback_query_handler(func=lambda call: call.data == 'edit_age')
def request_age(call):
    user_id = call.from_user.id
    text = "Ø³Ù† Ø¬Ø¯ÛŒØ¯ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:"
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    row = []
    for age in range(13, 61):
        row.append(str(age))
        if len(row) == 7:
            markup.row(*row)
            row = []
    if row:
        markup.row(*row)
    markup.add("Ù„ØºÙˆ âŒ")
    bot.send_message(user_id, text, reply_markup=markup)
    bot.register_next_step_handler(call.message, process_age_step, call.message.message_id)


def process_age_step(message, edit_message_id):
    user_id = message.from_user.id
    if message.text == "Ù„ØºÙˆ âŒ":
        bot.send_message(user_id, "Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯.", reply_markup=types.ReplyKeyboardRemove())
        edit_markup = types.InlineKeyboardMarkup(row_width=2)
        edit_markup.add(
            types.InlineKeyboardButton("ØªØºÛŒØ± Ù†Ø§Ù… ğŸ“", callback_data='edit_username'),
            types.InlineKeyboardButton("ØªØºÛŒØ± Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ ğŸ–¼", callback_data='edit_photo')
        )
        edit_markup.add(
            types.InlineKeyboardButton("ØªØºÛŒØ± Ø§Ø³ØªØ§Ù† ğŸ—º", callback_data='edit_province'),
            types.InlineKeyboardButton("ØªØºÛŒØ± Ø³Ù† ğŸ‚", callback_data='edit_age')
        )
        edit_markup.add(
            types.InlineKeyboardButton("ØªØºÛŒØ± Ø¬Ù†Ø³ÛŒØª âš¥", callback_data='edit_gender')
        )
        bot.edit_message_reply_markup(user_id, edit_message_id, reply_markup=edit_markup)
        return

    if message.text.isdigit() and 13 <= int(message.text) <= 60:
        new_age = int(message.text)
        cursor.execute("UPDATE users SET age = ? WHERE user_id = ?", (new_age, user_id))
        conn.commit()
        bot.send_message(user_id, "Ø³Ù† Ø´Ù…Ø§ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯.", reply_markup=types.ReplyKeyboardRemove())
        cursor.execute(
            "SELECT name, gender, followers_count, following_count, province, city, age, likes_count, unique_id, profile_photo, coins, last_online FROM users WHERE user_id=?",
            (user_id,)
        )
        user = cursor.fetchone()
        if user:
            name, gender, followers_count, following_count, province, city, age, likes_count, unique_id, profile_photo, coins, last_online = user
            gender_display = "Ù¾Ø³Ø± ğŸ‘¨â€ğŸ¦°" if gender == 'male' else "Ø¯Ø®ØªØ± ğŸ‘©"
            profile_text = f"""â€¢Ù†Ø§Ù…: {name} 
â€¢Ø¬Ù†Ø³ÛŒØª: {gender_display}
Ø¯Ù†Ø¨Ø§Ù„ Ú©Ù†Ù†Ø¯Ù‡ Ù‡Ø§: {followers_count}
Ø¯Ù†Ø¨Ø§Ù„ Ù…ÛŒÚ©Ù†Ø¯: {following_count}
â€¢Ø§Ø³ØªØ§Ù†: {province or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
â€¢Ø´Ù‡Ø±: {city or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
â€¢Ø³Ù†: {age or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
ğŸ†” : /user_{unique_id}
ØªØ¹Ø¯Ø§Ø¯ Ù„Ø§ÛŒÚ© Ù‡Ø§ : {likes_count}
Ø³Ú©Ù‡â€ŒÙ‡Ø§: {coins}
â€¢ÙˆØ¶Ø¹ÛŒØª: {format_last_online(last_online)}"""
            markup = get_profile_inline_keyboard(user_id)
            if profile_photo and isinstance(profile_photo, str) and len(profile_photo) > 0:
                try:
                    bot.send_photo(user_id, profile_photo, caption=profile_text, reply_markup=markup)
                except telebot.apihelper.ApiTelegramException as e:
                    print(f"Error sending profile photo for user {user_id}: {e} (file_id: {profile_photo})")
                    bot.send_message(user_id, profile_text + "\nâš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„!", reply_markup=markup)
            else:
                bot.send_message(user_id, profile_text, reply_markup=markup)
    else:
        bot.send_message(user_id, "Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ø³Ù† Ù…Ø¹ØªØ¨Ø± (Ø¨ÛŒÙ† 13 ØªØ§ 60) Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ù„ØºÙˆ Ú©Ù†ÛŒØ¯.")
        bot.register_next_step_handler(message, process_age_step, edit_message_id)


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ "ğŸ”—Ø¨Ù‡ ÛŒÙ‡ Ù†Ø§Ø´Ù†Ø§Ø³ ÙˆØµÙ„Ù… Ú©Ù†!"
@bot.message_handler(func=lambda message: message.text == "ğŸ”—Ø¨Ù‡ ÛŒÙ‡ Ù†Ø§Ø´Ù†Ø§Ø³ ÙˆØµÙ„Ù… Ú©Ù†!")
def connect_anonymous(message):
    user_id = message.from_user.id
    text = "Ú©ÛŒÙˆ Ù¾ÛŒØ¯Ø§ Ú©Ù†Ù… Ø¨Ø±Ø§ØªØŸğŸ¤¨ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ğŸ‘‡"
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("Ø¬Ø³ØªØ¬ÙˆÛŒ Ø´Ø§Ù†Ø³ÛŒ ğŸ²", callback_data='random_search'))
    markup.add(types.InlineKeyboardButton("Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¯Ø®ØªØ± ğŸ‘©", callback_data='girl'),
               types.InlineKeyboardButton("Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾Ø³Ø± ğŸ§‘", callback_data='boy'))
    markup.add(types.InlineKeyboardButton("Ø¬Ø³ØªØ¬ÙˆÛŒ Ù‡Ù… Ø³Ù†: âŒ ØºÛŒØ± ÙØ¹Ø§Ù„ ", callback_data="same_age"))
    bot.send_message(user_id, text, reply_markup=markup)


same_age_status = defaultdict(lambda: False)  # Ù¾ÛŒØ´â€ŒÙØ±Ø¶ ØºÛŒØ±ÙØ¹Ø§Ù„


# ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø¨Ø§ Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù‡Ù… Ø³Ù†
def create_same_age_keyboard(user_id):
    status = same_age_status[user_id]
    button_text = "Ø¬Ø³ØªØ¬ÙˆÛŒ Ù‡Ù… Ø³Ù†: âœ… ÙØ¹Ø§Ù„" if status else "Ø¬Ø³ØªØ¬ÙˆÛŒ Ù‡Ù… Ø³Ù†: âŒ ØºÛŒØ± ÙØ¹Ø§Ù„"
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("Ø¬Ø³ØªØ¬ÙˆÛŒ Ø´Ø§Ù†Ø³ÛŒ ğŸ²", callback_data='random_search'))
    markup.add(types.InlineKeyboardButton("Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¯Ø®ØªØ± ğŸ‘©", callback_data='girl'),
               types.InlineKeyboardButton("Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾Ø³Ø± ğŸ§‘", callback_data='boy'))
    markup.add(types.InlineKeyboardButton(button_text, callback_data="same_age"))

    return markup


# Ù‡Ù†Ø¯Ù„Ø± ÙØ±Ø¶ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù…Ù†ÙˆÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª (ÛŒØ§ Ù‡Ø± Ù¾ÛŒØ§Ù… Ú©Ù‡ Ø¯Ú©Ù…Ù‡ Ø±Ùˆ Ù†Ø´ÙˆÙ† Ù…ÛŒâ€ŒØ¯Ù‡)
@bot.message_handler(func=lambda message: message.text == "ØªÙ†Ø¸ÛŒÙ…Ø§Øª")  # ÙØ±Ø¶Ø§Ù‹ Ø¯Ú©Ù…Ù‡â€ŒÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª
def show_settings(message):
    user_id = message.from_user.id
    update_last_online(user_id)  # ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù‡

    text = "âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¬Ø³ØªØ¬Ùˆ\nÙˆØ¶Ø¹ÛŒØª Ø¬Ø³ØªØ¬ÙˆÛŒ Ù‡Ù… Ø³Ù† Ø±Ùˆ Ø§Ø² Ø§ÛŒÙ†Ø¬Ø§ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ ØªØºÛŒÛŒØ± Ø¨Ø¯ÛŒ:"
    bot.send_message(user_id, text, reply_markup=create_same_age_keyboard(user_id))


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø¬Ø³ØªØ¬ÙˆÛŒ Ù‡Ù… Ø³Ù†
@bot.callback_query_handler(func=lambda call: call.data == "same_age")
def toggle_same_age(call):
    user_id = call.from_user.id
    update_last_online(user_id)

    # ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª (toggle)
    same_age_status[user_id] = not same_age_status[user_id]
    status_text = "ÙØ¹Ø§Ù„" if same_age_status[user_id] else "ØºÛŒØ± ÙØ¹Ø§Ù„"

    # ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø¨Ø§ Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯
    text = "Ú©ÛŒÙˆ Ù¾ÛŒØ¯Ø§ Ú©Ù†Ù… Ø¨Ø±Ø§ØªØŸğŸ¤¨ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ğŸ‘‡"

    try:
        bot.edit_message_text(
            text,
            chat_id=user_id,
            message_id=call.message.message_id,
            parse_mode="HTML",
            reply_markup=create_same_age_keyboard(user_id)
        )
    except telebot.apihelper.ApiTelegramException as e:
        print(f"Error editing message for user {user_id}: {e}")
        bot.send_message(user_id, text, parse_mode="HTML", reply_markup=create_same_age_keyboard(user_id))

    bot.answer_callback_query(call.id, f"Ø¬Ø³ØªØ¬ÙˆÛŒ Ù‡Ù… Ø³Ù† {status_text} Ø´Ø¯!")


import logging

# ØªÙ†Ø¸ÛŒÙ… Ù„Ø§Ú¯â€ŒÚ¯ÛŒØ±ÛŒ
logging.basicConfig(level=logging.DEBUG, filename='chatbot.log', format='%(asctime)s - %(levelname)s - %(message)s')

# Ù…Ø³ÛŒØ± Ù…Ø·Ù„Ù‚ Ø¨Ø±Ø§ÛŒ ÙØ§ÛŒÙ„ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡
DB_PATH = os.path.abspath(os.path.join(os.path.dirname(__file__), 'chatbot.db'))

# Ù‚ÙÙ„ Ø³Ø±Ø§Ø³Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Race Condition
search_lock = threading.Lock()


@bot.callback_query_handler(func=lambda call: call.data == 'random_search')
def start_random_search(call):
    user_id = call.from_user.id

    # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§ØªØµØ§Ù„ Ø§Ø®ØªØµØ§ØµÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª
    local_conn = sqlite3.connect(DB_PATH, check_same_thread=False)
    local_conn.execute('PRAGMA journal_mode=WAL;')
    local_cursor = local_conn.cursor()

    try:
        with search_lock:
            local_cursor.execute("BEGIN IMMEDIATE")
            # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ Ú©Ø§Ø±Ø¨Ø±
            local_cursor.execute("SELECT status, partner_id FROM users WHERE user_id = ?", (user_id,))
            user_status = local_cursor.fetchone()
            if user_status and (user_status[0] == 'chatting' or user_status[1] is not None):
                local_conn.rollback()
                bot.send_message(user_id, "Ø´Ù…Ø§ Ø¯Ø± Ø­Ø§Ù„ Ú†Øª Ù‡Ø³ØªÛŒØ¯! Ù„Ø·ÙØ§Ù‹ Ú†Øª ÙØ¹Ù„ÛŒ Ø±Ø§ Ù¾Ø§ÛŒØ§Ù† Ø¯Ù‡ÛŒØ¯.", reply_markup=main_markup)
                logging.debug(f"User {user_id} tried to start search while in chatting state")
                return

            # Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¨Ù‡ searching
            local_cursor.execute("UPDATE users SET status = 'searching', partner_id = NULL WHERE user_id = ?",
                                 (user_id,))
            local_conn.commit()
    except Exception as e:
        logging.error(f"Error in start_random_search for user {user_id}: {e}")
        local_conn.rollback()
        bot.send_message(user_id, "Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.", reply_markup=main_markup)
        return
    finally:
        local_cursor.close()
        local_conn.close()

    text = "ğŸ” Ø¯Ø±Ø­Ø§Ù„ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø®Ø§Ø·Ø¨ Ù†Ø§Ø´Ù†Ø§Ø³ Ø´Ù…Ø§\nğŸ² Ø¬Ø³ØªØ¬ÙˆÛŒ Ø´Ø§Ù†Ø³ÛŒ\nâ³ Ø­Ø¯Ø§Ú©Ø«Ø± ØªØ§ 2 Ø¯Ù‚ÛŒÙ‚Ù‡ ØµØ¨Ø± Ú©Ù†ÛŒØ¯."
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("Ù„ØºÙˆ Ø¬Ø³ØªØ¬Ùˆ", callback_data='cancel_search'))
    try:
        bot.edit_message_text(text, user_id, call.message.message_id, reply_markup=markup)
    except Exception as e:
        logging.error(f"Error editing message for user {user_id}: {e}")
        bot.send_message(user_id, text, reply_markup=markup)

    threading.Thread(target=search_partner_random, args=(user_id, bot)).start()


def search_partner_random(user_id, bot):
    start_time = time.time()
    max_search_time = 120  # Ø­Ø¯Ø§Ú©Ø«Ø± 2 Ø¯Ù‚ÛŒÙ‚Ù‡

    # Ø§ÛŒØ¬Ø§Ø¯ Ø§ØªØµØ§Ù„ Ø§Ø®ØªØµØ§ØµÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù†Ø®
    local_conn = sqlite3.connect(DB_PATH, check_same_thread=False)
    local_conn.execute('PRAGMA journal_mode=WAL;')
    local_cursor = local_conn.cursor()

    try:
        logging.debug(f"Starting random search for user {user_id}")
        while time.time() - start_time < max_search_time:
            with search_lock:
                local_cursor.execute("BEGIN IMMEDIATE")

                # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ù„ÛŒ
                local_cursor.execute("SELECT status, partner_id FROM users WHERE user_id = ?", (user_id,))
                user_status = local_cursor.fetchone()
                if not user_status or user_status[0] != 'searching' or user_status[1] is not None:
                    local_conn.rollback()
                    bot.send_message(user_id, "Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø³Ù„Ø§Ù… Ú©Ù†", reply_markup=chat_markup)
                    logging.debug(
                        f"Search cancelled for user {user_id}: status={user_status[0] if user_status else None}, partner_id={user_status[1] if user_status else None}")
                    return

                # Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø± Ù…Ù†Ø§Ø³Ø¨
                local_cursor.execute("""
                    SELECT user_id 
                    FROM users 
                    WHERE status = 'searching' 
                    AND user_id != ? 
                    AND partner_id IS NULL 
                    AND user_id NOT IN (SELECT blocked_id FROM block WHERE blocker_id = ?)
                    LIMIT 1
                """, (user_id, user_id))
                partner = local_cursor.fetchone()

                if partner:
                    partner_id = partner[0]
                    logging.debug(f"Found potential partner {partner_id} for user {user_id}")

                    # Ø¨Ø±Ø±Ø³ÛŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ÙˆØ¶Ø¹ÛŒØª Ù¾Ø§Ø±ØªÙ†Ø± Ø¨Ø§ Ù‚ÙÙ„
                    local_cursor.execute("SELECT status, partner_id FROM users WHERE user_id = ?", (partner_id,))
                    partner_status = local_cursor.fetchone()
                    if not partner_status or partner_status[0] != 'searching' or partner_status[1] is not None:
                        local_conn.rollback()
                        logging.debug(
                            f"Partner {partner_id} invalid: status={partner_status[0] if partner_status else None}, partner_id={partner_status[1] if partner_status else None}")
                        time.sleep(0.1)
                        continue

                    # Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§ØªÙ…ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¯Ùˆ Ú©Ø§Ø±Ø¨Ø±
                    local_cursor.execute("UPDATE users SET status = 'chatting', partner_id = ? WHERE user_id = ?",
                                         (partner_id, user_id))
                    local_cursor.execute("UPDATE users SET status = 'chatting', partner_id = ? WHERE user_id = ?",
                                         (user_id, partner_id))
                    local_cursor.execute("INSERT INTO chat_history (user_id, partner_id) VALUES (?, ?)",
                                         (user_id, partner_id))
                    local_cursor.execute("INSERT INTO chat_history (user_id, partner_id) VALUES (?, ?)",
                                         (partner_id, user_id))
                    local_cursor.execute("UPDATE users SET last_online = ? WHERE user_id = ?",
                                         (datetime.now().strftime('%Y-%m-%d %H:%M:%S'), user_id))
                    local_cursor.execute("UPDATE users SET last_online = ? WHERE user_id = ?",
                                         (datetime.now().strftime('%Y-%m-%d %H:%M:%S'), partner_id))
                    local_conn.commit()
                    logging.info(f"Chat started between {user_id} and {partner_id}")

                    # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ù‡Ø± Ø¯Ùˆ Ú©Ø§Ø±Ø¨Ø±
                    local_cursor.execute("SELECT name, unique_id FROM users WHERE user_id = ?", (partner_id,))
                    partner_name, partner_unique = local_cursor.fetchone()
                    start_text_user = (f"Ú†Øª Ø¨Ø§ ({partner_name}) /user_{partner_unique} Ø´Ø±ÙˆØ¹ Ø´Ø¯! "
                                       "Ø¨Ù‡Ø´ Ø³Ù„Ø§Ù… Ú©Ù† :)\nğŸ¤– Ù¾ÛŒØ§Ù… Ø³ÛŒØ³ØªÙ… ğŸ‘‡ğŸ»\n"
                                       "âš ï¸ Ø§Ø®Ø·Ø§Ø±: Ø¨Ù‡ Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¯Ø± Ø±Ø¨Ø§Øª Ø§Ø¹ØªÙ…Ø§Ø¯ Ù†Ú©Ù†ÛŒØ¯ Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®ØµÛŒØªØ§Ù† Ø±Ø§ Ø¯Ø± Ø§Ø®ØªÛŒØ§Ø± Ú©Ø³ÛŒ Ù‚Ø±Ø§Ø± Ù†Ø¯Ù‡ÛŒØ¯!")
                    bot.send_message(user_id, start_text_user, reply_markup=chat_markup)

                    local_cursor.execute("SELECT name, unique_id FROM users WHERE user_id = ?", (user_id,))
                    user_name, user_unique = local_cursor.fetchone()
                    start_text_partner = (f"Ú†Øª Ø¨Ø§ ({user_name}) /user_{user_unique} Ø´Ø±ÙˆØ¹ Ø´Ø¯! "
                                          "Ø¨Ù‡Ø´ Ø³Ù„Ø§Ù… Ú©Ù† :)\nğŸ¤– Ù¾ÛŒØ§Ù… Ø³ÛŒØ³ØªÙ… ğŸ‘‡ğŸ»\n"
                                          "âš ï¸ Ø§Ø®Ø·Ø§Ø±: Ø¨Ù‡ Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¯Ø± Ø±Ø¨Ø§Øª Ø§Ø¹ØªÙ…Ø§Ø¯ Ù†Ú©Ù†ÛŒØ¯ Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®ØµÛŒØªØ§Ù† Ø±Ø§ Ø¯Ø± Ø§Ø®ØªÛŒØ§Ø± Ú©Ø³ÛŒ Ù‚Ø±Ø§Ø± Ù†Ø¯Ù‡ÛŒØ¯!")
                    bot.send_message(partner_id, start_text_partner, reply_markup=chat_markup)

                    return

                local_conn.rollback()
            time.sleep(0.1)  # Ú©Ø§Ù‡Ø´ ÙØ§ØµÙ„Ù‡ Ø¨Ø±Ø§ÛŒ ÙˆØ§Ú©Ù†Ø´ Ø³Ø±ÛŒØ¹â€ŒØªØ±

        # Ø§Ú¯Ø± Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯
        with search_lock:
            local_cursor.execute("UPDATE users SET status = 'idle', partner_id = NULL WHERE user_id = ?", (user_id,))
            local_conn.commit()
        bot.send_message(user_id, "Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ú©Ø³ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ ğŸ˜” Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†!", reply_markup=main_markup)
        logging.debug(f"No partner found for user {user_id}")

    except Exception as e:
        logging.error(f"Error in search_partner_random for user {user_id}: {e}")
        local_conn.rollback()
        bot.send_message(user_id, "Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.", reply_markup=main_markup)

    finally:
        local_cursor.close()
        local_conn.close()
        logging.debug(f"Connection closed for user {user_id}")
# ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ú¯Ø±ÙØªÙ† ØªØ¹Ø¯Ø§Ø¯ Ø³Ú©Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
def get_user_coins(user_id):
    cursor.execute("SELECT coins FROM users WHERE user_id = ?", (user_id,))
    result = cursor.fetchone()
    return result[0] if result else 10  # 10 Ø³Ú©Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶


# ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ú©Ø³Ø± Ø³Ú©Ù‡
def deduct_coins(user_id, amount=1):
    cursor.execute("UPDATE users SET coins = coins - ? WHERE user_id = ?", (amount, user_id))
    conn.commit()


# ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾Ø§Ø±ØªÙ†Ø± Ø¨Ø§ Ø¬Ù†Ø³ÛŒØª Ø®Ø§Øµ
def search_partner(user_id, gender):
    start_time = time.time()
    local_cursor = conn.cursor()
    while time.time() - start_time < 120:  # Ø­Ø¯Ø§Ú©Ø«Ø± 2 Ø¯Ù‚ÛŒÙ‚Ù‡ ØµØ¨Ø±
        local_cursor.execute(
            """
            SELECT user_id FROM users 
            WHERE status = 'searching' AND user_id != ? AND gender = ?
            LIMIT 1
            """,
            (user_id, gender)
        )
        partner = local_cursor.fetchone()
        if partner:
            partner_id = partner[0]
            # Ø¢Ù¾Ø¯ÛŒØª ÙˆØ¶Ø¹ÛŒØª Ùˆ Ù¾Ø§Ø±ØªÙ†Ø± Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¯Ùˆ Ú©Ø§Ø±Ø¨Ø±
            local_cursor.execute("UPDATE users SET status = 'chatting', partner_id = ? WHERE user_id = ?",
                                 (partner_id, user_id))
            local_cursor.execute("UPDATE users SET status = 'chatting', partner_id = ? WHERE user_id = ?",
                                 (user_id, partner_id))
            # Ø«Ø¨Øª Ú†Øª Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡
            local_cursor.execute("INSERT INTO chat_history (user_id, partner_id) VALUES (?, ?)", (user_id, partner_id))
            local_cursor.execute("INSERT INTO chat_history (user_id, partner_id) VALUES (?, ?)", (partner_id, user_id))
            # Ø¢Ù¾Ø¯ÛŒØª last_online
            local_cursor.execute("UPDATE users SET last_online = ? WHERE user_id = ?",
                                 (datetime.now().strftime('%Y-%m-%d %H:%M:%S'), user_id))
            local_cursor.execute("UPDATE users SET last_online = ? WHERE user_id = ?",
                                 (datetime.now().strftime('%Y-%m-%d %H:%M:%S'), partner_id))
            conn.commit()
            # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
            local_cursor.execute("SELECT name, unique_id FROM users WHERE user_id = ?", (partner_id,))
            partner_name, partner_unique = local_cursor.fetchone()
            start_text_user = (
                f"Ú†Øª Ø¨Ø§ <b>{partner_name}</b> (/user_{partner_unique}) Ø´Ø±ÙˆØ¹ Ø´Ø¯! Ø¨Ù‡Ø´ Ø³Ù„Ø§Ù… Ú©Ù† :)\n"
                "ğŸ¤– Ù¾ÛŒØ§Ù… Ø³ÛŒØ³ØªÙ… ğŸ‘‡ğŸ»\n"
                "âš ï¸ Ø§Ø®Ø·Ø§Ø±: Ø¨Ù‡ Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¯Ø± Ø±Ø¨Ø§Øª Ø§Ø¹ØªÙ…Ø§Ø¯ Ù†Ú©Ù†ÛŒØ¯ Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®ØµÛŒØªØ§Ù† Ø±Ø§ Ø¯Ø± Ø§Ø®ØªÛŒØ§Ø± Ú©Ø³ÛŒ Ù‚Ø±Ø§Ø± Ù†Ø¯Ù‡ÛŒØ¯!"
            )
            bot.send_message(user_id, start_text_user, parse_mode="HTML", reply_markup=chat_markup)
            # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ù¾Ø§Ø±ØªÙ†Ø±
            local_cursor.execute("SELECT name, unique_id FROM users WHERE user_id = ?", (user_id,))
            user_name, user_unique = local_cursor.fetchone()
            start_text_partner = (
                f"Ú†Øª Ø¨Ø§ <b>{user_name}</b> (/user_{user_unique}) Ø´Ø±ÙˆØ¹ Ø´Ø¯! Ø¨Ù‡Ø´ Ø³Ù„Ø§Ù… Ú©Ù† :)\n"
                "ğŸ¤– Ù¾ÛŒØ§Ù… Ø³ÛŒØ³ØªÙ… ğŸ‘‡ğŸ»\n"
                "âš ï¸ Ø§Ø®Ø·Ø§Ø±: Ø¨Ù‡ Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¯Ø± Ø±Ø¨Ø§Øª Ø§Ø¹ØªÙ…Ø§Ø¯ Ù†Ú©Ù†ÛŒØ¯ Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®ØµÛŒØªØ§Ù† Ø±Ø§ Ø¯Ø± Ø§Ø®ØªÛŒØ§Ø± Ú©Ø³ÛŒ Ù‚Ø±Ø§Ø± Ù†Ø¯Ù‡ÛŒØ¯!"
            )
            bot.send_message(partner_id, start_text_partner, parse_mode="HTML", reply_markup=chat_markup)
            return
        time.sleep(5)


# Ú©Ø§Ù„â€ŒØ¨Ú© Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¯Ø®ØªØ±
@bot.callback_query_handler(func=lambda call: call.data == 'girl')
def start_girl_search(call):
    user_id = call.from_user.id
    update_last_online(user_id)

    # Ú†Ú© Ú©Ø±Ø¯Ù† ØªØ¹Ø¯Ø§Ø¯ Ø³Ú©Ù‡â€ŒÙ‡Ø§
    coins = get_user_coins(user_id)
    if coins < 1:
        text = (
            "âš ï¸ <b>ØªÙˆØ¬Ù‡: Ø´Ù…Ø§ Ø³Ú©Ù‡ Ú©Ø§ÙÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯!</b> (1 Ø³Ú©Ù‡ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²)\n"
            "ğŸ’¡ Ø¨Ø±Ø§ÛŒ Ø¨Ø¯Ø³Øª Ø¢ÙˆØ±Ø¯Ù† Ø³Ú©Ù‡ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø±Ø¨Ø§ØªÙˆ Ø¨Ù‡ Ø¯ÙˆØ³ØªØ§Øª Ù…Ø¹Ø±ÙÛŒ Ú©Ù†ÛŒ Ùˆ Ø¨Ù‡ Ø§Ø²Ø§ÛŒ Ù…Ø¹Ø±ÙÛŒ Ù‡Ø± Ù†ÙØ± <b>20 Ø³Ú©Ù‡</b> Ù‡Ø¯ÛŒÙ‡ Ø¨Ú¯ÛŒØ±ÛŒ.\n"
            "â—ï¸ Ø§Ú¯Ù‡ Ø¯ÙˆØ³ØªÛŒ Ù†Ø¯Ø§Ø±ÛŒ Ú©Ù‡ Ø¯Ø¹ÙˆØª Ú©Ù†ÛŒ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø§Ø² Ù¾Ù†Ù„ Ø®Ø±ÛŒØ¯ Ø³Ú©Ù‡ ğŸ’° Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒ Ùˆ Ø³Ú©Ù‡â€ŒÙ‡Ø§ØªÙˆ Ø§ÙØ²Ø§ÛŒØ´ Ø¨Ø¯ÛŒ."
        )
        markup = types.InlineKeyboardMarkup()
        markup.add(types.InlineKeyboardButton("ğŸ’° Ø§ÙØ²Ø§ÛŒØ´ Ø³Ú©Ù‡", callback_data="show_payment_options"))
        try:
            bot.edit_message_text(
                text,
                chat_id=user_id,
                message_id=call.message.message_id,
                parse_mode="HTML",
                reply_markup=markup
            )
        except telebot.apihelper.ApiTelegramException as e:
            print(f"Error editing message for user {user_id}: {e}")
            bot.send_message(user_id, text, parse_mode="HTML", reply_markup=markup)
        bot.answer_callback_query(call.id, "Ø³Ú©Ù‡ Ú©Ø§ÙÛŒ Ù†Ø¯Ø§Ø±ÛŒ!")
        return

    # Ú©Ø³Ø± ÛŒÚ© Ø³Ú©Ù‡
    deduct_coins(user_id)

    # Ø´Ø±ÙˆØ¹ Ø¬Ø³ØªØ¬Ùˆ
    cursor.execute("UPDATE users SET status = 'searching', partner_id = NULL WHERE user_id = ?", (user_id,))
    conn.commit()
    text = "ğŸ” Ø¯Ø±Ø­Ø§Ù„ Ø¬Ø³ØªØ¬ÙˆÛŒ ÛŒÙ‡ Ø¯Ø®ØªØ± Ù†Ø§Ø´Ù†Ø§Ø³\nğŸ² Ø¬Ø³ØªØ¬ÙˆÛŒ Ø´Ø§Ù†Ø³ÛŒ\nâ³ Ø­Ø¯Ø§Ú©Ø«Ø± ØªØ§ 2 Ø¯Ù‚ÛŒÙ‚Ù‡ ØµØ¨Ø± Ú©Ù†ÛŒØ¯."
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("Ù„ØºÙˆ Ø¬Ø³ØªØ¬Ùˆ", callback_data="cancel_search"))
    try:
        bot.edit_message_text(
            text,
            chat_id=user_id,
            message_id=call.message.message_id,
            reply_markup=markup
        )
    except telebot.apihelper.ApiTelegramException as e:
        print(f"Error editing message for user {user_id}: {e}")
        bot.send_message(user_id, text, reply_markup=markup)
    bot.answer_callback_query(call.id, "Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¯Ø®ØªØ± Ø´Ø±ÙˆØ¹ Ø´Ø¯!")
    threading.Thread(target=search_partner, args=(user_id, 'female')).start()


# Ú©Ø§Ù„â€ŒØ¨Ú© Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾Ø³Ø±
@bot.callback_query_handler(func=lambda call: call.data == 'boy')
def start_boy_search(call):
    user_id = call.from_user.id
    update_last_online(user_id)

    # Ú†Ú© Ú©Ø±Ø¯Ù† ØªØ¹Ø¯Ø§Ø¯ Ø³Ú©Ù‡â€ŒÙ‡Ø§
    coins = get_user_coins(user_id)
    if coins < 1:
        text = (
            "âš ï¸ <b>ØªÙˆØ¬Ù‡: Ø´Ù…Ø§ Ø³Ú©Ù‡ Ú©Ø§ÙÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯!</b> (1 Ø³Ú©Ù‡ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²)\n"
            "ğŸ’¡ Ø¨Ø±Ø§ÛŒ Ø¨Ø¯Ø³Øª Ø¢ÙˆØ±Ø¯Ù† Ø³Ú©Ù‡ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø±Ø¨Ø§ØªÙˆ Ø¨Ù‡ Ø¯ÙˆØ³ØªØ§Øª Ù…Ø¹Ø±ÙÛŒ Ú©Ù†ÛŒ Ùˆ Ø¨Ù‡ Ø§Ø²Ø§ÛŒ Ù…Ø¹Ø±ÙÛŒ Ù‡Ø± Ù†ÙØ± <b>20 Ø³Ú©Ù‡</b> Ù‡Ø¯ÛŒÙ‡ Ø¨Ú¯ÛŒØ±ÛŒ.\n"
            "â—ï¸ Ø§Ú¯Ù‡ Ø¯ÙˆØ³ØªÛŒ Ù†Ø¯Ø§Ø±ÛŒ Ú©Ù‡ Ø¯Ø¹ÙˆØª Ú©Ù†ÛŒ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø§Ø² Ù¾Ù†Ù„ Ø®Ø±ÛŒØ¯ Ø³Ú©Ù‡ ğŸ’° Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒ Ùˆ Ø³Ú©Ù‡â€ŒÙ‡Ø§ØªÙˆ Ø§ÙØ²Ø§ÛŒØ´ Ø¨Ø¯ÛŒ."
        )
        markup = types.InlineKeyboardMarkup()
        markup.add(types.InlineKeyboardButton("ğŸ’° Ø§ÙØ²Ø§ÛŒØ´ Ø³Ú©Ù‡", callback_data="show_payment_options"))
        try:
            bot.edit_message_text(
                text,
                chat_id=user_id,
                message_id=call.message.message_id,
                parse_mode="HTML",
                reply_markup=markup
            )
        except telebot.apihelper.ApiTelegramException as e:
            print(f"Error editing message for user {user_id}: {e}")
            bot.send_message(user_id, text, parse_mode="HTML", reply_markup=markup)
        bot.answer_callback_query(call.id, "Ø³Ú©Ù‡ Ú©Ø§ÙÛŒ Ù†Ø¯Ø§Ø±ÛŒ!")
        return

    # Ú©Ø³Ø± ÛŒÚ© Ø³Ú©Ù‡
    deduct_coins(user_id)

    # Ø´Ø±ÙˆØ¹ Ø¬Ø³ØªØ¬Ùˆ
    cursor.execute("UPDATE users SET status = 'searching', partner_id = NULL WHERE user_id = ?", (user_id,))
    conn.commit()
    text = "ğŸ” Ø¯Ø±Ø­Ø§Ù„ Ø¬Ø³ØªØ¬ÙˆÛŒ ÛŒÙ‡ Ù¾Ø³Ø± Ù†Ø§Ø´Ù†Ø§Ø³\nğŸ² Ø¬Ø³ØªØ¬ÙˆÛŒ Ø´Ø§Ù†Ø³ÛŒ\nâ³ Ø­Ø¯Ø§Ú©Ø«Ø± ØªØ§ 2 Ø¯Ù‚ÛŒÙ‚Ù‡ ØµØ¨Ø± Ú©Ù†ÛŒØ¯."
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("Ù„ØºÙˆ Ø¬Ø³ØªØ¬Ùˆ", callback_data="cancel_search"))
    try:
        bot.edit_message_text(
            text,
            chat_id=user_id,
            message_id=call.message.message_id,
            reply_markup=markup
        )
    except telebot.apihelper.ApiTelegramException as e:
        print(f"Error editing message for user {user_id}: {e}")
        bot.send_message(user_id, text, reply_markup=markup)
    bot.answer_callback_query(call.id, "Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾Ø³Ø± Ø´Ø±ÙˆØ¹ Ø´Ø¯!")
    threading.Thread(target=search_partner, args=(user_id, 'male')).start()


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ Ù„ØºÙˆ Ø¬Ø³ØªØ¬Ùˆ
@bot.callback_query_handler(func=lambda call: call.data == 'cancel_search')
def cancel_search(call):
    user_id = call.from_user.id
    update_last_online(user_id)
    cursor.execute("UPDATE users SET status = 'idle', partner_id = NULL WHERE user_id = ?", (user_id,))
    conn.commit()
    text = "Ø¬Ø³ØªØ¬Ùˆ Ù„ØºÙˆ Ø´Ø¯! ğŸ˜Š Ú†ÛŒ Ú©Ø§Ø± Ø¯ÛŒÚ¯Ù‡â€ŒØ§ÛŒ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø¨Ú©Ù†Ù…ØŸ"
    try:
        bot.edit_message_text(
            text,
            chat_id=user_id,
            message_id=call.message.message_id,
            parse_mode="HTML",
            reply_markup=main_markup
        )
    except telebot.apihelper.ApiTelegramException as e:
        print(f"Error editing message for user {user_id}: {e}")
        bot.send_message(user_id, text, parse_mode="HTML", reply_markup=main_markup)
    bot.answer_callback_query(call.id, "Ø¬Ø³ØªØ¬Ùˆ Ù„ØºÙˆ Ø´Ø¯!")


# Ú©Ø§Ù„â€ŒØ¨Ú© Ø¨Ø±Ø§ÛŒ Ù„ØºÙˆ Ø¬Ø³ØªØ¬Ùˆ
@bot.callback_query_handler(func=lambda call: call.data == 'cancel_search')
def cancel_search(call):
    user_id = call.from_user.id
    cursor.execute("UPDATE users SET status = 'idle' WHERE user_id = ?", (user_id,))
    conn.commit()
    bot.edit_message_text("Ø¬Ø³ØªØ¬Ùˆ Ù„ØºÙˆ Ø´Ø¯.", user_id, call.message.message_id)
    bot.send_message(user_id, "Ø®ÙˆØ´ Ø¨Ø±Ú¯Ø´ØªÛŒ!", reply_markup=main_markup)


# Ù„ÛŒØ³Øª Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ú†Øª
chat_commands = ["Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ø®Ø§Ø·Ø¨ ğŸ‘€", "ÙØ¹Ø§Ù„ Ø³Ø§Ø²ÛŒ Ú†Øª Ø®ØµÙˆØµÛŒ ğŸ”â€Œ", "Ù¾Ø§ÛŒØ§Ù† Ú†Øª âŒ"]


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ø®Ø§Ø·Ø¨
@bot.message_handler(func=lambda message: message.text == "Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ø®Ø§Ø·Ø¨ ğŸ‘€")
def view_partner_profile(message):
    user_id = message.from_user.id
    cursor.execute("SELECT status, partner_id FROM users WHERE user_id = ?", (user_id,))
    status, partner_id = cursor.fetchone()
    if status == 'chatting' and partner_id:
        cursor.execute(
            "SELECT name, gender, followers_count, following_count, province, city, age, likes_count, unique_id, profile_photo FROM users WHERE user_id = ?",
            (partner_id,))
        p_name, p_gender, p_followers, p_following, p_province, p_city, p_age, p_likes, p_unique, profile_photo = cursor.fetchone()
        p_gender_display = "Ù¾Ø³Ø± ğŸ‘¨â€ğŸ¦°" if p_gender == 'male' else "Ø¯Ø®ØªØ± ğŸ‘©"
        profile_text = f"""â€¢Ù†Ø§Ù…: {p_name} 
â€¢Ø¬Ù†Ø³ÛŒØª: {p_gender_display}
Ø¯Ù†Ø¨Ø§Ù„ Ú©Ù†Ù†Ø¯Ù‡ Ù‡Ø§: {p_followers}
Ø¯Ù†Ø¨Ø§Ù„ Ù…ÛŒÚ©Ù†Ø¯: {p_following}
â€¢Ø§Ø³ØªØ§Ù†: {p_province or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
â€¢Ø´Ù‡Ø±: {p_city or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
â€¢Ø³Ù†: {p_age or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
ğŸ†” : /user_{p_unique}
ØªØ¹Ø¯Ø§Ø¯ Ù„Ø§ÛŒÚ© Ù‡Ø§ : {p_likes}"""
        markup = get_partner_profile_inline_keyboard(user_id, partner_id)
        if profile_photo and isinstance(profile_photo, str) and len(profile_photo) > 0:
            try:
                bot.send_photo(user_id, profile_photo, caption=profile_text, reply_markup=markup)
            except telebot.apihelper.ApiTelegramException as e:
                print(f"Error sending partner profile photo for user {user_id}: {e} (file_id: {profile_photo})")
                bot.send_message(user_id, profile_text + "\nâš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„!", reply_markup=markup)
        else:
            bot.send_message(user_id, profile_text, reply_markup=markup)
        bot.send_message(partner_id,
                         "ğŸ¤– Ù¾ÛŒØ§Ù… Ø³ÛŒØ³ØªÙ… ğŸ‘‡\nğŸ—£ Ù…Ø®Ø§Ø·Ø¨Øª Â«Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù Ú†ØªÙˆÚ¯Ø±Ø§Ù…Ù Â» ØªÙˆ Ø±Ùˆ Ù†Ú¯Ø§Ù‡ Ú©Ø±Ø¯.\nâš ï¸ ØªÙˆØ¬Ù‡: Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú†ØªÙˆÚ¯Ø±Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§ØªÛŒ Ø§Ø³Øª Ú©Ù‡ Ø¯Ø± Ø¨Ø®Ø´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø±Ø¨Ø§Øª Ø«Ø¨Øª Ú©Ø±Ø¯Ù‡ Ø§ÛŒØ¯!")
    else:
        bot.send_message(user_id, "Ø´Ù…Ø§ Ø¯Ø± Ú†Øª Ù†ÛŒØ³ØªÛŒØ¯.")


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ Ù¾Ø§ÛŒØ§Ù† Ú†Øª
@bot.message_handler(func=lambda message: message.text == "Ù¾Ø§ÛŒØ§Ù† Ú†Øª âŒ")
def confirm_end_chat(message):
    user_id = message.from_user.id
    cursor.execute("SELECT status, partner_id FROM users WHERE user_id = ?", (user_id,))
    status, partner_id = cursor.fetchone()
    if status == 'chatting' and partner_id:
        cursor.execute("SELECT name, unique_id FROM users WHERE user_id = ?", (partner_id,))
        p_name, p_unique = cursor.fetchone()
        text = f"Ù…Ø·Ù…Ø¦Ù†ÛŒ Ú©Ù‡ Ù…ÛŒØ®ÙˆØ§ÛŒ Ú¯ÙØªÚ¯Ùˆ Ø±Ùˆ Ø¨Ø§ ({p_name}) /user_{p_unique} ØªÙ…ÙˆÙ… Ú©Ù†ÛŒ â‰ï¸"
        markup = types.InlineKeyboardMarkup()
        markup.add(
            types.InlineKeyboardButton("Ø¯Ø³ØªÙ… Ø®ÙˆØ±Ø¯ğŸ¤¦â€â™‚ï¸", callback_data='cancel_end'),
            types.InlineKeyboardButton("Ø§Ø±Ù‡ ØªÙ…ÙˆÙ…Ø´ Ú©Ù†âŒ", callback_data='confirm_end')
        )
        bot.send_message(user_id, text, reply_markup=markup)
    else:
        bot.send_message(user_id, "Ø´Ù…Ø§ Ø¯Ø± Ú†Øª Ù†ÛŒØ³ØªÛŒØ¯.")


# Ú©Ø§Ù„â€ŒØ¨Ú© Ø¨Ø±Ø§ÛŒ Ù„Ø§ÛŒÚ© Ú©Ø±Ø¯Ù† Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ø®Ø§Ø·Ø¨
@bot.callback_query_handler(func=lambda call: call.data == 'like_partner')
def like_partner(call):
    user_id = call.from_user.id
    cursor.execute("SELECT partner_id FROM users WHERE user_id = ?", (user_id,))
    partner_id = cursor.fetchone()[0]
    if not partner_id:
        bot.answer_callback_query(call.id, "Ø´Ù…Ø§ Ø¯Ø± Ú†Øª Ù†ÛŒØ³ØªÛŒØ¯!")
        return

    cursor.execute("SELECT COUNT(*) FROM likes WHERE user_id = ? AND target_id = ?", (user_id, partner_id))
    has_liked = cursor.fetchone()[0] > 0

    if has_liked:
        # Unlike
        cursor.execute("DELETE FROM likes WHERE user_id = ? AND target_id = ?", (user_id, partner_id))
        cursor.execute("UPDATE users SET likes_count = likes_count - 1 WHERE user_id = ?", (partner_id,))
        conn.commit()
        bot.answer_callback_query(call.id, "Ù„Ø§ÛŒÚ© Ø´Ù…Ø§ Ø¨Ø±Ø¯Ø§Ø´ØªÙ‡ Ø´Ø¯!")
    else:
        # Like
        try:
            cursor.execute("INSERT INTO likes (user_id, target_id) VALUES (?, ?)", (user_id, partner_id))
            cursor.execute("UPDATE users SET likes_count = likes_count + 1 WHERE user_id = ?", (partner_id,))
            conn.commit()
            bot.answer_callback_query(call.id, "Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù„Ø§ÛŒÚ© Ø´Ø¯!")
        except sqlite3.IntegrityError:
            bot.answer_callback_query(call.id, "Ø´Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ø§ÛŒÙ† Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø±Ø§ Ù„Ø§ÛŒÚ© Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯!")

    # Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ø®Ø§Ø·Ø¨
    cursor.execute(
        "SELECT name, gender, followers_count, following_count, province, city, age, likes_count, unique_id, profile_photo FROM users WHERE user_id = ?",
        (partner_id,))
    p_name, p_gender, p_followers, p_following, p_province, p_city, p_age, p_likes, p_unique, profile_photo = cursor.fetchone()
    p_gender_display = "Ù¾Ø³Ø± ğŸ‘¨â€ğŸ¦°" if p_gender == 'male' else "Ø¯Ø®ØªØ± ğŸ‘©"
    profile_text = f"""â€¢Ù†Ø§Ù…: {p_name} 
â€¢Ø¬Ù†Ø³ÛŒØª: {p_gender_display}
Ø¯Ù†Ø¨Ø§Ù„ Ú©Ù†Ù†Ø¯Ù‡ Ù‡Ø§: {p_followers}
Ø¯Ù†Ø¨Ø§Ù„ Ù…ÛŒÚ©Ù†Ø¯: {p_following}
â€¢Ø§Ø³ØªØ§Ù†: {p_province or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
â€¢Ø´Ù‡Ø±: {p_city or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
â€¢Ø³Ù†: {p_age or 'Ù†Ø§Ù…Ø´Ø®Øµ'}
ğŸ†” : /user_{p_unique}
ØªØ¹Ø¯Ø§Ø¯ Ù„Ø§ÛŒÚ© Ù‡Ø§ : {p_likes}"""
    markup = get_partner_profile_inline_keyboard(user_id, partner_id)
    try:
        if profile_photo and isinstance(profile_photo, str) and len(profile_photo) > 0:
            bot.edit_message_media(
                media=types.InputMediaPhoto(profile_photo, caption=profile_text),
                chat_id=user_id,
                message_id=call.message.message_id,
                reply_markup=markup
            )
        else:
            bot.edit_message_text(
                text=profile_text,
                chat_id=user_id,
                message_id=call.message.message_id,
                reply_markup=markup
            )
    except telebot.apihelper.ApiTelegramException as e:
        print(f"Error updating partner profile for user {user_id}: {e}")
        bot.answer_callback_query(call.id, "Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„!")


# Ú©Ø§Ù„â€ŒØ¨Ú© Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù„Ø§ÛŒÚ©â€ŒÚ©Ù†Ù†Ø¯Ú¯Ø§Ù†
@bot.callback_query_handler(func=lambda call: call.data == 'view_likers')
def view_likers(call):
    user_id = call.from_user.id
    cursor.execute(
        "SELECT u.name, u.unique_id FROM likes l JOIN users u ON l.user_id = u.user_id WHERE l.target_id = ?",
        (user_id,))
    likers = cursor.fetchall()

    if likers:
        likers_text = "ğŸ‘¥ Ú©Ø³Ø§Ù†ÛŒ Ú©Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø´Ù…Ø§ Ø±Ø§ Ù„Ø§ÛŒÚ© Ú©Ø±Ø¯Ù‡â€ŒØ§Ù†Ø¯:\n"
        for name, unique_id in likers:
            likers_text += f"â€¢ {name} (/user_{unique_id})\n"
    else:
        likers_text = "ğŸ˜• Ù‡Ù†ÙˆØ² Ú©Ø³ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø´Ù…Ø§ Ø±Ø§ Ù„Ø§ÛŒÚ© Ù†Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª!"

    bot.send_message(user_id, likers_text)


# Ú©Ø§Ù„â€ŒØ¨Ú© Ø¨Ø±Ø§ÛŒ ØªØ§ÛŒÛŒØ¯ Ù¾Ø§ÛŒØ§Ù†
@bot.callback_query_handler(func=lambda call: call.data in ['cancel_end', 'confirm_end'])
def handle_end_confirmation(call):
    user_id = call.from_user.id
    if call.data == 'cancel_end':
        bot.edit_message_text("Ú†Øª Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ø§Ø±Ù‡!", user_id, call.message.message_id)
        bot.send_message(user_id, "Ø¨Ø±Ú¯Ø´Øª Ø¨Ù‡ Ú†Øª.", reply_markup=chat_markup)
    elif call.data == 'confirm_end':
        cursor.execute("SELECT partner_id FROM users WHERE user_id = ?", (user_id,))
        partner_id = cursor.fetchone()[0]
        if partner_id:
            cursor.execute("SELECT name, unique_id FROM users WHERE user_id = ?", (partner_id,))
            p_name, p_unique = cursor.fetchone()
            cursor.execute("UPDATE users SET status = 'idle', partner_id = NULL WHERE user_id IN (?, ?)",
                           (user_id, partner_id))
            conn.commit()
            end_text_user = f"Ú†Øª Ø¨Ø§ ({p_name}) /user_{p_unique} Ø§Ø² Ø·Ø±Ù Ø®ÙˆØ¯Øª Ø¨Ø³ØªÙ‡ Ø´Ø¯.\nØ¨Ø±Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´ Ø¹Ø¯Ù… Ø±Ø¹Ø§ÛŒØª Ù‚ÙˆØ§Ù†ÛŒÙ† (/rules) Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø§ Ù„Ù…Ø³ ã€Š ğŸš« Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ø±Ø¨Ø± ã€‹ Ø¯Ø± Ù¾Ø±ÙˆÙØ§ÛŒÙ„ØŒ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ú¯Ø²Ø§Ø±Ø´ Ú©Ù†ÛŒØ¯."
            bot.send_message(user_id, end_text_user, reply_markup=main_markup)
            end_text_partner = f"Ú†Øª Ø¨Ø§ Ø·Ø±Ù Ù…Ù‚Ø§Ø¨Ù„ Ø§Ø² Ø·Ø±Ù Ú©Ø§Ø±Ø¨Ø± Ø¨Ø³ØªÙ‡ Ø´Ø¯.\nØ¨Ø±Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´ Ø¹Ø¯Ù… Ø±Ø¹Ø§ÛŒØª Ù‚ÙˆØ§Ù†ÛŒÙ† (/rules) Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø§ Ù„Ù…Ø³ ã€Š ğŸš« Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ø±Ø¨Ø± ã€‹ Ø¯Ø± Ù¾Ø±ÙˆÙØ§ÛŒÙ„ØŒ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ú¯Ø²Ø§Ø±Ø´ Ú©Ù†ÛŒØ¯."
            bot.send_message(partner_id, end_text_partner, reply_markup=main_markup)


# Ù‡Ù†Ø¯Ù„Ø± Ø¨Ø±Ø§ÛŒ "ÙØ¹Ø§Ù„ Ø³Ø§Ø²ÛŒ Ú†Øª Ø®ØµÙˆØµÛŒ ğŸ”â€Œ"
@bot.message_handler(func=lambda message: message.text == "ÙØ¹Ø§Ù„ Ø³Ø§Ø²ÛŒ Ú†Øª Ø®ØµÙˆØµÛŒ ğŸ”â€Œ")
def activate_private_chat(message):
    user_id = message.from_user.id
    bot.send_message(user_id, "Ú†Øª Ø®ØµÙˆØµÛŒ ÙØ¹Ø§Ù„ Ø´Ø¯! (Ø§ÛŒÙ† ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´Ù‡)")


# Ù‡Ù†Ø¯Ù„Ø± Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø¯Ø± Ú†Øª
@bot.message_handler(content_types=['text', 'photo', 'voice', 'video', 'document'])
def handle_chat_message(message):
    user_id = message.from_user.id
    update_last_online(user_id)  # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¢Ù¾Ø¯ÛŒØª Ø²Ù…Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†
    cursor.execute("SELECT status, partner_id FROM users WHERE user_id = ?", (user_id,))
    status, partner_id = cursor.fetchone()
    if status == 'chatting' and partner_id:
        if message.text and message.text in chat_commands:
            return
        if message.text:
            bot.send_message(partner_id, message.text)
        elif message.photo:
            bot.send_photo(partner_id, message.photo[-1].file_id, caption=message.caption)
        elif message.voice:
            bot.send_voice(partner_id, message.voice.file_id)
        elif message.video:
            bot.send_video(partner_id, message.video.file_id, caption=message.caption)
        elif message.document:
            bot.send_document(partner_id, message.document.file_id, caption=message.caption)
    else:
        pass


# Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª
if __name__ == '__main__':
    bot.polling()